<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>SylvanasSun Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="这里是SylvanasSun的个人博客,与你一起发现更大的世界。">
<meta property="og:type" content="website">
<meta property="og:title" content="SylvanasSun Blog">
<meta property="og:url" content="https://sylvanassun.github.io/page/3/index.html">
<meta property="og:site_name" content="SylvanasSun Blog">
<meta property="og:description" content="这里是SylvanasSun的个人博客,与你一起发现更大的世界。">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SylvanasSun Blog">
<meta name="twitter:description" content="这里是SylvanasSun的个人博客,与你一起发现更大的世界。">
  
    <link rel="alternate" href="/atom.xml" title="SylvanasSun Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">SylvanasSun Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">SylvanasSun的博客 | SylvanasSun Blog</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://sylvanassun.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2016-08-3-Spring-message" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/03/2016-08-3-Spring-message/" class="article-date">
  <time datetime="2016-08-03T10:00:00.000Z" itemprop="datePublished">2016-08-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/03/2016-08-3-Spring-message/">Spring Boot消息通信</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="SSL安全套接层"><a href="#SSL安全套接层" class="headerlink" title="SSL安全套接层"></a>SSL安全套接层</h3><hr>
<h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><hr>
<p>&nbsp;&nbsp;SSL(Secure Sockets Layer)是专门用于网络通信安全及数据完整性的安全协议,它会在网络传输层对网络连接进行加密.</p>
<p>&nbsp;&nbsp;SSL协议是位于TCP/IP协议与其他各种应用层协议之间的.</p>
<p>&nbsp;&nbsp;SSL的体系结构中包含两个协议子层:</p>
<ol>
<li><p>SSL记录协议(SSL Record Protocol),它建立在可靠的传输协议(TCP)之上,为高层协议提供数据封装、压缩、加密等基本功能的支持.SSL纪录协议针对HTTP协议进行了特别的设计，使得超文本的传输协议HTTP能够在SSL运行.</p>
</li>
<li><p>SSL握手协议(SSL Handshake Protocol),它建立在SSL记录协议之上.SSL握手协议层包括SSL握手协议（SSL HandShake Protocol）、SSL密码参数修改协议（SSL Change Cipher Spec Protocol）、应用数据协议（Application Data Protocol）和SSL告警协议（SSL Alert Protocol）.它主要用于在实际数据传输开始前,通信双方进行身份认证、协商加密算法、交换加密密钥等.</p>
<p>&nbsp;&nbsp;在B/S应用中,是通过<strong>HTTPS</strong>实现SSL的,<strong>HTTPS</strong>即是在HTTP下加入SSL层,它的安全基础是SSL.</p>
</li>
</ol>
<h4 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h4><hr>
<ol>
<li>客户端向服务器发送一个开始信息“Hello”以便开始一个新的会话连接.</li>
<li>服务器根据客户的信息确定是否需要生成新的主密钥，如需要则服务器在响应客户的“Hello”信息时将包含生成主密钥所需的信息.</li>
<li>客户根据收到的服务器响应信息，产生一个主密钥，并用服务器的公开密钥加密后传给服务器.</li>
<li>服务器回复该主密钥，并返回给客户一个用主密钥认证的信息，以此让客户认证服务器.</li>
</ol>
<h4 id="Spring-Boot中配置SSL"><a href="#Spring-Boot中配置SSL" class="headerlink" title="Spring Boot中配置SSL"></a>Spring Boot中配置SSL</h4><hr>
<p>&nbsp;&nbsp;在配置SSL之前需要生成一个证书,它可以是自签名的,也可以是从SSL证书授权中心获得的.</p>
<h5 id="生成SSL证书"><a href="#生成SSL证书" class="headerlink" title="生成SSL证书"></a>生成SSL证书</h5><p>&nbsp;&nbsp;可以在控制台中输入以下指令,生成自签名的SSL证书:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">keytool -genkey -alias tomcat</div></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;之后会在当前目录生成一个.keystore文件,它就是SSL证书文件.</p>
<h5 id="配置到项目中"><a href="#配置到项目中" class="headerlink" title="配置到项目中"></a>配置到项目中</h5><ol>
<li>将.keystore文件复制到src/main/resources/static下.</li>
<li>在application.properties中如下配置:<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">server.port = 8090</div><div class="line">server.ssl.key-store = .keystore</div><div class="line">server.ssl.key-store-password = 123456</div><div class="line">server.ssl.keyStoreType = JKS</div><div class="line">server.ssl.keyAlias : tomcat</div></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="http自动转向https"><a href="#http自动转向https" class="headerlink" title="http自动转向https"></a>http自动转向https</h4><hr>
<p>&nbsp;&nbsp;如果想要实现输入http自动转向到https,则需要配置<strong>TomcatEmbeddedServletContainerFactory</strong>,并添加Tomcat的connector来实现.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> cn.sun.sylvanas.spring_boot_security;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.catalina.Context;</div><div class="line"><span class="keyword">import</span> org.apache.catalina.connector.Connector;</div><div class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.SecurityCollection;</div><div class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.SecurityConstraint;</div><div class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</div><div class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</div><div class="line"><span class="keyword">import</span> org.springframework.boot.context.embedded.EmbeddedServletContainerFactory;</div><div class="line"><span class="keyword">import</span> org.springframework.boot.context.embedded.tomcat.TomcatEmbeddedServletContainerFactory;</div><div class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</div><div class="line"></div><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootSecurityApplication</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		SpringApplication.run(SpringBootSecurityApplication.class, args);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Bean</span></div><div class="line">	<span class="function"><span class="keyword">public</span> EmbeddedServletContainerFactory <span class="title">servletContainerFactory</span><span class="params">()</span> </span>&#123;</div><div class="line">		TomcatEmbeddedServletContainerFactory tomcat = <span class="keyword">new</span> TomcatEmbeddedServletContainerFactory()&#123;</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">postProcessContext</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">				SecurityConstraint securityConstraint = <span class="keyword">new</span> SecurityConstraint();</div><div class="line">				securityConstraint.setUserConstraint(<span class="string">"CONFIDENTIAL"</span>);</div><div class="line">				SecurityCollection securityCollection = <span class="keyword">new</span> SecurityCollection();</div><div class="line">				securityCollection.addPattern(<span class="string">"/"</span>);</div><div class="line">				securityConstraint.addCollection(securityCollection);</div><div class="line">				context.addConstraint(securityConstraint);</div><div class="line">			&#125;</div><div class="line">		&#125;;</div><div class="line">		tomcat.addAdditionalTomcatConnectors(httpConnector());</div><div class="line">		<span class="keyword">return</span> tomcat;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Bean</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Connector <span class="title">httpConnector</span><span class="params">()</span> </span>&#123;</div><div class="line">		Connector connector = <span class="keyword">new</span> Connector(<span class="string">"org.apache.coyote.http11.Http11NioProtocol"</span>);</div><div class="line">		connector.setScheme(<span class="string">"http"</span>);</div><div class="line">		connector.setPort(<span class="number">8080</span>);</div><div class="line">		connector.setSecure(<span class="keyword">false</span>);</div><div class="line">		connector.setRedirectPort(<span class="number">8090</span>);</div><div class="line">		<span class="keyword">return</span> connector;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;此时访问<a href="http://localhost:8080会自动转向到https://localhost:8090" target="_blank" rel="external">http://localhost:8080会自动转向到https://localhost:8090</a>.</p>
<h3 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h3><hr>
<h4 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h4><hr>
<p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f6mihqw3jpj20sg0dttc2.jpg" alt=""><br>&nbsp;&nbsp;WebSocket protocol 是HTML5一种新的协议.它实现了浏览器与服务器全双工异步通信(full-duplex).即浏览器可以向服务端发送消息,服务端也可以向浏览器发送消息.WebSocket需要浏览器的支持,如IE 10+、Chrome 13+、Firefox 6+.</p>
<p>&nbsp;&nbsp;WebSocket是通过一个socket来实现双工异步通信功能的.直接使用WebSocket协议开发程序会很繁琐,所以一般使用它的子协议<strong>STOMP</strong>,<strong>STOMP</strong>是一个更高级别的协议,它使用基于帧(frame)的格式来定义消息,具有一个类似<code>@RequestMapping</code>的<code>@MessageMapping</code>.</p>
<h4 id="Spring-Boot支持"><a href="#Spring-Boot支持" class="headerlink" title="Spring Boot支持"></a>Spring Boot支持</h4><hr>
<p>&nbsp;&nbsp;Spring Boot对内嵌的Tomcat(7、8)、Jetty9、Undertow提供了WebSocket支持.依赖为spring-boot-starter-websocket.</p>
<p>&nbsp;&nbsp;配置WebSocket需要在配置类上使用<code>@EnableWebSocketMessageBroker</code>注解开启支持,并且继承<strong>AbstractWebSocketMessageBrokerConfigurer</strong>类,重写其方法进行配置.</p>
<h4 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><hr>
<h5 id="广播"><a href="#广播" class="headerlink" title="广播"></a>广播</h5><p>&nbsp;&nbsp;广播即服务端有消息时,会将消息发送给所有连接了当前endpoint的浏览器.</p>
<ol>
<li><p>配置</p>
<p><img src="http://ww1.sinaimg.cn/mw690/63503acbjw1f6mihr9qtsj20om0ddadp.jpg" alt=""></p>
</li>
<li><p>Controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * <span class="doctag">@MessageMapping</span>注解映射/hello这个地址,类似于<span class="doctag">@RequestMapping</span></div><div class="line">  * 当服务端有消息时,会对订阅了<span class="doctag">@SendTo</span>中的路径的浏览器发送消息.</div><div class="line">  */</div><div class="line"> <span class="meta">@MessageMapping</span>(<span class="string">"/hello"</span>)</div><div class="line"> <span class="meta">@SendTo</span>(<span class="string">"/topic/getHello"</span>)</div><div class="line"> <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(String name)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">     Thread.sleep(<span class="number">3000</span>);</div><div class="line">     <span class="keyword">return</span> <span class="string">"Hello "</span> + name + <span class="string">"!"</span>;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li>js<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">  &lt;html xmlns:th=<span class="string">"http://www.thymeleaf.org"</span>&gt;</div><div class="line"></div><div class="line">&lt;head&gt;</div><div class="line">    &lt;meta content="text/html;charset=UTF-8"/&gt;</div><div class="line">    &lt;meta http-equiv="X-UA-Compatible" content="IE=edge"/&gt;</div><div class="line">    &lt;meta name="viewport" content="width=device-width,initial-scale=1"/&gt;</div><div class="line">    &lt;title&gt;Spring Boot+WebSocket+广播式&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body onload="disconnect()"&gt;</div><div class="line">&lt;noscript&gt;&lt;h2 style="color: #ff0000"&gt;貌似你的浏览器不支持websocket&lt;/h2&gt;&lt;/noscript&gt;</div><div class="line">&lt;div&gt;</div><div class="line">    &lt;div&gt;</div><div class="line">        &lt;button id="connect" onclick="connect();"&gt;连接&lt;/button&gt;</div><div class="line">        &lt;button id="disconnect" onclick="disconnect();"&gt;断开连接&lt;/button&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">    &lt;div id="conversationDiv"&gt;</div><div class="line">        &lt;label&gt;输入你的名字&lt;/label&gt;&lt;input type="text" id="name"/&gt;</div><div class="line">        &lt;button id="sendName" onclick="sendName();"&gt;发送&lt;/button&gt;</div><div class="line">        &lt;p id="response"&gt;&lt;/p&gt;</div><div class="line">    &lt;/div&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&lt;!-- 导入jQuery --&gt;</div><div class="line">&lt;script th:src="@&#123;jquery-3.1.0.min.js&#125;"/&gt;</div><div class="line">&lt;script th:src="@&#123;sockjs-1.0.0.min.js&#125;"/&gt;</div><div class="line">&lt;script th:src="@&#123;stomp.min.js&#125;"/&gt;</div><div class="line">&lt;script type="text/javascript"&gt;</div><div class="line">    var stompClient = null;</div><div class="line"></div><div class="line">    function setConnected(connected) &#123;</div><div class="line">        document.getElementById('connect').disabled = connected;</div><div class="line">        document.getElementById('disconnect').disabled = !connected;</div><div class="line">        document.getElementById('conversationDiv').style.visibility = connected ? 'visible' : 'hidden';</div><div class="line">        $('#response').html();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    function connect() &#123;</div><div class="line">        var socket = new SockJS('/endpointSun');</div><div class="line">        stompClient = Stomp.over(socket);</div><div class="line">        stompClient.connect(&#123;&#125;, function (frame) &#123;</div><div class="line">            setConnected(true);</div><div class="line">            console.log('Connected: ' + frame);</div><div class="line">            // 订阅/topic/getHello</div><div class="line">            stompClient.subscribe('/topic/getHello',function(response)&#123;</div><div class="line">                showResponse(JSON.parse(response.body).responseMessage);</div><div class="line">            &#125;);</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    function disconnect() &#123;</div><div class="line">        if(stompClient != null)&#123;</div><div class="line">            stompClient.disconnect();</div><div class="line">        &#125;</div><div class="line">        setConnected(false);</div><div class="line">        console.log("Disconnected");</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    function sendName() &#123;</div><div class="line">        var name = $('#name').val();</div><div class="line">        // 发送到/hello</div><div class="line">        stompClient.send("/hello",&#123;&#125;,JSON.stringify(&#123;'name':name&#125;));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    function showResponse(message)&#123;</div><div class="line">        var response = $("#response");</div><div class="line">        response.html(message);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&lt;/script&gt;</div><div class="line">&lt;/body&gt;</div><div class="line"></div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="P2P"><a href="#P2P" class="headerlink" title="P2P"></a>P2P</h5><p>&nbsp;&nbsp;P2P即点对点,它不同于广播式,P2P需要指定消息由谁接收,且只能由一个人接收.</p>
<ol>
<li><p>配置与广播式相同.</p>
</li>
<li><p>Controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">  * 通过SimpMessagingTemplate向浏览器发送消息.</div><div class="line">  */</div><div class="line"> <span class="meta">@Autowired</span></div><div class="line"> <span class="keyword">private</span> SimpMessagingTemplate messagingTemplate;</div><div class="line"></div><div class="line"> <span class="comment">/**</span></div><div class="line">  * Spring MVC可以直接在参数中注入principal对象,它包含当前用户的信息.</div><div class="line">  */</div><div class="line"> <span class="meta">@MessageMapping</span>(<span class="string">"/chat"</span>)</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleChat</span><span class="params">(Principal principal, String msg)</span> </span>&#123;</div><div class="line">     <span class="comment">/**</span></div><div class="line">      * 通过SimpMessagingTemplate.convertAndSendToUser向用户发送消息,</div><div class="line">      * 第一个参数是接收者的用户,第二参数是浏览器订阅的地址,第三个参数是要发送的消息.</div><div class="line">      */</div><div class="line">     <span class="keyword">if</span> (principal.getName().equals(<span class="string">"sun"</span>)) &#123;</div><div class="line">         messagingTemplate.convertAndSendToUser(<span class="string">"sylvanas"</span>,</div><div class="line">                 <span class="string">"/queue/notifications"</span>, principal.getName() + <span class="string">"-send:"</span> + msg);</div><div class="line">     &#125; <span class="keyword">else</span> &#123;</div><div class="line">         messagingTemplate.convertAndSendToUser(<span class="string">"sun"</span>,</div><div class="line">                 <span class="string">"/queue/notifications"</span>, principal.getName() + <span class="string">"-send:"</span> + msg);</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>js</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">  &lt;!DOCTYPE html&gt;</div><div class="line">&lt;!--suppress ALL --&gt;</div><div class="line">&lt;html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"</div><div class="line">      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3"&gt;</div><div class="line"></div><div class="line">&lt;head&gt;</div><div class="line">    &lt;meta content="text/html;charset=UTF-8"/&gt;</div><div class="line">    &lt;meta http-equiv="X-UA-Compatible" content="IE=edge"/&gt;</div><div class="line">    &lt;meta name="viewport" content="width=device-width,initial-scale=1"/&gt;</div><div class="line">    &lt;script th:src="@&#123;jquery-3.1.0.min.js&#125;"/&gt;</div><div class="line">    &lt;script th:src="@&#123;stomp.min.js&#125;"/&gt;</div><div class="line">    &lt;script th:src="@&#123;sockjs-1.0.0.min.js&#125;"/&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">&lt;p&gt;</div><div class="line">    聊天室</div><div class="line">&lt;/p&gt;</div><div class="line"></div><div class="line">&lt;form id="chatForm"&gt;</div><div class="line">    &lt;textarea rows="4" cols="60" name="text"&gt;&lt;/textarea&gt;</div><div class="line">    &lt;input type="submit"/&gt;</div><div class="line">&lt;/form&gt;</div><div class="line"></div><div class="line">&lt;script th:inline="javascript"&gt;</div><div class="line">    $('#chatForm').submit(function(e)&#123;</div><div class="line">        e.preventDefault();</div><div class="line">        var text = $('#chatForm').find('textarea[name="text"]').val();</div><div class="line">        sendSpittle(text);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    var socket = new SockJS("/endpointChat");</div><div class="line">    var stomp = Stomp.over(socket);</div><div class="line">    stomp.connect('guest','guest',function(frame)&#123;</div><div class="line">        // 与messagingTemplate.convertAndSendToUser中定义的订阅地址保持一致</div><div class="line">        // 但前面要多出一个/user,这个/user是必须的,只有使用了/user才会发送消息到指定的用户.</div><div class="line">        stomp.subscribe("/user/queue/notifications",handleNotification);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    function handleNotification(message)&#123;</div><div class="line">        $("#output").append("&lt;b&gt;Received: " + message.body + "&lt;/b&gt;&lt;br/&gt;");</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    function sendSpittle(text)&#123;</div><div class="line">        stomp.send("/chat",&#123;&#125;,text);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    $('#stop').click(function()&#123;socket.close()&#125;);</div><div class="line"></div><div class="line">&lt;/script&gt;</div><div class="line"></div><div class="line">&lt;div id="output"&gt;&lt;/div&gt;</div><div class="line"></div><div class="line">&lt;/body&gt;</div><div class="line"></div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="异步消息队列"><a href="#异步消息队列" class="headerlink" title="异步消息队列"></a>异步消息队列</h3><hr>
<p>&nbsp;&nbsp;异步消息队列主要用于各系统之间的通信与解耦,异步消息即为发送者无需关心消息接收者的处理和返回.</p>
<p>&nbsp;&nbsp;异步消息的主要概念为消息代理(message broker)和目的地(destination).消息是由消息代理负责接管并传递到指定目的地的.</p>
<p>&nbsp;&nbsp;目的地主要有2种:</p>
<ol>
<li>queue:用于P2P(point-to-point)的消息通信.</li>
<li>topic:用于发布/订阅(publish/subscribe)的消息通信.</li>
</ol>
<h4 id="Spring-Boot支持-1"><a href="#Spring-Boot支持-1" class="headerlink" title="Spring Boot支持"></a>Spring Boot支持</h4><hr>
<p>&nbsp;&nbsp;Spring对JMS和AMQP的支持来自于spring-jms、spring-rabbit.它们分别需要ConnectionFactory的实现来连接消息代理.并且提供了JmsTemplate和RabbitTemplate.</p>
<ul>
<li>JMS(Java Message Service)Java消息服务,它是基于JVM消息代理的规范.</li>
<li>AMQP(Advanced Message Queuing Protocol)高级消息队列协议,它不仅支持JVM,还支持跨语言和平台.AMQP的主要实现有RabbitMQ.</li>
</ul>
<p>&nbsp;&nbsp;Spring Boot对JMS支持的实有ActiveMQ,HornetQ,Artemis.以ActiveMQ为例:</p>
<ul>
<li>Spring Boot自动配置了ActiveMQConnectionFactory与JmsTemplate.</li>
<li>通过<code>spring.activemq</code>为前缀的属性来配置ActiveMQ相关的属性.</li>
<li>Spring Boot还自动开启了<code>@EnableJms</code>,即使用注解式消息监听的支持.</li>
</ul>
<p>&nbsp;&nbsp;Spring Boot对AMQP的实现RabbitMQ自动配置了如下内容:</p>
<ul>
<li>自动配置了ConnectionFactory和RabbitTemplate.</li>
<li>通过<code>spring.rabbitmq</code>为前缀的属性来配置RabbitMQ相关的属性.</li>
<li>自动开启了<code>@EnableRabbit</code>,即使用注解式消息监听的支持.</li>
</ul>
<h4 id="JMS-Example"><a href="#JMS-Example" class="headerlink" title="JMS Example"></a>JMS Example</h4><hr>
<p>&nbsp;&nbsp;添加依赖</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">      &lt;dependency&gt;</div><div class="line">	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">	&lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;</div><div class="line">&lt;/dependency&gt;</div><div class="line">&lt;dependency&gt;</div><div class="line">	&lt;groupId&gt;org.springframework&lt;/groupId&gt;</div><div class="line">	&lt;artifactId&gt;spring-jms&lt;/artifactId&gt;</div><div class="line">&lt;/dependency&gt;</div><div class="line">&lt;dependency&gt;</div><div class="line">	&lt;groupId&gt;org.apache.activemq&lt;/groupId&gt;</div><div class="line">	&lt;artifactId&gt;activemq-client&lt;/artifactId&gt;</div><div class="line">&lt;/dependency&gt;</div><div class="line"></div><div class="line">&lt;!-- 嵌入ActiveMQ --&gt;</div><div class="line">&lt;dependency&gt;</div><div class="line">	&lt;groupId&gt;org.apache.activemq&lt;/groupId&gt;</div><div class="line">	&lt;artifactId&gt;activemq-broker&lt;/artifactId&gt;</div><div class="line">&lt;/dependency&gt;</div><div class="line"></div><div class="line">&lt;dependency&gt;</div><div class="line">	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">	&lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</div><div class="line">	&lt;scope&gt;test&lt;/scope&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;在application.properties中配置activemq的地址.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">spring.activemq.broker-url=tcp://192.168.145.152:61616</div></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;定义JMS发送的消息需要实现MessageCreator接口.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Msg</span> <span class="keyword">implements</span> <span class="title">MessageCreator</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * 重写createMessage方法.</div><div class="line">     */</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Message <span class="title">createMessage</span><span class="params">(Session session)</span> <span class="keyword">throws</span> JMSException </span>&#123;</div><div class="line">        <span class="keyword">return</span> session.createTextMessage(<span class="string">"Hello World"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;发送消息,定义目的地.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Spring Boot提供了一个CommandLineRunner接口,用于程序启动后执行的代码</div><div class="line"> */</div><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"SpringJavaAutowiringInspection"</span>)</div><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootActivemqApplication</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</div><div class="line">	</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		SpringApplication.run(SpringBootActivemqApplication.class, args);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Autowired</span></div><div class="line">	<span class="keyword">private</span> JmsTemplate jmsTemplate;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... strings)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// 向目的地my-destination发送消息</span></div><div class="line">		jmsTemplate.send(<span class="string">"my-destination"</span>,<span class="keyword">new</span> Msg());</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;接收消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Receiver</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@JmsListener</span>是Spring 4.1提供的一个新特性,用来简化JMS开发.</div><div class="line">     * destination指定要监听的目的地.</div><div class="line">     */</div><div class="line">    <span class="meta">@JmsListener</span>(destination = <span class="string">"my-destination"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveMessage</span><span class="params">(String message)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"接收到: &lt;"</span> + message + <span class="string">"&gt;"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="AMQP-Example"><a href="#AMQP-Example" class="headerlink" title="AMQP Example"></a>AMQP Example</h4><hr>
<p>&nbsp;&nbsp;Spring Boot默认Rabbit主机位localhost,端口号为5672.</p>
<p>&nbsp;&nbsp;添加以下依赖:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">      &lt;dependency&gt;</div><div class="line">	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">	&lt;artifactId&gt;spring-boot-starter-amqp&lt;/artifactId&gt;</div><div class="line">&lt;/dependency&gt;</div><div class="line">&lt;dependency&gt;</div><div class="line">	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</div><div class="line">	&lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</div><div class="line">	&lt;scope&gt;test&lt;/scope&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;在application.properties中配置RabbitMQ的地址.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">spring.rabbitmq.host=192.168.145.152</div><div class="line">spring.rabbitmq.port=5672</div></pre></td></tr></table></figure></p>
<p>&nbsp;&nbsp;发送消息,定义目的地.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"SpringJavaAutowiringInspection"</span>)</div><div class="line"><span class="meta">@SpringBootApplication</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootRabbitmqApplication</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</div><div class="line">	</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		SpringApplication.run(SpringBootRabbitmqApplication.class, args);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Autowired</span></div><div class="line">	<span class="keyword">private</span> RabbitTemplate rabbitTemplate;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 定义目的地</div><div class="line">     */</div><div class="line">	<span class="meta">@Bean</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Queue <span class="title">myQueue</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Queue(<span class="string">"my-queue"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 使用rabbitTemplate的convertAndSend方法向队列my-queue发送消息.</div><div class="line">     */</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... strings)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		rabbitTemplate.convertAndSend(<span class="string">"my-queue"</span>,<span class="string">"Hello RabbitMQ!"</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;接收消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Component</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Receiver</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@RabbitListener</span>(queues = <span class="string">"my-queue"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveMessage</span><span class="params">(String message)</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"Received &lt;"</span> + message + <span class="string">"&gt;"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="end"><a href="#end" class="headerlink" title="end"></a>end</h3><blockquote>
<p>资料参考于 JavaEE开发的颠覆者: Spring Boot实战</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sylvanassun.github.io/2016/08/03/2016-08-3-Spring-message/" data-id="cj4z0jkbr0015uomjekdg3lpy" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/">Spring</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端开发/">后端开发</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016-08-2-Spring-security" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/02/2016-08-2-Spring-security/" class="article-date">
  <time datetime="2016-08-02T10:00:00.000Z" itemprop="datePublished">2016-08-02</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/02/2016-08-2-Spring-security/">Spring Security安全控制</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><hr>
<p>&nbsp;&nbsp;Spring Security是Spring项目的安全框架,基于IoC和AOP来实现安全的功能.</p>
<p>&nbsp;&nbsp;Spring Security有两个重要概念:</p>
<ul>
<li>认证(Authentication),认证即确认用户可以访问当前系统.</li>
<li>授权(Authorization),授权即确定用户在当前系统下所拥有的权限.</li>
</ul>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><hr>
<p>&nbsp;&nbsp;Spring Security使用过滤器来实现所有安全的功能,我们只需要注册一个特殊的<strong>DelegationFilterProxy</strong>过滤器到<strong>WebApplicationInitializer</strong>即可(WebApplicationInitializer是Spring提供用来配置Servlet3.0+配置的接口,从而替代web.xml,实现此接口的类会自动被SpringServletContainerInitializer加载,启动Servlet容器).</p>
<p>&nbsp;&nbsp;也可以让自定义的Initializer类继承<strong>AbstractSecurityWebApplicationInitializer</strong>抽象类,这个抽象类实现了WebApplicationInitializer接口,并通过onStartup方法调用.它已经注册了<strong>DelegationFilterProxy</strong>过滤器.</p>
<h4 id="Spring-Security配置类"><a href="#Spring-Security配置类" class="headerlink" title="Spring Security配置类"></a>Spring Security配置类</h4><hr>
<p>&nbsp;&nbsp;只需要在配置类上使用<code>@EnableWebSecurity</code>注解,然后继承<strong>WebSecurityConfigurerAdapter</strong>.可以通过重写configure方法来配置相关的内容.</p>
<p>&nbsp;&nbsp;在Spring Security中,通过重写以下方法放行静态资源:</p>
<p><img src="http://ww1.sinaimg.cn/mw690/63503acbjw1f6lgu4c6xxj20h404x0tn.jpg" alt=""></p>
<h4 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h4><hr>
<p>&nbsp;&nbsp;在Spring Security中,通过重写以下方法来完成认证的配置:</p>
<p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f6lft8zsnrj20mu01i3yx.jpg" alt=""></p>
<p>&nbsp;&nbsp;认证用户需要用户数据的来源,AuthenticationManagerBuilder提供了内存中和JDBC的两种用户数据来源.</p>
<ul>
<li><p>内存中</p>
<p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f6lft99qxaj20mj05fjsf.jpg" alt=""></p>
</li>
<li><p>JDBC</p>
<p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f6lft9j25zj20mo09b40j.jpg" alt=""></p>
</li>
</ul>
<p>&nbsp;&nbsp;如果需要自定义用户数据来源,则可以通过实现<strong>UserDetailsService</strong>接口.</p>
<p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f6lg2d5ezej20gn0cadhp.jpg" alt="Role实体类"></p>
<p><img src="http://ww4.sinaimg.cn/mw690/63503acbjw1f6lg2cv17nj20ls0g80wk.jpg" alt="User实体类"></p>
<p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f6lg2dfhjxj20qe0d7tcp.jpg" alt="自定义用户认证"></p>
<p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f6lg2dua5xj20md06s75u.jpg" alt="注册自定义的用户认证"></p>
<h4 id="Authorization"><a href="#Authorization" class="headerlink" title="Authorization"></a>Authorization</h4><hr>
<p>&nbsp;&nbsp;在Spring Security中,通过重写以下方法来完成授权的配置:</p>
<p><img src="http://ww4.sinaimg.cn/mw690/63503acbjw1f6lgfcr8g3j20hy01jt8z.jpg" alt=""></p>
<p>&nbsp;&nbsp;Spring Security使用2种匹配器用来匹配请求路径:</p>
<ul>
<li>antMatchers:使用Ant风格的路径匹配.</li>
<li>regexMatchers:使用正则表达式匹配路径.</li>
</ul>
<p>&nbsp;&nbsp;Spring Security提供以下方法用于安全处理:</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>anyRequest()</td>
<td>匹配所有请求路径.</td>
</tr>
<tr>
<td>access(String)</td>
<td>Spring EL表达式结果为true时可以访问.</td>
</tr>
<tr>
<td>anonymous()</td>
<td>匿名可访问.</td>
</tr>
<tr>
<td>denyAll()</td>
<td>用户不能访问.</td>
</tr>
<tr>
<td>fullyAuthenticated()</td>
<td>用户完全认证时可访问.</td>
</tr>
<tr>
<td>hasAnyAuthority(String…)</td>
<td>如果用户有参数,则其中任一权限可访问.</td>
</tr>
<tr>
<td>hasAnyRole(String…)</td>
<td>如果用户有参数,则其中任一角色可访问.</td>
</tr>
<tr>
<td>hasAuthority(String)</td>
<td>如果用户有参数,则其权限可访问.</td>
</tr>
<tr>
<td>hasIpAddress(String)</td>
<td>如果用户来自参数中的IP则可访问.</td>
</tr>
<tr>
<td>hasRole(String)</td>
<td>如果用户有参数中的角色可访问.</td>
</tr>
<tr>
<td>permitAll()</td>
<td>用户可任意访问.</td>
</tr>
<tr>
<td>rememberMe()</td>
<td>允许通过remember-me登陆的用户访问.</td>
</tr>
<tr>
<td>authenticated()</td>
<td>用户登录后可访问</td>
</tr>
</tbody>
</table>
<h3 id="自定义登录实现"><a href="#自定义登录实现" class="headerlink" title="自定义登录实现"></a>自定义登录实现</h3><hr>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">       http.authorizeRequests()</div><div class="line">               .anyRequest().authenticated() <span class="comment">// 所有请求需要认证登陆后才能访问.</span></div><div class="line">               .and()</div><div class="line">               .formLogin() <span class="comment">// 通过formLogin定制登录操作.</span></div><div class="line">                   .loginPage(<span class="string">"/login"</span>) <span class="comment">// 定制登录页面的访问地址.</span></div><div class="line">                   .defaultSuccessUrl(<span class="string">"/index"</span>) <span class="comment">// 登录成功后转向的页面.</span></div><div class="line">                   .failureUrl(<span class="string">"/login?error"</span>) <span class="comment">// 登录失败后转向的页面.</span></div><div class="line">                   .permitAll() </div><div class="line">               .and()</div><div class="line">               .rememberMe() <span class="comment">// 开启cookie存储用户信息.</span></div><div class="line">                   .tokenValiditySeconds(<span class="number">1209600</span>) <span class="comment">// 指定cookie的有效时间,单位为秒.</span></div><div class="line">                   .key(<span class="string">"userKey"</span>) <span class="comment">// 指定cookie中的私钥.</span></div><div class="line">               .and()</div><div class="line">               .logout() <span class="comment">// 通过logout()定制注销操作.</span></div><div class="line">                   .logoutUrl(<span class="string">"/logout"</span>) <span class="comment">// 指定注销的URL路径.</span></div><div class="line">                   .logoutSuccessUrl(<span class="string">"/index"</span>) <span class="comment">// 指定注销成功后转向的页面.</span></div><div class="line">               .permitAll();    </div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h3 id="Spring-Boot支持"><a href="#Spring-Boot支持" class="headerlink" title="Spring Boot支持"></a>Spring Boot支持</h3><hr>
<p>&nbsp;&nbsp;Spring Boot主要通过SecurityAutoConfiguration和SecurityProperties来完成自动配置.</p>
<p>&nbsp;&nbsp;SecurityAutoConfiguration导入了SpringBootWebSecurityConfiguration中的配置,我们可以获得如下的自动配置:</p>
<ol>
<li>自动配置了一个内存中的用户,账号为user,密码在程序启动时print在控制台中.</li>
<li>放行了<code>/css/**</code>,<code>/js/**</code>,<code>/images/**</code>,<code>/**/favicon.ico</code>等静态文件存放的路径.</li>
<li>自动配置的securityFilterChainRegistration的Bean.</li>
<li>使用以<code>security</code>为前缀的属性配置Security相关的配置.<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">security.user.name=#内存中的默认用户账号,默认为user.</div><div class="line">security.user.password=#默认用户的密码.</div><div class="line">security.user.role=#默认用户的角色.</div><div class="line">security.require-ssl=false #是否需要ssl支持,默认为false.</div><div class="line">security.enable-csrf=false #是否开启“跨站请求伪造”支持,默认false.</div><div class="line">security.ignored= #用逗号隔开需要放行的路径.</div><div class="line">....</div></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>当我们需要自定义扩展配置的时候,只需要配置类继承WebSecurityConfigurerAdapter即可,不需要使用<code>@EnableWebSecurity</code>注解开启支持.</strong>    </p>
<h3 id="end"><a href="#end" class="headerlink" title="end"></a>end</h3><blockquote>
<p>资料参考于 JavaEE开发的颠覆者: Spring Boot实战</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sylvanassun.github.io/2016/08/02/2016-08-2-Spring-security/" data-id="cj4z0jkbm000zuomjxugg6411" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/">Spring</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端开发/">后端开发</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016-08-1-Spring-data-transaction" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/08/01/2016-08-1-Spring-data-transaction/" class="article-date">
  <time datetime="2016-08-01T10:00:00.000Z" itemprop="datePublished">2016-08-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/08/01/2016-08-1-Spring-data-transaction/">Spring Data 事务&amp;缓存</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Spring-Transaction"><a href="#Spring-Transaction" class="headerlink" title="Spring Transaction"></a>Spring Transaction</h3><hr>
<p>&nbsp;&nbsp;Spring的事务机制是用统一的机制来处理不同数据访问计数的事务处理.它提供了一个<strong>PlatformTransactionManager</strong>接口,不同的数据访问技术使用不同的接口实现.</p>
<table>
<thead>
<tr>
<th>数据访问技术</th>
<th>接口实现</th>
</tr>
</thead>
<tbody>
<tr>
<td>JDBC</td>
<td>DataSourceTransactionManager</td>
</tr>
<tr>
<td>JPA</td>
<td>JpaTransactionManager</td>
</tr>
<tr>
<td>Hibernate</td>
<td>HibernateTransactionManager</td>
</tr>
<tr>
<td>JDO</td>
<td>JdoTransactionManager</td>
</tr>
<tr>
<td>分布式事务</td>
<td>JtaTransactionManager</td>
</tr>
</tbody>
</table>
<h4 id="声明式事务"><a href="#声明式事务" class="headerlink" title="声明式事务"></a>声明式事务</h4><hr>
<p>&nbsp;&nbsp;Spring使用<code>@Transactional</code>注解在方法上表明事务支持.被注解的方法在被调用时,会开启一个新的事务,当方法无异常完成提交后.Spring会提交事务.</p>
<p>&nbsp;&nbsp;<code>@Transactional</code>注解也可以用在类上,表明这个类下的所有方法都有事务支持.如果类和方法都使用了<code>@Transactional</code>,则使用方法上的注解覆盖类级别注解.</p>
<p>&nbsp;&nbsp;<code>@Transactional</code>注解是基于AOP的实现操作.</p>
<p>&nbsp;&nbsp;注意:<code>@Transactional</code>注解是由Spring提供的,而不是来自javax.transaction.</p>
<p>&nbsp;&nbsp;Spring提供<code>@EnableTransactionManagerment</code>注解在配置类上开启声明式事务,Spring容器会自动扫描带有注解<code>@Transactional</code>的类和方法.</p>
<h4 id="Spring-Data-JPA支持"><a href="#Spring-Data-JPA支持" class="headerlink" title="Spring Data JPA支持"></a>Spring Data JPA支持</h4><hr>
<p>&nbsp;&nbsp;Spring Data JPA对所有方法默认开启了事务支持,查询类事务默认启用readOnly-true属性.</p>
<h4 id="Spring-Boot支持"><a href="#Spring-Boot支持" class="headerlink" title="Spring Boot支持"></a>Spring Boot支持</h4><hr>
<p>&nbsp;&nbsp;Spring Boot会自动配置事务管理器.</p>
<ul>
<li>当使用JDBC时,Spring Boot会自动配置DataSourceTransactionManager.</li>
<li>当使用JPA时,Spring Boot会自动配置JpaTransactionManager.</li>
</ul>
<p>&nbsp;&nbsp;在Spring Boot中,不需要显式开启<code>@EnableTransactionManagement</code>注解.</p>
<h3 id="Spring-Cache"><a href="#Spring-Cache" class="headerlink" title="Spring Cache"></a>Spring Cache</h3><hr>
<p>&nbsp;&nbsp;Spring提供了CacheManager和Cache接口用来统一各种不同的数据缓存技术.</p>
<ul>
<li>CacheManager是各种缓存技术抽象接口.</li>
<li>Cache接口包含各种缓存操作.</li>
</ul>
<table>
<thead>
<tr>
<th>CacheManager</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>SimpleCacheManager</td>
<td>使用简单的Collection存储缓存,主要用于测试.</td>
</tr>
<tr>
<td>NoOpCacheManager</td>
<td>不会实际存储缓存.</td>
</tr>
<tr>
<td>EhCacheCacheManager</td>
<td>使用EhCache缓存技术.</td>
</tr>
<tr>
<td>ConcurrentMapCacheManager</td>
<td>使用ConcurrentMap存储缓存.</td>
</tr>
<tr>
<td>GuavaCacheManager</td>
<td>使用Google Guava的GuavaCache缓存技术.</td>
</tr>
<tr>
<td>HazelcastCacheManager</td>
<td>使用Hazelcast缓存技术.</td>
</tr>
<tr>
<td>JCacheCacheManager</td>
<td>支持JCache(JSR-107)规范的实现作为缓存技术.</td>
</tr>
<tr>
<td>RedisCacheManager</td>
<td>使用Redis作为缓存技术.</td>
</tr>
</tbody>
</table>
<p><strong>&nbsp;&nbsp;不管使用什么缓存技术,都需要注册一个该实现的CacheManager的Bean.</strong></p>
<h4 id="声明式缓存"><a href="#声明式缓存" class="headerlink" title="声明式缓存"></a>声明式缓存</h4><hr>
<p>&nbsp;&nbsp;Spring提供了以下注解用来声明式缓存.它与<code>@Transactional</code>注解一样是基于AOP操作的实现.</p>
<table>
<thead>
<tr>
<th>Annotation</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>@CachePut</td>
<td>不管什么情况,都会把方法的返回值存入缓存中.@CachePut的属性与@Cacheable保持一致.</td>
</tr>
<tr>
<td>@Cacheable</td>
<td>Spring会先查看缓存中是否存有数据,如果有,则直接返回缓存数据,如果没有,则将调用方法的返回值存入缓存中.</td>
</tr>
<tr>
<td>@Caching</td>
<td>可以通过@Caching注解组合多个注解策略在一个方法上.</td>
</tr>
<tr>
<td>@CacheEvict</td>
<td>将一条或多条缓存数据从缓存中删除.</td>
</tr>
</tbody>
</table>
<p><strong>&nbsp;&nbsp;开启声明式缓存需要在配置类上使用注解<code>@EnableCaching</code></strong></p>
<h4 id="Example"><a href="#Example" class="headerlink" title="Example"></a>Example</h4><hr>
<p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f6ldwfwuexj20ol0k5afd.jpg" alt=""></p>
<h4 id="Spring-Boot支持-1"><a href="#Spring-Boot支持-1" class="headerlink" title="Spring Boot支持"></a>Spring Boot支持</h4><hr>
<p>&nbsp;&nbsp;Spring Boot自动配置了CacheManager的各种实现,默认情况下使用的是ConcurrentMapCacheManager.支持以<code>spring.cache</code>为前缀的属性来配置缓存相关的配置.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">spring.cache.type= #缓存技术的类型,可选ehcache,guava,simple,none,generic,hazelcast,infinispan,jcache,redis.</div><div class="line">spring.cache.cache-name=#程序启动时创建缓存名称</div><div class="line">spring.cache.ehcache.config=#ehcache配置文件的地址.</div><div class="line">spring.cache.hazelcast.config=#hazelcast配置文件的地址.</div><div class="line">spring.cache.infinispan.config=#infinispan配置文件的地址.</div><div class="line">spring.cache.jcache.config=#jcache配置文件的地址.</div><div class="line">spring.cache.jcache.provider=#当多个jcache实现在类路径中的时候,指定jcache实现.</div><div class="line">spring.cache.guava.spec=# guava specs</div></pre></td></tr></table></figure>
<p><strong>&nbsp;&nbsp;使用Spring Boot只需要导入相关缓存技术的依赖,并在配置类使用<code>@EnableCaching</code>注解开启缓存支持即可.</strong></p>
<h3 id="end"><a href="#end" class="headerlink" title="end"></a>end</h3><blockquote>
<p>资料参考于 JavaEE开发的颠覆者: Spring Boot实战</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sylvanassun.github.io/2016/08/01/2016-08-1-Spring-data-transaction/" data-id="cj4z0jkbk000yuomj5gq3mujb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/">Spring</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端开发/">后端开发</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016-07-31-Spring-data" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/31/2016-07-31-Spring-data/" class="article-date">
  <time datetime="2016-07-31T10:00:00.000Z" itemprop="datePublished">2016-07-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/31/2016-07-31-Spring-data/">Spring数据访问方案-Spring Data</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>&nbsp;&nbsp;Spring Data是Spring用来解决数据访问的解决方案,它包含了大量关系型数据库以及NoSQL数据库的数据持久层访问解决方案.<br>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |</p>
<h4 id="Spring-Data-Commons"><a href="#Spring-Data-Commons" class="headerlink" title="Spring Data Commons"></a>Spring Data Commons</h4><p>&nbsp;&nbsp;Spring Data提供了统一的API来对各种数据存储技术进行数据访问操作,这是通过Spring Data Commons来实现的,它是所有Spring Data子项目的依赖.</p>
<h4 id="Spring-Data-Repository"><a href="#Spring-Data-Repository" class="headerlink" title="Spring Data Repository"></a>Spring Data Repository</h4><p>&nbsp;&nbsp;Spring Data Repository是数据访问的统一标准,它是抽象的,不同的数据访问技术有不同的Repository,它的顶级接口为Repository接口.</p>
<p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f6j3zxk8f5j20i104imxu.jpg" alt=""></p>
<p><strong>&nbsp;&nbsp;Repository用一个实体类型与ID类型作为泛型.</strong></p>
<p>&nbsp;&nbsp;Repository的子接口CrudRepository定义了CRUD操作的相关内容:</p>
<p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f6j45n3hnxj20q00hs0vq.jpg" alt=""></p>
<p>&nbsp;&nbsp;CrudRepository的子接口PagingAndSortingRepository定义了分页与排序的相关内容:</p>
<p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f6j45ne4tnj20ti07aabj.jpg" alt=""></p>
<h3 id="Spring-Data-JPA"><a href="#Spring-Data-JPA" class="headerlink" title="Spring Data JPA"></a>Spring Data JPA</h3><h4 id="JPA规范"><a href="#JPA规范" class="headerlink" title="JPA规范"></a>JPA规范</h4><hr>
<p>&nbsp;&nbsp;JPA是Java Persistence API的缩写,它是一个基于O/R(Object-Relational Mapping)映射的标准规范.例如Hibernate就是JPA规范的实现.</p>
<h4 id="数据访问层"><a href="#数据访问层" class="headerlink" title="数据访问层"></a>数据访问层</h4><hr>
<ol>
<li>在Spring Data JPA中定义数据访问层首先需要继承JpaRepository接口.</li>
<li>之后可以通过@EnableJpaRepository注解开启Spring Data JPA的支持,@EnableJpaRepository接收的value参数用于扫描数据访问层所在包下的接口定义.</li>
</ol>
<h4 id="查询方法"><a href="#查询方法" class="headerlink" title="查询方法"></a>查询方法</h4><hr>
<p>&nbsp;&nbsp;Spring Data JPA支持通过定义在Repository接口中的方法名来定义查询,方法名是根据实体类的属性名来确定的.</p>
<p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f6j94ghv86j20ma0bjtaw.jpg" alt=""></p>
<p>&nbsp;&nbsp;其中findBy关键字可以用find、read、readBy、query、queryBy、get、getBy替代.</p>
<p>&nbsp;&nbsp;Spring Data JPA可以使用top和first关键字查询指定数量的数据.</p>
<p><img src="http://ww1.sinaimg.cn/mw690/63503acbjw1f6j9asrv0sj20dq0543yx.jpg" alt=""></p>
<h4 id="查询关键字"><a href="#查询关键字" class="headerlink" title="查询关键字"></a>查询关键字</h4><hr>
<table>
<thead>
<tr>
<th>关键字</th>
<th>示例</th>
<th>同功能JPQL</th>
</tr>
</thead>
<tbody>
<tr>
<td>And</td>
<td>findByNameAndAge</td>
<td>where x.name = ?1 and x.age = ?2</td>
</tr>
<tr>
<td>Or</td>
<td>findByNameOrAge</td>
<td>where x.name = ?1 or x.age = ?2</td>
</tr>
<tr>
<td>Is</td>
<td>findByNameIs</td>
<td>where x.name = ?1</td>
</tr>
<tr>
<td>Equals</td>
<td>findByNameEquals</td>
<td>where x.name = ?1</td>
</tr>
<tr>
<td>Between</td>
<td>findByAgeBetween</td>
<td>where x.age between ?1 and ?2</td>
</tr>
<tr>
<td>LessThan</td>
<td>findByAgeLessThan</td>
<td>where x.age &lt; ?1</td>
</tr>
<tr>
<td>LessThanEqual</td>
<td>findByAgeLessThanEqual</td>
<td>where x.age &lt;= ?1</td>
</tr>
<tr>
<td>GreaterThan</td>
<td>findByAgeGreaterThan</td>
<td>where x.age &gt; ?1</td>
</tr>
<tr>
<td>GreaterThanEqual</td>
<td>findByAgeGreaterThanEqual</td>
<td>where x.age &gt;= ?1</td>
</tr>
<tr>
<td>After</td>
<td>findByStartDateAfter</td>
<td>where x.startDate &gt; ?1</td>
</tr>
<tr>
<td>Before</td>
<td>findByStartDateBefore</td>
<td>where x.startDate &lt; ?1</td>
</tr>
<tr>
<td>IsNull</td>
<td>findByNameIsNull</td>
<td>where x.name is null</td>
</tr>
<tr>
<td>IsNotNull&amp;NotNull</td>
<td>findByName(Is)NotNull</td>
<td>where x.name not null</td>
</tr>
<tr>
<td>Like</td>
<td>findByNameLike</td>
<td>where x.name like ?1</td>
</tr>
<tr>
<td>NotLike</td>
<td>findByNameNotLike</td>
<td>where x.name not like ?1</td>
</tr>
<tr>
<td>StartingWith</td>
<td>findByNameStartingWith</td>
<td>where x.name like ?1(参数前面加%)</td>
</tr>
<tr>
<td>EndingWith</td>
<td>findByNameEndingWith</td>
<td>where x.name like ?1(参数后面加%)</td>
</tr>
<tr>
<td>Containing</td>
<td>findByNameContaining</td>
<td>where x.name like ?1(参数前后都加%)</td>
</tr>
<tr>
<td>OrderBy</td>
<td>findByNameOrderByAgeDesc</td>
<td>where x.name = ?1 order by x.age desc</td>
</tr>
<tr>
<td>Not</td>
<td>findByNameNot</td>
<td>where x.name &lt;&gt; ?1</td>
</tr>
<tr>
<td>In</td>
<td>findByAgeIn(Collection<age> age)</age></td>
<td>where x.age in ?1</td>
</tr>
<tr>
<td>NotIn</td>
<td>findByAgeNotIn(Collection<age> age)</age></td>
<td>where x.age not in ?1</td>
</tr>
<tr>
<td>True</td>
<td>findByActiveTrue()</td>
<td>where x.active = true</td>
</tr>
<tr>
<td>False</td>
<td>findByActiveFalse()</td>
<td>where x.active = false</td>
</tr>
<tr>
<td>IgnoreCase</td>
<td>findByNameIgnoreCase</td>
<td>where UPPER(x.name) = UPPER(?1)</td>
</tr>
</tbody>
</table>
<h4 id="Query-amp-NamedQuery查询"><a href="#Query-amp-NamedQuery查询" class="headerlink" title="@Query&amp;@NamedQuery查询"></a>@Query&amp;@NamedQuery查询</h4><hr>
<p>&nbsp;&nbsp;Spring Data JPA支持使用@Query注解在接口的方法上实现查询.</p>
<p><img src="http://ww1.sinaimg.cn/mw690/63503acbjw1f6jatc82fnj20rf06375q.jpg" alt=""></p>
<p>&nbsp;&nbsp;Spring Data JPA支持使用@NamedQuery定义查询方法,一个名称映射一条查询语句.</p>
<p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f6jatcdurzj20kq02uaar.jpg" alt=""></p>
<p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f6jatcnebfj20jn05k0tl.jpg" alt=""></p>
<h4 id="更新查询"><a href="#更新查询" class="headerlink" title="更新查询"></a>更新查询</h4><hr>
<p>&nbsp;&nbsp;Spring Data JPA支持使用@Modifying注解和@Query注解组合进行数据更新操作.</p>
<p><img src="http://ww4.sinaimg.cn/mw690/63503acbjw1f6jthq9ojpj20do05fgml.jpg" alt=""></p>
<h4 id="Specification"><a href="#Specification" class="headerlink" title="Specification"></a>Specification</h4><hr>
<p>&nbsp;&nbsp;Spring Data JPA提供了一个Specification接口可以让我们快速地构造基于准则的查询.通过重写Specification接口的toPredicate方法用来构造查询条件.</p>
<ol>
<li>数据访问接口需继承JpaSpecificationExecutor接口.</li>
<li><p>构造查询条件类</p>
<p><img src="http://ww1.sinaimg.cn/mw690/63503acbjw1f6judons88j20pz0cugoi.jpg" alt=""></p>
</li>
<li><p>调用条件查询</p>
<p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f6judoyj61j20go031q3d.jpg" alt=""></p>
</li>
</ol>
<h4 id="排序-amp-分页"><a href="#排序-amp-分页" class="headerlink" title="排序&amp;分页"></a>排序&amp;分页</h4><hr>
<p>&nbsp;&nbsp;Spring Data JPA提供了Sort类和Page接口及Pageable接口完成排序和分页.</p>
<p><img src="http://ww4.sinaimg.cn/mw690/63503acbjw1f6julp4p8mj20ph0c40v9.jpg" alt=""></p>
<h4 id="自定义Repository"><a href="#自定义Repository" class="headerlink" title="自定义Repository"></a>自定义Repository</h4><hr>
<p>&nbsp;&nbsp;如果我们想自定义Repository,可以继承Repository的子接口PagingAndSortingRepository.</p>
<ul>
<li><p>定义自定义的Repository接口.</p>
<p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f6jv8nwlvej20j006n0tw.jpg" alt=""></p>
</li>
<li><p>定义自定义的Repository接口实现.</p>
<p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f6jv8o9wlrj20qp0dyn0m.jpg" alt=""></p>
</li>
<li><p>定义RepositoryFactoryBean</p>
<p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f6jv8oxqiwj20t00nxgsx.jpg" alt=""></p>
</li>
<li><p>开启自定义支持需要使用@EnableJpaRepositories注解的repositoryFactoryBeanClass指定FactoryBean.</p>
</li>
</ul>
<h4 id="Spring-Boot支持"><a href="#Spring-Boot支持" class="headerlink" title="Spring Boot支持"></a>Spring Boot支持</h4><hr>
<ul>
<li><p>Spring Boot使用<code>spring.datasource</code>前缀用来配置dataSource.</p>
</li>
<li><p>Spring Boot自动开启了注解事务支持(@EnableTransactionManagement),并配置了jdbcTemplate.</p>
</li>
<li><p>Spring Boot提供了初始化数据的功能,在类路径下的schema.sql文件会自动初始化表结构;在类路径下的data.sql文件会自动插入表数据.</p>
</li>
<li><p>Spring Boot为我们自动配置了transactionManager、jpaVendorAdapter、entityManagerFactory等Bean.JpaBaseConfiguration还有一个getPackagesToScan方法用于自动扫描带有注解@Entity的实体类</p>
</li>
<li><p>Spring Boot自动配置了OpenEntityManagerInViewInterceptor拦截器,并注册到了Spring MVC的拦截器中.解决了页面访问数据时会话连接已关闭的错误.</p>
</li>
<li><p>Spring Boot自动开启了对Spring Data JPA的支持,无需再配置类中显式声明@EnableJpaRepositories.</p>
</li>
</ul>
<p>&nbsp;&nbsp;在Spring Boot下使用Spring Data JPA,只需要添加依赖spring-boot-stater-data-jpa,然后定义DataSource、实体类、数据访问层即可,无需其他配置.</p>
<h3 id="Spring-Data-REST"><a href="#Spring-Data-REST" class="headerlink" title="Spring Data REST"></a>Spring Data REST</h3><hr>
<p>&nbsp;&nbsp;Spring Data REST支持将Spring Data JPA,Spring Data MongoDB,Spring Data Neo4j,Spring Data GernFile,Spring Data Cassandra的Repository自动转换成REST服务.</p>
<p>&nbsp;&nbsp;Spring Data REST的配置是定义在<strong>RepositoryRestMvcConfiguration</strong>配置类中的,我们可以通过继承这个配置类或者使用@Import注解导入此配置类来使用Spring Data REST.</p>
<h4 id="Spring-Boot支持-1"><a href="#Spring-Boot支持-1" class="headerlink" title="Spring Boot支持"></a>Spring Boot支持</h4><hr>
<p>&nbsp;&nbsp;Spring Boot已经自动配置了<strong>RepositoryRestMvcConfiguration</strong>,所以只需要引入依赖spring-boot-starter-data-rest,不需要任何其他配置.</p>
<ul>
<li><p>Spring Boot使用<code>spring.data.rest</code>前缀用来配置<strong>RepositoryRestMvcConfiguration</strong>的属性.</p>
</li>
<li><p>如果想在自定义的领域类Repository中将方法暴露为REST资源,则需要使用@RestResource注解.<br><img src="http://ww1.sinaimg.cn/mw690/63503acbjw1f6l1pub41ej20hw01ydga.jpg" alt="http://localhost:8080/persons/search/nameStartsWith?name=xx访问此REST资源."></p>
</li>
<li><p>如需要分页,则可以使用参数page=?&amp;size=?来实现分页.<br>例:<a href="http://localhost:8080/persons/?page=1&amp;size=10" target="_blank" rel="external">http://localhost:8080/persons/?page=1&amp;size=10</a>.</p>
</li>
<li><p>如需要排序,则可以使用参数sort来实现排序.<br>例:<a href="http://localhost:8080/persons/?sort=age,desc" target="_blank" rel="external">http://localhost:8080/persons/?sort=age,desc</a>.</p>
</li>
<li><p>自定义根路径需要在application.properties中设置<code>spring.data.rest.base-path</code>属性.</p>
</li>
<li><p>Spring Data REST的节点路径是默认在实体类之后加s,如果需要自定义节点路径则要在领域类Repository上使用<strong>@RepositoryRestResource</strong>注解的path属性进行设置.</p>
</li>
</ul>
<h3 id="Spring-Data-MongoDB"><a href="#Spring-Data-MongoDB" class="headerlink" title="Spring Data MongoDB"></a>Spring Data MongoDB</h3><hr>
<p>&nbsp;&nbsp;MongoDB是一个基于Document文档的NoSQL数据库,它使用面向对象的思想,每一条记录都是一个文档对象.</p>
<p>&nbsp;&nbsp;Spring Data MongoDB提供了以下的注解用来定义领域类:</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>@Document</td>
<td>映射领域对象与MongoDB的一个文档</td>
</tr>
<tr>
<td>@Id</td>
<td>映射当前属性为ID</td>
</tr>
<tr>
<td>@DbRef</td>
<td>当前属性将参考其他文档</td>
</tr>
<tr>
<td>@Field</td>
<td>为文档的属性定义名称</td>
</tr>
<tr>
<td>@Version</td>
<td>将当前属性作为版本</td>
</tr>
</tbody>
</table>
<p>&nbsp;&nbsp;Spring Data MongoDB还提供了一个MongoTemplate封装了数据访问的方法,我们还需要为MongoClient和MongoDbFactory来配置数据库连接属性.开启MongoDB的Repository需要在配置类上使用注解@EnableMongoRepositories.</p>
<p><img src="http://ww4.sinaimg.cn/mw690/63503acbjw1f6l41qx7pbj20qa0am775.jpg" alt=""></p>
<p>&nbsp;&nbsp;定义Spring Data MongoDB的Repository只需要继承MongoRepository接口即可.</p>
<h4 id="Spring-Boot支持-2"><a href="#Spring-Boot支持-2" class="headerlink" title="Spring Boot支持"></a>Spring Boot支持</h4><hr>
<p>&nbsp;&nbsp;使用Spirng Boot主要配置数据库连接、MongoTemplate.可以使用<code>spring.data.mongodb</code>配置MongoDB相关的属性.</p>
<ul>
<li>Spring Boot自动开启了@EnableMongoRepositories注解.</li>
<li>Spring Boot提供了一些默认配置:默认MongoDB端口为27017,服务器为localhost,数据库为test.</li>
<li>在Spring Boot下使用MongoDB只需要引入依赖spring-boot-starter-data-mongodb,不需要其他配置.</li>
</ul>
<h3 id="Spring-Data-Redis"><a href="#Spring-Data-Redis" class="headerlink" title="Spring Data Redis"></a>Spring Data Redis</h3><hr>
<p>&nbsp;&nbsp;Spring Data Redis提供了ConnectionFactory和RedisTemplate.</p>
<ul>
<li><p>根据Redis不同的JavaClient,Spring Data Redis提供了不同的ConnectionFactory.</p>
<ul>
<li>JedisConnectionFactory:使用Jedis作为客户端.</li>
<li>JredisConnectionFactory:使用Jredis作为客户端.</li>
<li>LettuceConnectionFactory:使用Lettuce作为客户端.</li>
<li>SrpConnectionFactory:使用Spullara/redis-protoccol作为客户端.</li>
</ul>
</li>
<li><p>配置ConnectionFactory和RedisTemplate如下:<br><img src="http://ww1.sinaimg.cn/mw690/63503acbjw1f6l51jk3k8j20m707iwgh.jpg" alt=""></p>
</li>
</ul>
<p>&nbsp;&nbsp;Spring Data Redis提供了RedisTemplate和StringRedisTemplate两个模板对象进行数据操作.StringRedisTemplate只针对键值都是字符类型的数据进行操作.</p>
<table>
<thead>
<tr>
<th>数据操作方法</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>opsForValue()</td>
<td>操作简单属性的数据</td>
</tr>
<tr>
<td>opsForList()</td>
<td>操作list数据</td>
</tr>
<tr>
<td>opsForSet()</td>
<td>操作set数据</td>
</tr>
<tr>
<td>opsForZSet()</td>
<td>操作ZSet(有序的set)数据</td>
</tr>
<tr>
<td>opsForHash()</td>
<td>操作hash散列的数据</td>
</tr>
</tbody>
</table>
<h4 id="Serializer"><a href="#Serializer" class="headerlink" title="Serializer"></a>Serializer</h4><hr>
<p>&nbsp;&nbsp;当我们进行存储操作的时候,键值对都是通过Spring提供的Serializer序列化到数据库的.</p>
<ul>
<li>RedisTemplate默认使用的是JdkSerializationRedisSerizlizer.</li>
<li>StringRedisTemplate默认使用的是StringRedisSerializer.</li>
</ul>
<h4 id="Spring-Boot支持-3"><a href="#Spring-Boot支持-3" class="headerlink" title="Spring Boot支持"></a>Spring Boot支持</h4><hr>
<p>&nbsp;&nbsp;Spring Boot默认配置了JedisConnectionFactory、RedisTemplate和StringRedisTemplate.</p>
<p>&nbsp;&nbsp;Spring Boot使用<code>spring.redis</code>为前缀在application.properties中配置Redis相关的属性.</p>
<p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f6l5oypp5fj20j90fxwhx.jpg" alt=""></p>
<h3 id="end"><a href="#end" class="headerlink" title="end"></a>end</h3><blockquote>
<p>资料参考于 JavaEE开发的颠覆者: Spring Boot实战</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sylvanassun.github.io/2016/07/31/2016-07-31-Spring-data/" data-id="cj4z0jkbj000wuomjm0ocl7ap" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/">Spring</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端开发/">后端开发</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016-07-29-Spring-boot-autoconfigure" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/29/2016-07-29-Spring-boot-autoconfigure/" class="article-date">
  <time datetime="2016-07-29T10:00:00.000Z" itemprop="datePublished">2016-07-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/29/2016-07-29-Spring-boot-autoconfigure/">浅谈Spring Boot自动配置的运作原理</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Spring-Boot"><a href="#Spring-Boot" class="headerlink" title="Spring Boot"></a>Spring Boot</h3><p>&nbsp;&nbsp;Spring Boot是由Pivotal团队提供的全新框架，其设计目的是用来简化新Spring应用的初始搭建以及开发过程。它使用“习惯优于配置”的理念可以让你的项目快速运行部署。使用Spring Boot可以不用或者只需要很少的Spring配置。</p>
<p>&nbsp;&nbsp;而Spring Boot核心的功能就是自动配置。它会根据在类路径中的jar、类自动配置Bean,当我们需要配置的Bean没有被Spring Boot提供支持时,也可以自定义自动配置。</p>
<h3 id="自动配置的运作原理"><a href="#自动配置的运作原理" class="headerlink" title="自动配置的运作原理"></a>自动配置的运作原理</h3><p><strong>&nbsp;&nbsp;Spring Boot自动配置其实是基于Spring 4.x提供的条件配置(Conditional)实现的。</strong></p>
<p>&nbsp;&nbsp;有关自动配置的源码在spring-boot-autoconfigure-1.x.x.jar内,如下图:</p>
<p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f6b6vnzlfgj20co0kimyz.jpg" alt=""></p>
<h4 id="如何查看当前项目已启动和未启动的自动配置"><a href="#如何查看当前项目已启动和未启动的自动配置" class="headerlink" title="如何查看当前项目已启动和未启动的自动配置"></a>如何查看当前项目已启动和未启动的自动配置</h4><ol>
<li>在application.propertie中设置debug=true属性.</li>
<li>在运行jar时添加–debug指令.</li>
</ol>
<p>&nbsp;&nbsp;当使用以上两种任意一种方法后,启动项目会在控制台输出已启动和未启动的自动配置日志.</p>
<h4 id="SpringBootApplication"><a href="#SpringBootApplication" class="headerlink" title="@SpringBootApplication"></a>@SpringBootApplication</h4><p>&nbsp;&nbsp;生成Spring Boot项目时,会自动生成一个入口类.入口类使用了@SpringBootApplication注解,它是Spring Boot的核心注解,它是一个组合注解,核心功能由@EnableAutoConfiguration注解提供.</p>
<p><img src="http://ww1.sinaimg.cn/mw690/63503acbjw1f6b772ib2sj20he0ft77h.jpg" alt="@SpringBootApplication"></p>
<h4 id="EnableAutoConfiguration"><a href="#EnableAutoConfiguration" class="headerlink" title="@EnableAutoConfiguration"></a>@EnableAutoConfiguration</h4><p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f6b772m676j20gq07qdhi.jpg" alt="@EnableAutoConfiguration"></p>
<ol>
<li>@Import注解提供导入配置的功能,它导入了EnableAutoConfigurationImportSelector.</li>
<li>EnableAutoConfigurationImportSelector使用函数SpringFactoriesLoader.loadFactoryNames扫描META-INF/spring.factories文件中声明的jar包.</li>
</ol>
<p><img src="http://ww1.sinaimg.cn/mw690/63503acbjw1f6b7h23prdj213c0kh7g2.jpg" alt=""></p>
<ol>
<li>spring.factories文件在spring-boot-autoconfigure-1.x.x.jar中.</li>
</ol>
<p><img src="http://ww4.sinaimg.cn/mw690/63503acbjw1f6b7lru822j20ei05ggmu.jpg" alt=""></p>
<p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f6b7lryzw2j20ut0ntaok.jpg" alt=""></p>
<ol>
<li>spring.factories中声明的类基本上都使用了@Conditional注解.</li>
</ol>
<h4 id="Conditional"><a href="#Conditional" class="headerlink" title="Conditional"></a>Conditional</h4><p>&nbsp;&nbsp;Spring Boot在org.springframework.boot.autoconfigure.condition包下定义了以下注解.</p>
<table>
<thead>
<tr>
<th>注解名</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>@ConditionalOnJava</td>
<td>基于JVM版本作为判断条件.</td>
</tr>
<tr>
<td>@ConditionalOnBean</td>
<td>当容器中有指定的Bean的条件下.</td>
</tr>
<tr>
<td>@ConditionalOnClass</td>
<td>当类路径下游指定的类的条件下.</td>
</tr>
<tr>
<td>@ConditionalOnExpression</td>
<td>基于SpEL表达式作为判断条件.</td>
</tr>
<tr>
<td>@ConditionalOnJndi</td>
<td>在JNDI存在的条件下查找指定的位置.</td>
</tr>
<tr>
<td>@ConditionalOnMissingBean</td>
<td>当容器中没有指定Bean的情况下.</td>
</tr>
<tr>
<td>@ConditionalOnMissingClass</td>
<td>当类路径下没有指定的类的情况下.</td>
</tr>
<tr>
<td>@ConditionalOnNotWebApplication</td>
<td>当前项目不是web项目的条件下.</td>
</tr>
<tr>
<td>@ConditionalOnProperty</td>
<td>指定的属性是否有指定的值.</td>
</tr>
<tr>
<td>@ConditionalOnResource</td>
<td>类路径是否有指定的值.</td>
</tr>
<tr>
<td>@ConditionalOnSingleCandidate</td>
<td>当指定Bean在容器中只有一个,或者虽然有多个但是指定首选的Bean.</td>
</tr>
<tr>
<td>@ConditionalOnWebApplication</td>
<td>当前项目是web项目的条件下.</td>
</tr>
</tbody>
</table>
<p>&nbsp;&nbsp;以上这些注解都组合了@Conditional元注解.</p>
<h3 id="分析-ConditionalOnNotWebApplication"><a href="#分析-ConditionalOnNotWebApplication" class="headerlink" title="分析@ConditionalOnNotWebApplication"></a>分析@ConditionalOnNotWebApplication</h3><p><img src="http://ww4.sinaimg.cn/mw690/63503acbjw1f6b8n61hytj20fb04dgmt.jpg" alt=""></p>
<p>&nbsp;&nbsp;@ConditionalOnNotWebApplication使用的条件类是OnWebApplicationCondition.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> org.springframework.boot.autoconfigure.condition;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionOutcome;</div><div class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.ConditionalOnWebApplication;</div><div class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.condition.SpringBootCondition;</div><div class="line"><span class="keyword">import</span> org.springframework.context.annotation.ConditionContext;</div><div class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</div><div class="line"><span class="keyword">import</span> org.springframework.core.type.AnnotatedTypeMetadata;</div><div class="line"><span class="keyword">import</span> org.springframework.util.ClassUtils;</div><div class="line"><span class="keyword">import</span> org.springframework.util.ObjectUtils;</div><div class="line"><span class="keyword">import</span> org.springframework.web.context.WebApplicationContext;</div><div class="line"><span class="keyword">import</span> org.springframework.web.context.support.StandardServletEnvironment;</div><div class="line"></div><div class="line"><span class="meta">@Order</span>(-<span class="number">2147483628</span>)</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">OnWebApplicationCondition</span> <span class="keyword">extends</span> <span class="title">SpringBootCondition</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String WEB_CONTEXT_CLASS = <span class="string">"org.springframework.web.context.support.GenericWebApplicationContext"</span>;</div><div class="line"></div><div class="line">    OnWebApplicationCondition() &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> ConditionOutcome <span class="title">getMatchOutcome</span><span class="params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span> </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> webApplicationRequired = metadata.isAnnotated(ConditionalOnWebApplication.class.getName());</div><div class="line">        ConditionOutcome webApplication = <span class="keyword">this</span>.isWebApplication(context, metadata);</div><div class="line">        <span class="keyword">return</span> webApplicationRequired &amp;&amp; !webApplication.isMatch()?ConditionOutcome.noMatch(webApplication.getMessage()):(!webApplicationRequired &amp;&amp; webApplication.isMatch()?ConditionOutcome.noMatch(webApplication.getMessage()):ConditionOutcome.match(webApplication.getMessage()));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> ConditionOutcome <span class="title">isWebApplication</span><span class="params">(ConditionContext context, AnnotatedTypeMetadata metadata)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span>(!ClassUtils.isPresent(<span class="string">"org.springframework.web.context.support.GenericWebApplicationContext"</span>, context.getClassLoader())) &#123;</div><div class="line">            <span class="keyword">return</span> ConditionOutcome.noMatch(<span class="string">"web application classes not found"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span>(context.getBeanFactory() != <span class="keyword">null</span>) &#123;</div><div class="line">                String[] scopes = context.getBeanFactory().getRegisteredScopeNames();</div><div class="line">                <span class="keyword">if</span>(ObjectUtils.containsElement(scopes, <span class="string">"session"</span>)) &#123;</div><div class="line">                    <span class="keyword">return</span> ConditionOutcome.match(<span class="string">"found web application \'session\' scope"</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">return</span> context.getEnvironment() <span class="keyword">instanceof</span> StandardServletEnvironment?ConditionOutcome.match(<span class="string">"found web application StandardServletEnvironment"</span>):(context.getResourceLoader() <span class="keyword">instanceof</span> WebApplicationContext?ConditionOutcome.match(<span class="string">"found web application WebApplicationContext"</span>):ConditionOutcome.noMatch(<span class="string">"not a web application"</span>));</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;OnWebApplicationCondition在isWebApplication函数中进行条件判断.</p>
<ol>
<li>判断GenericWebApplicationContext是否在类路径中.</li>
<li>判断容器中是否存在名为session的scope.</li>
<li>判断当前容器的Environment是否为StandardServletEnvironment.</li>
<li>判断当前的ResourceLoader是否为WebApplicationContext.</li>
<li>最后通过ConditionOutcome.isMatch函数返回布尔值确定条件.</li>
</ol>
<h3 id="分析自动配置的实现"><a href="#分析自动配置的实现" class="headerlink" title="分析自动配置的实现"></a>分析自动配置的实现</h3><p>&nbsp;&nbsp;以http编码为例,如果在常规项目中则需要在web.xml中配置一个filter.而Spring Boot内置了http编码的自动配置,无需配置filter.</p>
<h4 id="properties配置类"><a href="#properties配置类" class="headerlink" title="properties配置类"></a>properties配置类</h4><p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f6b9s692hxj20p30geq7e.jpg" alt=""></p>
<h4 id="自动配置Bean"><a href="#自动配置Bean" class="headerlink" title="自动配置Bean"></a>自动配置Bean</h4><p><img src="http://ww1.sinaimg.cn/mw690/63503acbjw1f6b9q6z1y8j20wc0idwkd.jpg" alt=""></p>
<p>&nbsp;&nbsp;@ConditionalOnProperty:当设置spring.http.encoding=enabled的情况下,如果没有设置则默认为true,即符合条件.</p>
<p>&nbsp;&nbsp;characterEncodingFilter()返回OrderedCharacterEncodingFilter这个对象,并根据注入的HttpEncodingProperties配置类设置参数.</p>
<p>&nbsp;&nbsp; @ConditionalOnMissingBean({CharacterEncodingFilter.class}):在容器中没有这个Bean的时候则新建这个Bean.</p>
<h3 id="end"><a href="#end" class="headerlink" title="end"></a>end</h3><blockquote>
<p>资料参考于 JavaEE开发的颠覆者: Spring Boot实战</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sylvanassun.github.io/2016/07/29/2016-07-29-Spring-boot-autoconfigure/" data-id="cj4z0jkbf000ruomjku6qk2sw" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/">Spring</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端开发/">后端开发</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016-07-19-Hadoop06-Storm" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/19/2016-07-19-Hadoop06-Storm/" class="article-date">
  <time datetime="2016-07-19T10:00:00.000Z" itemprop="datePublished">2016-07-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/19/2016-07-19-Hadoop06-Storm/">Hadoop学习笔记(6)-Storm</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f5z3iwds07j207g03nmxf.jpg" alt=""></p>
<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>&nbsp;&nbsp;Storm是一个开源的分布式实时计算系统，可以简单、可靠的处理大量的数据流。被称作“实时的hadoop”。Storm有很多使用场景：如实时分析，在线机器学习，持续计算， 分布式RPC，ETL等等。Storm支持水平扩展，具有高容错性，保证每个消息都会得到处理，而且处理速度很快。Storm的部署和运维都很便捷，而且更为重要的是可以使用任意编程语言来开发应用。</p>
<h3 id="Storm的特点"><a href="#Storm的特点" class="headerlink" title="Storm的特点"></a>Storm的特点</h3><p><strong>简单的编程模型</strong></p>
<p>&nbsp;&nbsp;在大数据处理方面相信大家对hadoop已经耳熟能详，基于Google Map/Reduce来实现的Hadoop为开发者提供了map、reduce原语，使并行批处理程序变得非常地简单和优美。</p>
<p>&nbsp;&nbsp;同样，Storm也为大数据 的实时计算提供了一些简单优美的原语，这大大降低了开发并行实时处理的任务的复杂性，帮助你快速、高效的开发应用。</p>
<p><strong>水平扩展</strong></p>
<p>&nbsp;&nbsp;在Storm集群中真正运行topology的主要有三个实体：工作进程、线程和任务。Storm集群中的每台机器上都可以运行多个工作进程，每个 工作进程又可创建多个线程，每个线程可以执行多个任务，任务是真正进行数据处理的实体，我们开发的spout、bolt就是作为一个或者多个任务的方式执行的。</p>
<p>&nbsp;&nbsp;计算任务在多个线程、进程和服务器之间并行进行，支持灵活的水平扩展。</p>
<p><strong>支持多种编程语言</strong></p>
<p>&nbsp;&nbsp;你可以在Storm之上使用各种编程语言。默认支持Clojure、Java、Ruby和Python。要增加对其他语言的支持，只需实现一个简单的Storm通信协议即可。</p>
<p><strong>高可靠性</strong></p>
<p>&nbsp;&nbsp;Storm保证每个消息至少能得到一次完整处理。任务失败时，它会负责从消息源重试消息。</p>
<p>&nbsp;&nbsp;spout发出的消息后续可能会触发产生成千上万条消息，可以形象的理解为一棵消息树，其中spout发出的消息为树根，Storm会跟踪这棵消息树的处理情况，只有当这棵消息树中的所有消息都被处理了，Storm才会认为spout发出的这个消息已经被“完全处理”。如果这棵消息树中的任何一个消息处理失败了，或者整棵消息树在限定的时间内没有“完全处理”，那么spout发出的消息就会重发。</p>
<p><strong>高容错性</strong></p>
<p>&nbsp;&nbsp;Storm会管理工作进程和节点的故障。</p>
<p>&nbsp;&nbsp;如果在消息处理过程中出了一些异常，Storm会重新安排这个出问题的处理单元。Storm保证一个处理单元永远运行（除非你显式杀掉这个处理单元）。</p>
<p>&nbsp;&nbsp;当然，如果处理单元中存储了中间状态，那么当处理单元重新被Storm启动的时候，需要应用自己处理中间状态的恢复。</p>
<p><strong>本地模式</strong></p>
<p>&nbsp;&nbsp;Storm有一个“本地模式”，可以在处理过程中完全模拟Storm集群。这让你可以快速进行开发和单元测试。</p>
<h3 id="Storm架构"><a href="#Storm架构" class="headerlink" title="Storm架构"></a>Storm架构</h3><p><img src="http://ww4.sinaimg.cn/mw690/63503acbjw1f5za3m6lqaj20go0f5gn1.jpg" alt=""></p>
<p>&nbsp;&nbsp;Storm集群由一个主节点和多个工作节点组成。主节点运行了一个名为“Nimbus”的守护进程，用于分配代码、布置任务及故障检测。每个工作节 点都运行了一个名为“Supervisor”的守护进程，用于监听工作，开始并终止工作进程。Nimbus和Supervisor都能快速失败，而且是无状态的，这样一来它们就变得十分健壮，两者的协调工作是由ApacheZooKeeper来完成的。</p>
<h4 id="Stream"><a href="#Stream" class="headerlink" title="Stream"></a>Stream</h4><p>&nbsp;&nbsp;Stream是一个数据流的抽象。这是一个没有边界的Tuple序列,而这些Tuple序列会以一种分布式的方式并行地创建和处理。</p>
<p>&nbsp;&nbsp;对消息流的定义主要就是对消息流里面的tuple 进行定义，为了更好地使用tuple，需要给tuple 里的每个字段取一个名字，并且不同的tuple 字段对应的类型要相同，即两个tuple 的第一个字段类型相同，第二个字段类型相同，但是第一个字段和第二个字段的类型可以不同。默认情况下，tuple 的字段类型可以为integer、long、short、byte、string、double、float、boolean 和byte array 等基本类型，也可以自定义类型，只需要实现相应的序列化接口。</p>
<p>&nbsp;&nbsp;每一个消息流在定义的时候需要被分配一个id，最常见的消息流是单向的消息流，在Storm 中OutputFieldsDeclarer 定义了一些方法，让你可以定义一个Stream 而不用指定这个id。在这种情况下，这个Stream 会有个默认的id: 1。</p>
<h4 id="Topologies"><a href="#Topologies" class="headerlink" title="Topologies"></a>Topologies</h4><p>&nbsp;&nbsp;<strong>Topology是由Stream Grouping连接起来的Spout和Bolt节点网络。</strong></p>
<p>&nbsp;&nbsp;在 Storm 中，一个实时计算应用程序的逻辑被封装在一个称为Topology 的对象中，也称为计算拓扑。Topology 有点类似于Hadoop 中的MapReduce Job，但是它们之间的关键区别在于，一个MapReduce Job 最终总是会结束的，然而一个Storm 的Topology 会一直运行。在逻辑上，一个Topology 是由一些Spout（消息的发送者）和Bolt（消息的处理者）组成图状结构，而链接Spouts 和Bolts 的则是Stream Groupings。</p>
<h4 id="Spouts-amp-Bolts"><a href="#Spouts-amp-Bolts" class="headerlink" title="Spouts&amp;Bolts"></a>Spouts&amp;Bolts</h4><p><img src="http://ww4.sinaimg.cn/mw690/63503acbjw1f5za9p00fyj20mo0a975d.jpg" alt=""></p>
<p><strong>Spouts</strong></p>
<p>&nbsp;&nbsp;Spouts 是Storm集群中一个计算任务（Topology）中消息流的生产者，Spouts一般是从别的数据源（例如，数据库或者文件系统）加载数据，然后向Topology中发射消息。</p>
<p>&nbsp;&nbsp;Spouts即可以是可靠的,也可以是不可靠的。</p>
<p>&nbsp;&nbsp;在一个Topology中存在两种Spouts，一种是可靠的Spouts，一种是非可靠的Spouts，可靠的Spouts 在一个tuple 没有成功处理的时候会重新发射该tuple，以保证消息被正确地处理。不可靠的Spouts 在发射一个tuple 之后，不会再重新发射该tuple，即使该tuple 处理失败。每个Spouts 都可以发射多个消息流，要实现这样的效果，可以使用OutFieldsDeclarer.declareStream 来定义多个Stream，然后使用SpoutOutputCollector 来发射指定的Stream。</p>
<p>&nbsp;&nbsp;在Storm 的编程接口中，Spout 类最重要的方法是nextTuple()方法，使用该方法可以发射一个消息tuple 到Topology 中，或者简单地直接返回，如果没有消息要发射。需要注意的是，nextTuple 方法的实现不能阻塞Spout，因为Storm在同一线程上调用Spout 的所有方法。Spout 类的另外两个重要的方法是ack()和fail()，一个tuple 被成功处理完成后，ack()方法被调用，否则就调用fail()方法。注意，只有对于可靠的Spout，才会调用ack()和fail()方法。</p>
<p><strong>Bolts</strong></p>
<p>&nbsp;&nbsp;所有消息处理的逻辑都在Bolt 中完成，在Bolt 中可以完成如过滤、分类、聚集、计算、查询数据库等操作。Bolt 可以做简单的消息处理操作，例如，Bolt 可以不做任何操作，只是将接收到的消息转发给其他的Bolt。Bolt 也可以做复杂的消息流的处理，从而需要很多个Bolt。在实际使用中，一条消息往往需要经过多个处理步骤，例如，计算一个班级中成绩在前十名的同学，首先需要对所有同学的成绩进行排序，然后在排序过的成绩中选出前十名的<br>成绩的同学。所以在一个Topology 中，往往有很多个Bolt，从而形成了复杂的流处理网络。</p>
<p>&nbsp;&nbsp;Bolts可以发射多条消息流。</p>
<ol>
<li>使用OutputFieldsDeclarer.declareStream定义Stream。</li>
<li>使用OutputCollector.emit来选择要发射的Stream。</li>
</ol>
<p>&nbsp;&nbsp;Bolts的主要方法是execute。</p>
<p>&nbsp;&nbsp;Bolts以Tuple作为输入,使用OutputCollector来发射Tuple,通过调用OutputCollector.ack()通知这个Tuple的发射者Spout。</p>
<p>&nbsp;&nbsp;Bolts一般流程。</p>
<p>&nbsp;&nbsp;处理一个输入Tuple,发射0个或多个Tuple,然后调用ack()通知Storm自己已经处理过这个Tuple了。Storm提供了一个IBasicBolt会自动调用ack()。</p>
<h4 id="Stream-Groupings"><a href="#Stream-Groupings" class="headerlink" title="Stream Groupings"></a>Stream Groupings</h4><p>&nbsp;&nbsp;定义一个 Topology 的其中一步是定义每个Bolt 接收什么样的流作为输入。Stream Grouping 就是用来定义一个Stream 应该如何分配给Bolts 上面的多个Tasks。</p>
<p>&nbsp;&nbsp;Storm里有7种类型的Stream Grouping。</p>
<ol>
<li>Shuffle Grouping 随机分组,随机派发Stream里面的Tuple,保证每个Bolt接收到的Tuple数量大致相同。</li>
<li>Fields Grouping 按字段分组,以id举例。具有相同id的Tuple会被分到相同的Bolt中的一个Task,而不同id的Tuple会被分到不同的Bolt中的Task。</li>
<li>All Grouping 广播,对于每一个Tuple,所有的Bolts都会收到。</li>
<li>Global Grouping 全局分组,这个Tuple被分配到Storm中的一个Bolt的其中一个Task。具体一点就是分配给id值最低的那个Task。</li>
<li>Non Grouping 不分组,Stream不关心到底谁会收到它的Tuple。目前这种分组和Shuffle Grouping是一样的效果,有一点不同的是Storm会把这个Bolt放到这个Bolt的订阅者同一个线程中去执行。</li>
<li>Direct Grouping 直接分组,这是一种比较特别的分组方法,用这种分组意味着消息的发送者指定由消息接收者的哪个Task处理这个消息。只有被声明为Direct Stream的消息流可以声明这种分组方法。而且这种消息Tuple必须使用emitDirect方法来发射。消息处理者可以通过TopologyContext来获取处理它的消息的Task的id(OutputCollector.emit方法也会返回Task的id)。</li>
<li>Local or Shuffle Grouping 如果目标Bolt有一个或者多个Task在同一个工作进程中,Tuple将会被随机发射给这些Tasks。否则,和普通的Shuffle Grouping行为一致。</li>
</ol>
<h4 id="Workers"><a href="#Workers" class="headerlink" title="Workers"></a>Workers</h4><p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f5zdzh1eo9j20bq08h0t6.jpg" alt=""></p>
<ol>
<li>每个Supervisor中运行着多个Workers进程。</li>
<li>每个Worker进程中运行着多个Executor线程。</li>
<li>每个Executor线程中运行着若干个相同的Task(Spout/Bolt)。</li>
</ol>
<p>&nbsp;&nbsp;一个 Topology 可能会在一个或者多个工作进程里面执行，每个工作进程执行整个Topology 的一部分。比如，对于并行度是300 的Topology 来说，如果我们使用50 个工作进程来执行，那么每个工作进程会处理其中的6 个Tasks（其实就是每个工作进程里面分配6 个线程）。Storm 会尽量均匀地把工作分配给所有的工作进程。</p>
<h4 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h4><p>&nbsp;&nbsp;在 Storm 集群上，每个Spout 和Bolt 都是由很多个Task 组成的，每个Task对应一个线程，流分组策略就是定义如何从一堆Task 发送tuple 到另一堆Task。在实现自己的Topology 时可以调用TopologyBuilder.setSpout() 和TopBuilder.setBolt()方法来设置并行度，也就是有多少个Task。</p>
<h3 id="Storm安装部署"><a href="#Storm安装部署" class="headerlink" title="Storm安装部署"></a>Storm安装部署</h3><ol>
<li>安装jdk。</li>
<li>搭建Zookeeper集群。</li>
<li>下载并解压Storm。</li>
<li>修改storm.yaml配置文件。<ul>
<li>storm.zookeeper.servers: Storm集群使用的Zookeeper集群地址。例如:<br>storm.zookeeper.servers:<br>-“192.168.145.141”<br>-“192.168.145.142”</li>
<li>如果Zookeeper没有使用默认端口,那么还需要修改storm.zookeeper.port。</li>
<li>storm.local.dir Nimbus和Supervisor进程用于存储少量状态,如jars、confs等的本地磁盘目录,需要提前创建该目录并给予足够的访问权限。然后在storm.yaml中配置该目录,例如:<br>storm.local.dir:”/home/application/storm/workdir”</li>
</ul>
</li>
</ol>
<h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><p>&nbsp;&nbsp;启动Storm后台进程时,需要对conf/storm.yaml配置文件中设置的storm.local.dir目录具有写权限。</p>
<p>&nbsp;&nbsp;Storm后台进程被启动时,将在Storm安装目录下的logs/子目录下生成各个进程的日志文件。</p>
<p>&nbsp;&nbsp;Storm UI必须和Storm Nimbus部署在同一台机器上,否则UI无法正常工作,因为UI进程会检查本机是否存在Nimbus链接。</p>
<h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h3><table>
<thead>
<tr>
<th>命令描述</th>
<th>格式</th>
<th>例子</th>
</tr>
</thead>
<tbody>
<tr>
<td>启动Nimbus</td>
<td>storm nimbus</td>
<td>storm nimbus</td>
</tr>
<tr>
<td>启动Supervisor</td>
<td>storm supervisor</td>
<td>storm supervisor</td>
</tr>
<tr>
<td>启动UI</td>
<td>storm ui</td>
<td>storm ui</td>
</tr>
</tbody>
</table>
<h4 id="提交Topologies"><a href="#提交Topologies" class="headerlink" title="提交Topologies"></a>提交Topologies</h4><p><strong>格式</strong> </p>
<p>storm jar 【jar路径】 【拓扑包名.拓扑类名】【stormIP地址】【storm端口】【拓扑名称】【参数】</p>
<p><strong>Example</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">storm jar /home/storm/hello.jar</div><div class="line">storm.hello.WordCountTopology wordcountTop</div><div class="line">提交hello.jar到远程集群,并启动wordcountTop拓扑</div></pre></td></tr></table></figure>
<h4 id="停止Topologies"><a href="#停止Topologies" class="headerlink" title="停止Topologies"></a>停止Topologies</h4><p><strong>格式</strong></p>
<p>storm kill [拓扑名称]</p>
<p><strong>Example</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">storm kill wordcountTop</div></pre></td></tr></table></figure>
<h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><h4 id="Spouts"><a href="#Spouts" class="headerlink" title="Spouts"></a>Spouts</h4><p>&nbsp;&nbsp; Spout是Stream的消息产生源， Spout组件的实现可以通过继承BaseRichSpout类或者其他*Spout类来完成，也可以通过实现IRichSpout接口来实现。</p>
<p><strong>open</strong></p>
<p>&nbsp;&nbsp;当一个Task被初始化的时候会调用open()。一般都会在此方法中对发送Tuple的对象SpoutOutputCollector和配置对象TopologyContext初始化。</p>
<p><strong>getComponentConfiguration</strong></p>
<p>&nbsp;&nbsp;此方法用于声明针对当前组件的特殊的Configuration配置。</p>
<p><strong>nextTuple</strong></p>
<p>&nbsp;&nbsp;这是Spout类中最重要的一个方法。发射一个Tuple到Topology都是通过这个方法来实现的。</p>
<p><strong>declareOutputFields</strong></p>
<p>&nbsp;&nbsp;此方法用于声明当前Spout的Tuple发送流。Stream的定义是通过OutputFieldsDeclare.declare方法完成的,其中的参数包括了发送的Fields。</p>
<p>&nbsp;&nbsp;另外，除了上述几个方法之外，还有ack、fail和close方法等。</p>
<p>&nbsp;&nbsp;Storm在监测到一个Tuple被成功处理之后会调用ack方法，处理失败会调用fail方法。这两个方法在BaseRichSpout等类中已经被隐式的实现了。</p>
<h4 id="Bolts"><a href="#Bolts" class="headerlink" title="Bolts"></a>Bolts</h4><p>&nbsp;&nbsp; Bolt类接收由Spout或者其他上游Bolt类发来的Tuple，对其进行处理。Bolt组件的实现可以通过继承BasicRichBolt类或者IRichBolt接口来完成。</p>
<p><strong>prepare</strong></p>
<p>&nbsp;&nbsp;此方法与Spouts的open方法类似,为Bolt提供了OutputCollector,用来从Bolt中发射Tuple。Bolt中Tuple的发射可以在prepare中、execute中、cleanup等方法中进行,一般都是在execute中。</p>
<p><strong>getComponentConfiguration</strong></p>
<p>&nbsp;&nbsp;与Spouts类似。</p>
<p><strong>execute</strong></p>
<p>&nbsp;&nbsp;  这是Bolt中最关键的一个方法，对于Tuple的处理都可以放到此方法中进行。具体的发送也是在execute中通过调用emit方法来完成的。</p>
<p>&nbsp;&nbsp;emit有两种情况，一种是emit方法中有两个参数，另一个种是有一个参数。</p>
<ol>
<li>emit有一个参数：此唯一的参数是发送到下游Bolt的Tuple，此时，由上游发来的旧的Tuple在此隔断，新的Tuple和旧的Tuple不再属于同一棵Tuple树。新的Tuple另起一个新的Tuple树。</li>
<li>emit有两个参数：第一个参数是旧的Tuple的输入流，第二个参数是发往下游Bolt的新的Tuple流。此时，新的Tuple和旧的Tuple是仍然属于同一棵Tuple树，即，如果下游的Bolt处理Tuple失败，则会向上传递到当前Bolt，当前Bolt根据旧的Tuple流继续往上游传递，申请重发失败的Tuple。保证Tuple处理的可靠性。</li>
</ol>
<p><strong>declareOutputFields</strong></p>
<p>&nbsp;&nbsp;用于声明当前Bolt发送的Tuple中包含的字段。</p>
<h4 id="Topology-Example"><a href="#Topology-Example" class="headerlink" title="Topology Example"></a>Topology Example</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RandomWordSpout</span> <span class="keyword">extends</span> <span class="title">BaseRichSpout</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">// 初始化数据字典</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String[] words = &#123; <span class="string">"java"</span>, <span class="string">"c"</span>, <span class="string">"c++"</span>, <span class="string">"c#"</span>, <span class="string">"python"</span>, <span class="string">"go"</span>, <span class="string">"javascript"</span>,</div><div class="line">			<span class="string">"swift"</span> &#125;;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> SpoutOutputCollector collector;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nextTuple</span><span class="params">()</span> </span>&#123;</div><div class="line">		Random random = <span class="keyword">new</span> Random();</div><div class="line">		<span class="comment">// 获取随机的单词</span></div><div class="line">		String word = words[random.nextInt(words.length)];</div><div class="line">		<span class="comment">// 发射消息</span></div><div class="line">		<span class="keyword">this</span>.collector.emit(<span class="keyword">new</span> Values(word));</div><div class="line">		<span class="comment">// 休息2秒</span></div><div class="line">		Utils.sleep(<span class="number">2000</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">open</span><span class="params">(Map arg0, TopologyContext arg1, SpoutOutputCollector collector)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.collector = collector;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</div><div class="line">		<span class="comment">// 声明字段名</span></div><div class="line">		declarer.declare(<span class="keyword">new</span> Fields(<span class="string">"initName"</span>));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UpperBolt</span> <span class="keyword">extends</span> <span class="title">BaseBasicBolt</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple tuple, BasicOutputCollector collector)</span> </span>&#123;</div><div class="line">		<span class="comment">// 获得上个bolt传入的initName</span></div><div class="line">		String initName = tuple.getString(<span class="number">0</span>);</div><div class="line">		<span class="comment">// 将initName转为大写</span></div><div class="line">		String upperCase = initName.toUpperCase();</div><div class="line">		<span class="comment">// 发射消息</span></div><div class="line">		collector.emit(<span class="keyword">new</span> Values(upperCase));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</div><div class="line">		declarer.declare(<span class="keyword">new</span> Fields(<span class="string">"upperName"</span>));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrefixBolt</span> <span class="keyword">extends</span> <span class="title">BaseBasicBolt</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> FileWriter fileWriter;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(Map stormConf, TopologyContext context)</span> </span>&#123;</div><div class="line">		<span class="comment">// 初始化fileWriter</span></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="keyword">this</span>.fileWriter = <span class="keyword">new</span> FileWriter(<span class="string">"/home/storm/output/"</span> + UUID.randomUUID());</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple tuple, BasicOutputCollector collector)</span> </span>&#123;</div><div class="line">		String upperName = tuple.getString(<span class="number">0</span>);</div><div class="line">		<span class="comment">// 添加前缀</span></div><div class="line">		String finalName = <span class="string">"hello-"</span> + upperName;</div><div class="line">		<span class="comment">// write</span></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="keyword">this</span>.fileWriter.write(finalName);</div><div class="line">			<span class="keyword">this</span>.fileWriter.write(<span class="string">"\n"</span>);</div><div class="line">			<span class="keyword">this</span>.fileWriter.flush();</div><div class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TopologyMain</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		TopologyBuilder topologyBuilder = <span class="keyword">new</span> TopologyBuilder();</div><div class="line">		<span class="comment">// 设置Spout</span></div><div class="line">		topologyBuilder.setSpout(<span class="string">"randomWordSpout"</span>, <span class="keyword">new</span> RandomWordSpout());</div><div class="line">		<span class="comment">// 设置Bolt</span></div><div class="line">		topologyBuilder.setBolt(<span class="string">"upperBolt"</span>, <span class="keyword">new</span> UpperBolt()).shuffleGrouping(<span class="string">"randomWordSpout"</span>);</div><div class="line">		topologyBuilder.setBolt(<span class="string">"prefixBolt"</span>, <span class="keyword">new</span> PrefixBolt()).shuffleGrouping(<span class="string">"upperBolt"</span>);</div><div class="line"></div><div class="line">		Config config = <span class="keyword">new</span> Config();</div><div class="line">		<span class="comment">// 设置Workers数量</span></div><div class="line">		config.setNumWorkers(<span class="number">4</span>);</div><div class="line">		config.setDebug(<span class="keyword">true</span>);</div><div class="line">		<span class="comment">// 提交Topology</span></div><div class="line">		StormSubmitter.submitTopology(<span class="string">"randomTopo"</span>, config, topologyBuilder.createTopology());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://sylvanassun.github.io/2016/07/19/2016-07-19-Hadoop06-Storm/" data-id="cj4z0jkbh000uuomjyx5iljqf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hadoop/">Hadoop</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端开发/">后端开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/大数据/">大数据</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016-07-18-Hadoop05-Hive" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/18/2016-07-18-Hadoop05-Hive/" class="article-date">
  <time datetime="2016-07-18T10:00:00.000Z" itemprop="datePublished">2016-07-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/18/2016-07-18-Hadoop05-Hive/">Hadoop学习笔记(5)-Hive</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f5x3hcttd1j20ai0513yq.jpg" alt=""></p>
<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>&nbsp;&nbsp;Hive是建立在Hadoop上的数据仓库基础架构。它提供了一系列的工具，用来进行数据提取、转换、加载，这是一种可以存储、查询和分析存储在Hadoop中的大规模数据机制。可以把Hadoop下结构化数据文件映射为一张成Hive中的表，并提供类sql查询功能，除了不支持更新、索引和事务，sql其它功能都支持。可以将sql语句转换为MapReduce任务进行运行，作为sql到MapReduce的映射器。提供shell、JDBC/ODBC、Thrift、Web等接口。</p>
<p>&nbsp;&nbsp;Hive 并不适合那些需要低延迟的应用，例如，联机事务处理（OLTP）。Hive 查询操作过程严格遵守Hadoop MapReduce 的作业执行模型，Hive 将用户的HiveQL 语句通过解释器转换为MapReduce 作业提交到Hadoop 集群上，Hadoop 监控作业执行过程，然后返回作业执行结果给用户。Hive 并非为联机事务处理而设计，Hive 并不提供实时的查询和基于行级的数据更新操作。Hive 的最佳使用场合是大数据集的批处理作业，例如，网络日志分析。</p>
<h3 id="元数据存储"><a href="#元数据存储" class="headerlink" title="元数据存储"></a>元数据存储</h3><p>&nbsp;&nbsp;Hive将元数据存储在RDBMS中，有三种方式可以连接到数据库。</p>
<ol>
<li>内嵌模式：元数据保持在内嵌数据库的Derby，一般用于单元测试，只允许一个会话连接。</li>
<li>多用户模式：在本地安装Mysql，把元数据放到Mysql内。</li>
<li>远程模式：元数据放置在远程的Mysql数据库。</li>
</ol>
<h3 id="数据存储"><a href="#数据存储" class="headerlink" title="数据存储"></a>数据存储</h3><p> &nbsp;&nbsp;Hive没有专门的数据存储格式，也没有为数据建立索引，用于可以非常自由的组织Hive中的表，只需要在创建表的时候告诉Hive数据中的列分隔符和行分隔符。</p>
<p> &nbsp;&nbsp;Hive中所有的数据都存储在HDFS中，Hive中包含4中数据模型：Tabel、ExternalTable、Partition、Bucket。</p>
<p> <strong>Table</strong></p>
<p> &nbsp;&nbsp;类似与传统数据库中的Table，每一个Table在Hive中都有一个相应的目录来存储数据。例如：一个表zz，它在HDFS中的路径为：/wh/zz，其中wh是在hive-site.xml中由${hive.metastore.warehouse.dir}指定的数据仓库的目录，所有的Table数据（不含External Table）都保存在这个目录中。</p>
<p> <strong>Partition</strong></p>
<p> &nbsp;&nbsp;类似于传统数据库中划分列的索引。在Hive中，表中的一个Partition对应于表下的一个目录，所有的Partition数据都存储在对应的目录中。例如：zz表中包含ds和city两个Partition，则对应于ds=20140214，city=beijing的HDFS子目录为：/wh/zz/ds=20140214/city=Beijing。</p>
<p> <strong>ExternalTable</strong></p>
<p> &nbsp;&nbsp;指向已存在HDFS中的数据，可创建Partition。和Table在元数据组织结构相同，在实际存储上有较大差异。Table创建和数据加载过程，可以用统一语句实现，实际数据被转移到数据仓库目录中，之后对数据的访问将会直接在数据仓库的目录中完成。删除表时，表中的数据和元数据都会删除。ExternalTable只有一个过程，因为加载数据和创建表是同时完成。时间数据是存储在Location后面指定的HDFS路径中的，并不会移动到数据仓库中。</p>
<p> <strong>Bcuket</strong></p>
<p> &nbsp;&nbsp;对指定列计算的hash，根据hash值切分数据，目的是为了便于并行，每一个Buckets对应一个文件。将user列分数至32个Bucket上，首先对user列的值计算hash，比如，对应hash=0的HDFS目录为：/wh/zz/ds=20140214/city=Beijing/part-00000;对应hash=20的，目录为：/wh/zz/ds=20140214/city=Beijing/part-00020。</p>
<h3 id="Hive常用优化方法"><a href="#Hive常用优化方法" class="headerlink" title="Hive常用优化方法"></a>Hive常用优化方法</h3><ol>
<li>join连接时的优化：当三个或多个以上的表进行join操作时，如果每个on使用相同的字段连接时只会产生一个mapreduce。</li>
<li>join连接时的优化：当多个表进行查询时，从左到右表的大小顺序应该是从小到大。原因：hive在对每行记录操作时会把其他表先缓存起来，直到扫描最后的表进行计算。</li>
<li>在where字句中增加分区过滤器。</li>
<li>当可以使用left semi join 语法时不要使用inner join，前者效率更高。原因：对于左表中指定的一条记录，一旦在右表中找到立即停止扫描。</li>
<li>如果所有表中有一张表足够小，则可置于内存中，这样在和其他表进行连接的时候就能完成匹配，省略掉reduce过程。设置属性即可实现，set hive.auto.covert.join=true; 用户可以配置希望被优化的小表的大小 set hive.mapjoin.smalltable.size=2500000; 如果需要使用这两个配置可置入$HOME/.hiverc文件中。</li>
<li>同一种数据的多种处理：从一个数据源产生的多个数据聚合，无需每次聚合都需要重新扫描一次。<br>例如:insert overwrite table student select <em>　from employee; insert overwrite table person select </em> from employee;<br>可以优化成 from employee insert overwrite table student select <em> insert overwrite table person select </em></li>
<li>limit调优：limit语句通常是执行整个语句后返回部分结果。set hive.limit.optimize.enable=true;</li>
<li>开启并发执行。某个job任务中可能包含众多的阶段，其中某些阶段没有依赖关系可以并发执行，开启并发执行后job任务可以更快的完成。设置属性：set hive.exec.parallel=true;</li>
<li>hive提供的严格模式，禁止3种情况下的查询模式。<ul>
<li>当表为分区表时，where字句后没有分区字段和限制时，不允许执行。</li>
<li>当使用order by语句时，必须使用limit字段，因为order by 只会产生一个reduce任务。</li>
<li>限制笛卡尔积的查询。</li>
</ul>
</li>
<li>合理的设置map和reduce数量。</li>
<li>jvm重用。可在hadoop的mapred-site.xml中设置jvm被重用的次数。</li>
</ol>
<h3 id="安装Hive"><a href="#安装Hive" class="headerlink" title="安装Hive"></a>安装Hive</h3><ol>
<li>解压Hive。</li>
<li>将mysql的驱动jar包copy到${HIVE_HOME}/lib目录下。</li>
<li>cp hive-default.xml.template  hive-size.xml。</li>
<li>配置hive-size.xml。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"> &lt;configuration&gt;</div><div class="line">	&lt;!-- 指定数据库URL --&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;javax.jdo.option.ConnectionURL&lt;/name&gt;</div><div class="line">		&lt;value&gt;jdbc:mysql://192.168.145.148:3306/hive?createDatabaseIfNotExist=true&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;javax.jdo.option.ConnectionDriverName&lt;/name&gt;</div><div class="line">		&lt;value&gt;com.mysql.jdbc.Driver&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;javax.jdo.option.ConnectionUserName&lt;/name&gt;</div><div class="line">		&lt;value&gt;root&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;javax.jdo.option.ConnectionPassword&lt;/name&gt;</div><div class="line">		&lt;value&gt;root&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="Hive-QL"><a href="#Hive-QL" class="headerlink" title="Hive QL"></a>Hive QL</h3><h4 id="文件格式"><a href="#文件格式" class="headerlink" title="文件格式"></a>文件格式</h4><p>&nbsp;&nbsp;Hive创建表可以指定四种文件格式。</p>
<ol>
<li>文本格式的数据是Hadoop中经常碰到的。如TextFile 、XML和JSON。 文本格式除了会占用更多磁盘资源外，对它的解析开销一般会比二进制格式高几十倍以上，尤其是XML 和JSON，它们的解析开销比Textfile 还要大，因此强烈不建议在生产系统中使用这些格式进行储存。如果需要输出这些格式，请在客户端做相应的转换操作。 文本格式经常会用于日志收集，数据库导入，Hive默认配置也是使用文本格式，而且常常容易忘了压缩，所以请确保使用了正确的格式。另外文本格式的一个缺点是它不具备类型和模式，比如销售金额、利润这类数值数据或者日期时间类型的数据，如果使用文本格式保存，由于它们本身的字符串类型的长短不一，或者含有负数，导致MR没有办法排序，所以往往需要将它们预处理成含有模式的二进制格式，这又导致了不必要的预处理步骤的开销和储存资源的浪费。</li>
<li>SequenceFile是Hadoop API 提供的一种二进制文件，它将数据以<key,value>的形式序列化到文件中。这种二进制文件内部使用Hadoop 的标准的Writable 接口实现序列化和反序列化。它与Hadoop API中的MapFile 是互相兼容的。Hive 中的SequenceFile 继承自Hadoop API 的SequenceFile，不过它的key为空，使用value 存放实际的值， 这样是为了避免MR 在运行map 阶段的排序过程。如果你用Java API 编写SequenceFile，并让Hive 读取的话，请确保使用value字段存放数据，否则你需要自定义读取这种SequenceFile 的InputFormat class 和OutputFormat class。</key,value></li>
<li>RCFile是Hive推出的一种专门面向列的数据格式。 它遵循“先按列划分，再垂直划分”的设计理念。当查询过程中，针对它并不关心的列时，它会在IO上跳过这些列。需要说明的是，RCFile在map阶段从远端拷贝仍然是拷贝整个数据块，并且拷贝到本地目录后RCFile并不是真正直接跳过不需要的列，并跳到需要读取的列， 而是通过扫描每一个row group的头部定义来实现的，但是在整个HDFS Block 级别的头部并没有定义每个列从哪个row group起始到哪个row group结束。所以在读取所有列的情况下，RCFile的性能反而没有SequenceFile高。</li>
<li>Avro是一种用于支持数据密集型的二进制文件格式。它的文件格式更为紧凑，若要读取大量数据时，Avro能够提供更好的序列化和反序列化性能。并且Avro数据文件天生是带Schema定义的，所以它不需要开发者在API 级别实现自己的Writable对象。</li>
<li>其他格式:Hadoop实际上支持任意文件格式，只要能够实现对应的RecordWriter和RecordReader即可。其中数据库格式也是会经常储存在Hadoop中，比如Hbase，Mysql，Cassandra，MongoDB。 这些格式一般是为了避免大量的数据移动和快速装载的需求而用的。他们的序列化和反序列化都是由这些数据库格式的客户端完成，并且文件的储存位置和数据布局(Data Layout)不由Hadoop控制，他们的文件切分也不是按HDFS的块大小（blocksize）进行切割。</li>
</ol>
<h4 id="create-table"><a href="#create-table" class="headerlink" title="create table"></a>create table</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">create table test_user(id int,name string) </div><div class="line">    // 注释</div><div class="line">    comment &apos;This is the test table&apos;</div><div class="line">    row format delimited</div><div class="line">    // 指定切分格式规则</div><div class="line">    fields terminated by &apos;,&apos;</div><div class="line">    // 指定文件格式</div><div class="line">    stored as textfile;</div></pre></td></tr></table></figure>
<h4 id="insert-select"><a href="#insert-select" class="headerlink" title="insert select"></a>insert select</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//使用select语句来批量插入数据</div><div class="line">insert overwrite table test_user select * from tab_user;</div></pre></td></tr></table></figure>
<h4 id="load-data"><a href="#load-data" class="headerlink" title="load data"></a>load data</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">//从本地导入数据到hive的表中（实质就是将文件上传到hdfs中hive管理目录下）</div><div class="line">load data local inpath &apos;/home/hadoop/test.txt&apos; into table test_user;</div><div class="line"></div><div class="line">//从hdfs上导入数据到hive表中（实质就是将文件从原始目录移动到hive管理的目录下）</div><div class="line">load data inpath &apos;hdfs://ns1/data.log&apos; into table test_user;</div></pre></td></tr></table></figure>
<h4 id="external-table"><a href="#external-table" class="headerlink" title="external table"></a>external table</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">//LOCATION指定的是hdfs路径</div><div class="line">//如果LOCATION路径有数据,则可以直接映射数据建表</div><div class="line">CREATE EXTERNAL TABLE test_user_external(id int, name string)</div><div class="line"> ROW FORMAT DELIMITED</div><div class="line"> FIELDS TERMINATED BY &apos;,&apos;</div><div class="line"> STORED AS TEXTFILE</div><div class="line"> LOCATION &apos;/external/user&apos;;</div></pre></td></tr></table></figure>
<h4 id="CTAS"><a href="#CTAS" class="headerlink" title="CTAS"></a>CTAS</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">//CTAS是通过查询,然后根据查询的结果来建立表格的一种方式。</div><div class="line">//CTAS会根据SELECT语句创建表结构,并把数据一并复制过来。</div><div class="line">CREATE TABLE test_user_ctas</div><div class="line">   AS</div><div class="line">SELECT id new_id, name new_name</div><div class="line">FROM test_user</div><div class="line">SORT BY new_id;</div></pre></td></tr></table></figure>
<h4 id="Partition"><a href="#Partition" class="headerlink" title="Partition"></a>Partition</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">//创建一个分区表,以year年份作为分区字段</div><div class="line">create table test_user_part(id int,name string) </div><div class="line">    partitioned by (year string)</div><div class="line">    row format delimited fields terminated by &apos;,&apos;;</div><div class="line"></div><div class="line">//将data.log导入到test_user_part表中,并设置分区为1990    </div><div class="line">load data local inpath &apos;/home/hadoop/data.log&apos; overwrite into table test_user_part</div><div class="line">     partition(year=&apos;1990&apos;);</div><div class="line">    </div><div class="line">    </div><div class="line">load data local inpath &apos;/home/hadoop/data2.log&apos; overwrite into table test_user_part</div><div class="line">     partition(year=&apos;2000&apos;);</div></pre></td></tr></table></figure>
<h4 id="Array-amp-amp-Map"><a href="#Array-amp-amp-Map" class="headerlink" title="Array&amp;&amp;Map"></a>Array&amp;&amp;Map</h4><p>&nbsp;&nbsp;hive中的列支持使用struct、map和array集合数据类型。大多数关系型数据库中不支持这些集合数据类型，因为它们会破坏标准格式。关系型数据库中为实现集合数据类型是由多个表之间建立合适的外键关联来实现。在大数据系统中，使用集合类型的数据的好处在于提高数据的吞吐量，减少寻址次数来提高查询速度。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">//array </div><div class="line">create table tab_array(a array&lt;int&gt;,b array&lt;string&gt;)</div><div class="line">row format delimited</div><div class="line">fields terminated by &apos;\t&apos;</div><div class="line">collection items terminated by &apos;,&apos;;</div><div class="line"></div><div class="line">select a[0] from tab_array;</div><div class="line">select * from tab_array where array_contains(b,&apos;word&apos;);</div><div class="line">insert into table tab_array select array(0),array(name,ip) from tab_ext t; </div><div class="line"></div><div class="line">//map</div><div class="line">create table tab_map(name string,info map&lt;string,string&gt;)</div><div class="line">row format delimited</div><div class="line">fields terminated by &apos;\t&apos;</div><div class="line">collection items terminated by &apos;,&apos;</div><div class="line">map keys terminated by &apos;:&apos;;</div><div class="line"></div><div class="line">load data local inpath &apos;/home/hadoop/hivetemp/tab_map.txt&apos; overwrite into table tab_map;</div><div class="line">insert into table tab_map select name,map(&apos;name&apos;,name,&apos;ip&apos;,ip) from tab_ext;</div></pre></td></tr></table></figure>
<h3 id="UDF"><a href="#UDF" class="headerlink" title="UDF"></a>UDF</h3><p>&nbsp;&nbsp;UDF即用户自定义函数(User Defined Function),Hive支持UDF进行自定义函数的编写。</p>
<p>&nbsp;&nbsp;需要先使用Java代码开发UDF,然后再把jar包导入到Hive中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FindRegionByPhone</span> <span class="keyword">extends</span> <span class="title">UDF</span> </span>&#123;</div><div class="line">	</div><div class="line">	<span class="comment">//使用map模拟数据库</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;String,String&gt;  dataDictionary = <span class="keyword">new</span> HashMap&lt;String,String&gt;();</div><div class="line">	</div><div class="line">	<span class="keyword">static</span>&#123;</div><div class="line">		dataDictionary.put(<span class="string">"136"</span>,<span class="string">"beijing"</span>);</div><div class="line">		dataDictionary.put(<span class="string">"137"</span>,<span class="string">"guangzhou"</span>);</div><div class="line">		dataDictionary.put(<span class="string">"138"</span>,<span class="string">"shenzhen"</span>);</div><div class="line">		dataDictionary.put(<span class="string">"139"</span>,<span class="string">"shanghai"</span>);</div><div class="line">	&#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">evaluate</span><span class="params">(String phone)</span> </span>&#123;</div><div class="line">        </div><div class="line">        <span class="comment">// 如果没有匹配到对应的区域则返回"other"</span></div><div class="line">		<span class="keyword">return</span> areaMap.get(phone.substring(<span class="number">0</span>, <span class="number">3</span>)) == <span class="keyword">null</span> ? <span class="string">"other"</span> : areaMap</div><div class="line">				.get(phone.substring(<span class="number">0</span>, <span class="number">3</span>));</div><div class="line"></div><div class="line">	&#125;	</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="添加jar包到Hive"><a href="#添加jar包到Hive" class="headerlink" title="添加jar包到Hive"></a>添加jar包到Hive</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">方式1:添加到hive</div><div class="line">hive&gt; add jar /root/MyUDF.jar;</div><div class="line"></div><div class="line">方式2:添加到hdfs,调用时需要指定jar包地址</div><div class="line">hdfs -dfs -put MyUDF.jar &apos;hdfs:///user/hadoop/hiveUDF&apos;</div></pre></td></tr></table></figure>
<h4 id="创建临时函数"><a href="#创建临时函数" class="headerlink" title="创建临时函数"></a>创建临时函数</h4><p>&nbsp;&nbsp;临时函数只在当前session中有效,临时函数不能指定库。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">create temporary function testUDF as &apos;cn.sylvanas.hive.udf.FindRegionByPhone&apos; using jar &apos;hdfs:///user/hadoop/hiveUDF/MyUDF.jar&apos;</div></pre></td></tr></table></figure>
<h4 id="创建永久函数"><a href="#创建永久函数" class="headerlink" title="创建永久函数"></a>创建永久函数</h4><p><strong>格式</strong></p>
<p>CREATE FUNCTION [db_name.]function_name AS class_name[USING JAR|FILE|ARCHIVE ‘file_uri’ [, JAR|FILE|ARCHIVE ‘file_uri’] ];</p>
<p><strong>例如</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">create function test.testUDF as &apos;cn.sylvanas.hive.udf.FindRegionByPhone&apos; using jar &apos;hdfs:///user/hadoop/hiveUDF/MyUDF.jar&apos;</div><div class="line"></div><div class="line">函数需要属于某个库,如这里是’test’,当其他库调用时,需要加上库名,如’test.testUDF’.</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sylvanassun.github.io/2016/07/18/2016-07-18-Hadoop05-Hive/" data-id="cj4z0jkbd000puomjfiapxv3k" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hadoop/">Hadoop</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端开发/">后端开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/大数据/">大数据</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016-07-17-Hadoop04-HBase" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/17/2016-07-17-Hadoop04-HBase/" class="article-date">
  <time datetime="2016-07-17T10:00:00.000Z" itemprop="datePublished">2016-07-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/17/2016-07-17-Hadoop04-HBase/">Hadoop学习笔记(4)-HBase</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://ww1.sinaimg.cn/mw690/63503acbjw1f5wxvstywwj20dx03odg2.jpg" alt=""></p>
<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>&nbsp;&nbsp;HBase是一个分布式的、面向列的开源数据库，该技术来源于 Fay Chang 所撰写的Google论文“Bigtable：一个结构化数据的分布式存储系统”。就像Bigtable利用了Google文件系统（File System）所提供的分布式数据存储一样，HBase在Hadoop之上提供了类似于Bigtable的能力。HBase是Apache的Hadoop项目的子项目。HBase不同于一般的关系数据库，它是一个适合于非结构化数据存储的数据库。另一个不同的是HBase基于列的而不是基于行的模式。</p>
<p>&nbsp;&nbsp;与FUJITSU Cliq等商用大数据产品不同，HBase是Google Bigtable的开源实现，类似Google Bigtable利用GFS作为其文件存储系统，HBase利用Hadoop HDFS作为其文件存储系统；Google运行MapReduce来处理Bigtable中的海量数据，HBase同样利用Hadoop MapReduce来处理HBase中的海量数据；Google Bigtable利用 Chubby作为协同服务，HBase利用Zookeeper作为对应。</p>
<h3 id="HBase的特点"><a href="#HBase的特点" class="headerlink" title="HBase的特点"></a>HBase的特点</h3><ol>
<li>Hbase可以往数据里面insert，也可以update一些数据，但update的实际上也是insert，只是插入一个新的时间戳的一行。delete数据，也是insert，只是insert一行带有delete标记的一行。Hbase的所有操作都是追加插入操作。Hbase是一种日志集数据库。它的存储方式，像是日志文件一样。它是批量大量的往硬盘中写，通常都是以文件形式的读写。这个读写速度，取决于硬盘与机器之间的传输有多快。</li>
<li>Hbase中数据可以保存许多不同时间戳的版本（即同一数据可以复制许多不同的版本，准许数据冗余，也是优势）。数据按时间排序，因此Hbase特别适合寻找按照时间排序寻找Top n的场景。找出某个人最近浏览的消息，最近写的N篇博客，N种行为等等，因此Hbase在互联网应用非常多。</li>
<li>Hbase只有主键索引，因此在建模的时候会遇到了问题。例如，在一张表中，很多的列我都想做某种条件的查询。但却只能在主键上建快速查询。</li>
<li>Hbase是列式数据库,列式数据库的优势在于数据分析。</li>
<li>Hbase中的数据都是字符串，没有其他类型。</li>
</ol>
<h3 id="行式数据库与列式数据库的区别"><a href="#行式数据库与列式数据库的区别" class="headerlink" title="行式数据库与列式数据库的区别"></a>行式数据库与列式数据库的区别</h3><p> <strong>行式数据库</strong></p>
<p> &nbsp;&nbsp;以Oracle为例，数据文件的基本组成单位：块/页。块中数据是按照一行行写入的。这就存在一个问题，当我们要读一个块中的某些列的时候，不能只读这些列，必须把这个块整个的读入内存中，再把这些列的内容读出来。换句话就是：为了读表中的某些列，必须要把整个表的行全部读完，才能读到这些列。这就是行数据库最糟糕的地方。</p>
<p> <strong>列式数据库</strong> </p>
<p> &nbsp;&nbsp;列式数据库是以列作为元素存储的。同一个列的元素会挤在一个块。当要读某些列，只需要把相关的列块读到内存中，这样读的IO量就会少很多。通常，同一个列的数据元素通常格式都是相近的。这就意味着，当数据格式相近的时候，数据就可以做大幅度的压缩。所以，列式数据库在数据压缩方面有很大的优势，压缩不仅节省了存储空间，同时也节省了IO。（这一点，可利用在当数据达到百万、千万级别以后，数据查询之间的优化，提高性能，示场景而定）</p>
<h3 id="HBase架构"><a href="#HBase架构" class="headerlink" title="HBase架构"></a>HBase架构</h3><p><img src="http://ww4.sinaimg.cn/mw690/63503acbjw1f5x1207zfmj20gr0atq4h.jpg" alt=""></p>
<p>&nbsp;&nbsp;HBase采用Master/Slave架构搭建集群，它隶属于Hadoop生态系统，由以下类型节点组成：HMaster节点、HRegionServer节点、ZooKeeper集群，而在底层，它将数据存储于HDFS中，因而涉及到HDFS的NameNode、DataNode等节点。</p>
<p><strong>Zookeeper</strong></p>
<p>&nbsp;&nbsp;Zookeeper Quorum存储-ROOT-表地址、HMaster地址。HRegionServer把自己以Ephedral方式注册到Zookeeper中，HMaster随时感知各个HRegionServer的健康状况。</p>
<p><strong>HMaster</strong></p>
<p>&nbsp;&nbsp;HMaster没有单点问题,HBase中可以启动多个HMaster，通过Zookeeper的Master Election机制保证总有一个Master在运行。</p>
<p>&nbsp;&nbsp;HMaster主要负责Table和Region的管理工作</p>
<ol>
<li>实现DDL操作（Data Definition Language，namespace和table的增删改，column familiy的增删改等）。</li>
<li>管理HRegionServer的负载均衡，调整Region分布。</li>
<li>管理和分配HRegion，比如在HRegion split时分配新的HRegion；在HRegionServer退出时迁移其内的HRegion到其他HRegionServer上。</li>
<li>权限控制（ACL）。</li>
</ol>
<p><strong>HRegionServer</strong></p>
<p>&nbsp;&nbsp;HBase中最核心的模块，主要负责响应用户I/O请求，向HDFS文件系统中读写数据。</p>
<ol>
<li>存放和管理本地HRegion。</li>
<li>读写HDFS，管理Table中的数据。</li>
<li>Client直接通过HRegionServer读写数据（从HMaster中获取元数据，找到RowKey所在的HRegion/HRegionServer后）。</li>
</ol>
<p><strong>HRegion</strong></p>
<p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f5x2cuji5gj20k409ddho.jpg" alt=""></p>
<p>&nbsp;&nbsp;HBase使用RowKey将表水平切割成多个HRegion，从HMaster的角度，每个HRegion都纪录了它的StartKey和EndKey（第一个HRegion的StartKey为空，最后一个HRegion的EndKey为空），由于RowKey是排序的，因而Client可以通过HMaster快速的定位每个RowKey在哪个HRegion中。HRegion由HMaster分配到相应的HRegionServer中，然后由HRegionServer负责HRegion的启动和管理，和Client的通信，负责数据的读(使用HDFS)。</p>
<h3 id="HBase集群搭建"><a href="#HBase集群搭建" class="headerlink" title="HBase集群搭建"></a>HBase集群搭建</h3><p>&nbsp;&nbsp;如果HDFS是HA集群,需要把HDFS的core-site.xml和hdfs-site.xml copy到conf下。</p>
<h4 id="hbase-env-sh"><a href="#hbase-env-sh" class="headerlink" title="hbase-env.sh"></a>hbase-env.sh</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//告诉hbase使用外部的zookeeper</div><div class="line">export HBASE_MANAGES_ZK=false</div></pre></td></tr></table></figure>
<h4 id="hbase-site-xml"><a href="#hbase-site-xml" class="headerlink" title="hbase-site.xml"></a>hbase-site.xml</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&lt;configuration&gt;</div><div class="line">	&lt;!-- 指定hbase在HDFS上存储的路径 --&gt;</div><div class="line">    &lt;property&gt;</div><div class="line">        &lt;name&gt;hbase.rootdir&lt;/name&gt;</div><div class="line">        &lt;value&gt;hdfs://ns1/hbase&lt;/value&gt;</div><div class="line">    &lt;/property&gt;</div><div class="line">	&lt;!-- 指定hbase是分布式的 --&gt;</div><div class="line">    &lt;property&gt;</div><div class="line">        &lt;name&gt;hbase.cluster.distributed&lt;/name&gt;</div><div class="line">        &lt;value&gt;true&lt;/value&gt;</div><div class="line">    &lt;/property&gt;</div><div class="line">	&lt;!-- 指定zk的地址，多个用“,”分割 --&gt;</div><div class="line">    &lt;property&gt;</div><div class="line">        &lt;name&gt;hbase.zookeeper.quorum&lt;/name&gt;</div><div class="line">        &lt;value&gt;datanode01:2181,datanode02:2181,datanode03:2181&lt;/value&gt;</div><div class="line">    &lt;/property&gt;</div><div class="line">    &lt;property&gt;</div><div class="line">        &lt;name&gt;hbase.master.maxclockskew&lt;/name&gt;</div><div class="line">        &lt;value&gt;180000&lt;/value&gt;</div><div class="line">        &lt;description&gt;Time difference of regionserver from master&lt;/description&gt;</div><div class="line"> 	&lt;/property&gt;</div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure>
<h4 id="regionservers"><a href="#regionservers" class="headerlink" title="regionservers"></a>regionservers</h4><p>&nbsp;&nbsp;配置regionserver的节点,为了尽量实现数据本地化,可以与DataNode在同一个节点上。</p>
<h3 id="HBase常用Shell命令"><a href="#HBase常用Shell命令" class="headerlink" title="HBase常用Shell命令"></a>HBase常用Shell命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div></pre></td><td class="code"><pre><div class="line">进入hbase命令行</div><div class="line">./hbase shell</div><div class="line"></div><div class="line">显示hbase中的表</div><div class="line">list</div><div class="line"></div><div class="line">创建user表，包含info、data两个列族</div><div class="line">create &apos;user&apos;, &apos;info1&apos;, &apos;data1&apos;</div><div class="line">create &apos;user&apos;, &#123;NAME =&gt; &apos;info&apos;, VERSIONS =&gt; &apos;3&apos;&#125;</div><div class="line"></div><div class="line">向user表中插入信息，row key为rk0001，列族info中添加name列标示符，值为zhangsan</div><div class="line">put &apos;user&apos;, &apos;rk0001&apos;, &apos;info:name&apos;, &apos;zhangsan&apos;</div><div class="line"></div><div class="line">向user表中插入信息，row key为rk0001，列族info中添加gender列标示符，值为female</div><div class="line">put &apos;user&apos;, &apos;rk0001&apos;, &apos;info:gender&apos;, &apos;female&apos;</div><div class="line"></div><div class="line">向user表中插入信息，row key为rk0001，列族info中添加age列标示符，值为20</div><div class="line">put &apos;user&apos;, &apos;rk0001&apos;, &apos;info:age&apos;, 20</div><div class="line"></div><div class="line">向user表中插入信息，row key为rk0001，列族data中添加pic列标示符，值为picture</div><div class="line">put &apos;user&apos;, &apos;rk0001&apos;, &apos;data:pic&apos;, &apos;picture&apos;</div><div class="line"></div><div class="line">获取user表中row key为rk0001的所有信息</div><div class="line">get &apos;user&apos;, &apos;rk0001&apos;</div><div class="line"></div><div class="line">获取user表中row key为rk0001，info列族的所有信息</div><div class="line">get &apos;user&apos;, &apos;rk0001&apos;, &apos;info&apos;</div><div class="line"></div><div class="line">获取user表中row key为rk0001，info列族的name、age列标示符的信息</div><div class="line">get &apos;user&apos;, &apos;rk0001&apos;, &apos;info:name&apos;, &apos;info:age&apos;</div><div class="line"></div><div class="line">获取user表中row key为rk0001，info、data列族的信息</div><div class="line">get &apos;user&apos;, &apos;rk0001&apos;, &apos;info&apos;, &apos;data&apos;</div><div class="line">get &apos;user&apos;, &apos;rk0001&apos;, &#123;COLUMN =&gt; [&apos;info&apos;, &apos;data&apos;]&#125;</div><div class="line"></div><div class="line">get &apos;user&apos;, &apos;rk0001&apos;, &#123;COLUMN =&gt; [&apos;info:name&apos;, &apos;data:pic&apos;]&#125;</div><div class="line"></div><div class="line">获取user表中row key为rk0001，列族为info，版本号最新5个的信息</div><div class="line">get &apos;user&apos;, &apos;rk0001&apos;, &#123;COLUMN =&gt; &apos;info&apos;, VERSIONS =&gt; 2&#125;</div><div class="line">get &apos;user&apos;, &apos;rk0001&apos;, &#123;COLUMN =&gt; &apos;info:name&apos;, VERSIONS =&gt; 5&#125;</div><div class="line">get &apos;user&apos;, &apos;rk0001&apos;, &#123;COLUMN =&gt; &apos;info:name&apos;, VERSIONS =&gt; 5, TIMERANGE =&gt; [1392368783980, 1392380169184]&#125;</div><div class="line"></div><div class="line">获取user表中row key为rk0001，cell的值为zhangsan的信息</div><div class="line">get &apos;people&apos;, &apos;rk0001&apos;, &#123;FILTER =&gt; &quot;ValueFilter(=, &apos;binary:图片&apos;)&quot;&#125;</div><div class="line"></div><div class="line">获取user表中row key为rk0001，列标示符中含有a的信息</div><div class="line">get &apos;people&apos;, &apos;rk0001&apos;, &#123;FILTER =&gt; &quot;(QualifierFilter(=,&apos;substring:a&apos;))&quot;&#125;</div><div class="line"></div><div class="line">put &apos;user&apos;, &apos;rk0002&apos;, &apos;info:name&apos;, &apos;fanbingbing&apos;</div><div class="line">put &apos;user&apos;, &apos;rk0002&apos;, &apos;info:gender&apos;, &apos;female&apos;</div><div class="line">put &apos;user&apos;, &apos;rk0002&apos;, &apos;info:nationality&apos;, &apos;中国&apos;</div><div class="line">get &apos;user&apos;, &apos;rk0002&apos;, &#123;FILTER =&gt; &quot;ValueFilter(=, &apos;binary:中国&apos;)&quot;&#125;</div><div class="line"></div><div class="line"></div><div class="line">查询user表中的所有信息</div><div class="line">scan &apos;user&apos;</div><div class="line"></div><div class="line">查询user表中列族为info的信息</div><div class="line">scan &apos;user&apos;, &#123;COLUMNS =&gt; &apos;info&apos;&#125;</div><div class="line">scan &apos;user&apos;, &#123;COLUMNS =&gt; &apos;info&apos;, RAW =&gt; true, VERSIONS =&gt; 5&#125;</div><div class="line">scan &apos;persion&apos;, &#123;COLUMNS =&gt; &apos;info&apos;, RAW =&gt; true, VERSIONS =&gt; 3&#125;</div><div class="line">查询user表中列族为info和data的信息</div><div class="line">scan &apos;user&apos;, &#123;COLUMNS =&gt; [&apos;info&apos;, &apos;data&apos;]&#125;</div><div class="line">scan &apos;user&apos;, &#123;COLUMNS =&gt; [&apos;info:name&apos;, &apos;data:pic&apos;]&#125;</div><div class="line"></div><div class="line"></div><div class="line">查询user表中列族为info、列标示符为name的信息</div><div class="line">scan &apos;user&apos;, &#123;COLUMNS =&gt; &apos;info:name&apos;&#125;</div><div class="line"></div><div class="line">查询user表中列族为info、列标示符为name的信息,并且版本最新的5个</div><div class="line">scan &apos;user&apos;, &#123;COLUMNS =&gt; &apos;info:name&apos;, VERSIONS =&gt; 5&#125;</div><div class="line"></div><div class="line">查询user表中列族为info和data且列标示符中含有a字符的信息</div><div class="line">scan &apos;user&apos;, &#123;COLUMNS =&gt; [&apos;info&apos;, &apos;data&apos;], FILTER =&gt; &quot;(QualifierFilter(=,&apos;substring:a&apos;))&quot;&#125;</div><div class="line"></div><div class="line">查询user表中列族为info，rk范围是[rk0001, rk0003)的数据</div><div class="line">scan &apos;people&apos;, &#123;COLUMNS =&gt; &apos;info&apos;, STARTROW =&gt; &apos;rk0001&apos;, ENDROW =&gt; &apos;rk0003&apos;&#125;</div><div class="line"></div><div class="line">查询user表中row key以rk字符开头的</div><div class="line">scan &apos;user&apos;,&#123;FILTER=&gt;&quot;PrefixFilter(&apos;rk&apos;)&quot;&#125;</div><div class="line"></div><div class="line">查询user表中指定范围的数据</div><div class="line">scan &apos;user&apos;, &#123;TIMERANGE =&gt; [1392368783980, 1392380169184]&#125;</div><div class="line"></div><div class="line">删除数据</div><div class="line">删除user表row key为rk0001，列标示符为info:name的数据</div><div class="line">delete &apos;people&apos;, &apos;rk0001&apos;, &apos;info:name&apos;</div><div class="line">删除user表row key为rk0001，列标示符为info:name，timestamp为1392383705316的数据</div><div class="line">delete &apos;user&apos;, &apos;rk0001&apos;, &apos;info:name&apos;, 1392383705316</div><div class="line"></div><div class="line"></div><div class="line">清空user表中的数据</div><div class="line">truncate &apos;people&apos;</div><div class="line"></div><div class="line"></div><div class="line">修改表结构</div><div class="line">首先停用user表（新版本不用）</div><div class="line">disable &apos;user&apos;</div><div class="line"></div><div class="line">添加两个列族f1和f2</div><div class="line">alter &apos;people&apos;, NAME =&gt; &apos;f1&apos;</div><div class="line">alter &apos;user&apos;, NAME =&gt; &apos;f2&apos;</div><div class="line">启用表</div><div class="line">enable &apos;user&apos;</div><div class="line"></div><div class="line"></div><div class="line">###disable &apos;user&apos;(新版本不用)</div><div class="line">删除一个列族：</div><div class="line">alter &apos;user&apos;, NAME =&gt; &apos;f1&apos;, METHOD =&gt; &apos;delete&apos; 或 alter &apos;user&apos;, &apos;delete&apos; =&gt; &apos;f1&apos;</div><div class="line"></div><div class="line">添加列族f1同时删除列族f2</div><div class="line">alter &apos;user&apos;, &#123;NAME =&gt; &apos;f1&apos;&#125;, &#123;NAME =&gt; &apos;f2&apos;, METHOD =&gt; &apos;delete&apos;&#125;</div><div class="line"></div><div class="line">将user表的f1列族版本号改为5</div><div class="line">alter &apos;people&apos;, NAME =&gt; &apos;info&apos;, VERSIONS =&gt; 5</div><div class="line">启用表</div><div class="line">enable &apos;user&apos;</div><div class="line"></div><div class="line"></div><div class="line">删除表</div><div class="line">disable &apos;user&apos;</div><div class="line">drop &apos;user&apos;</div><div class="line"></div><div class="line"></div><div class="line">get &apos;person&apos;, &apos;rk0001&apos;, &#123;FILTER =&gt; &quot;ValueFilter(=, &apos;binary:中国&apos;)&quot;&#125;</div><div class="line">get &apos;person&apos;, &apos;rk0001&apos;, &#123;FILTER =&gt; &quot;(QualifierFilter(=,&apos;substring:a&apos;))&quot;&#125;</div><div class="line">scan &apos;person&apos;, &#123;COLUMNS =&gt; &apos;info:name&apos;&#125;</div><div class="line">scan &apos;person&apos;, &#123;COLUMNS =&gt; [&apos;info&apos;, &apos;data&apos;], FILTER =&gt; &quot;(QualifierFilter(=,&apos;substring:a&apos;))&quot;&#125;</div><div class="line">scan &apos;person&apos;, &#123;COLUMNS =&gt; &apos;info&apos;, STARTROW =&gt; &apos;rk0001&apos;, ENDROW =&gt; &apos;rk0003&apos;&#125;</div><div class="line"></div><div class="line">scan &apos;person&apos;, &#123;COLUMNS =&gt; &apos;info&apos;, STARTROW =&gt; &apos;20140201&apos;, ENDROW =&gt; &apos;20140301&apos;&#125;</div><div class="line">scan &apos;person&apos;, &#123;COLUMNS =&gt; &apos;info:name&apos;, TIMERANGE =&gt; [1395978233636, 1395987769587]&#125;</div><div class="line">delete &apos;person&apos;, &apos;rk0001&apos;, &apos;info:name&apos;</div><div class="line"></div><div class="line">alter &apos;person&apos;, NAME =&gt; &apos;ffff&apos;</div><div class="line">alter &apos;person&apos;, NAME =&gt; &apos;info&apos;, VERSIONS =&gt; 10</div><div class="line"></div><div class="line"></div><div class="line">get &apos;user&apos;, &apos;rk0002&apos;, &#123;COLUMN =&gt; [&apos;info:name&apos;, &apos;data:pic&apos;]&#125;</div></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://sylvanassun.github.io/2016/07/17/2016-07-17-Hadoop04-HBase/" data-id="cj4z0jkb9000nuomjein2w18q" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hadoop/">Hadoop</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端开发/">后端开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/大数据/">大数据</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016-07-15-Hadoop03-HA" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/15/2016-07-15-Hadoop03-HA/" class="article-date">
  <time datetime="2016-07-15T10:00:00.000Z" itemprop="datePublished">2016-07-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/15/2016-07-15-Hadoop03-HA/">Hadoop学习笔记(3)-HA高可用集群搭建</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://ww4.sinaimg.cn/mw690/63503acbjw1f5w446w8pcj20bp08rweu.jpg" alt=""></p>
<h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>&nbsp;&nbsp;HA(High Available), 高可用性集群，是保证业务连续性的有效解决方案，一般有两个或两个以上的节点，且分为活动节点及备用节点。通常把正在执行业务的称为活动节点，而作为活动节点的一个备份的则称为备用节点。当活动节点出现问题，导致正在运行的业务（任务）不能正常运行时，备用节点此时就会侦测到，并立即接续活动节点来执行业务。从而实现业务的不中断或短暂中断。</p>
<p>&nbsp;&nbsp;在hadoop2.0之前,每个集群只有一个NameNode,如果那台机器坏掉,集群作为一个整体将不可用,所以为了解决这个问题Hadoop2.0引入了HA机制,可以通过在同一集群上配置运行两个冗余的NameNodes，做到主动/被动的热备份。这将允许当一个机器宕机时，快速转移到一个新的NameNode，或管理员进行利用故障转移达到优雅的系统升级的目的。</p>
<p>&nbsp;&nbsp;HA一共有二种解决方案，一种是NFS（Network File System）方式，另外一种是QJM（Quorum Journal Manager）方式。</p>
<h3 id="HA架构"><a href="#HA架构" class="headerlink" title="HA架构"></a>HA架构</h3><p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f5w61d75ixj20p40jidhc.jpg" alt=""></p>
<p>&nbsp;&nbsp;一个典型的HA集群，NameNode会被配置在两台独立的机器上.在任何的时间上，一个NameNode处于活动状态，而另一个在备份状态，活动状态的NameNode会响应集群中所有的客户端，同时备份的只是作为一个副本，保证在必要的时候提供一个快速的转移。</p>
<p>&nbsp;&nbsp;为了使备份的节点和活动的节点保持一致，两个节点通过一个特殊的守护线程相连，这个线程叫做“JournalNodes”（JNs）。当活动状态的节点修改任何的命名空间，他都会通过这些JNs记录日志，备用的节点可以监控edit日志的变化，并且通过JNs读取到变化。备份节点查看edits可以拥有专门的namespace。在故障转移的时候备份节点将在切换至活动状态前确认他从JNs读取到的所有edits。这个确认的目的是为了保证Namespace的状态和迁移之前是完全同步的。</p>
<p>&nbsp;&nbsp;为了提供一个快速的转移，备份NameNode要求保存着最新的block在集群当中的信息。为了能够得到这个，DataNode都被配置了所有的NameNode的地址，并且发送block的地址信息和心跳给两个node。</p>
<p>&nbsp;&nbsp;保证只有一个活跃的NameNode在集群当中是一个十分重要的一步。否则namespace状态在两个节点间不同会导致数据都是或者其他一些不正确的结果。为了确保这个,防止所谓split - brain场景,JournalNodes将只允许一个NameNode进行写操作。故障转移期间,NameNode成为活跃状态的时候会接管JournalNodes的写权限,这会有效防止其他NameNode持续处于活跃状态,允许新的活动节点安全进行故障转移。</p>
<h3 id="搭建HA集群"><a href="#搭建HA集群" class="headerlink" title="搭建HA集群"></a>搭建HA集群</h3><p>&nbsp;&nbsp;hadoop-2.2.0中依然存在一个问题，就是ResourceManager只有一个，存在单点故障，hadoop-2.4.1解决了这个问题，可以有两个ResourceManager，一个是Active，一个是Standby，状态由zookeeper进行协调。</p>
<h4 id="测试集群规划"><a href="#测试集群规划" class="headerlink" title="测试集群规划"></a>测试集群规划</h4><p>&nbsp;&nbsp;实验使用7台虚拟机,规划如下:</p>
<table>
<thead>
<tr>
<th>HostName</th>
<th>IP</th>
<th>Software</th>
<th>Process</th>
</tr>
</thead>
<tbody>
<tr>
<td>datanode01</td>
<td>192.168.145.140</td>
<td>jdk、hadoop、zookeeper</td>
<td>DataNode、NodeManager、JournalNode、QuorumPeerMain</td>
</tr>
<tr>
<td>datanode02</td>
<td>192.168.145.141</td>
<td>jdk、hadoop、zookeeper</td>
<td>DataNode、NodeManager、JournalNode、QuorumPeerMain</td>
</tr>
<tr>
<td>datanode03</td>
<td>192.168.145.142</td>
<td>jdk、hadoop、zookeeper</td>
<td>DataNode、NodeManager、JournalNode、QuorumPeerMain</td>
</tr>
<tr>
<td>namenode01</td>
<td>192.168.145.143</td>
<td>jdk、hadoop</td>
<td>NameNode、DFSZKFailoverController(ZKFC)</td>
</tr>
<tr>
<td>namenode02</td>
<td>192.168.145.144</td>
<td>jdk、hadoop</td>
<td>NameNode、DFSZKFailoverController(ZKFC)</td>
</tr>
<tr>
<td>yarn01</td>
<td>192.168.145.145</td>
<td>jdk、hadoop</td>
<td>ResourceManager</td>
</tr>
<tr>
<td>yarn02</td>
<td>192.168.145.146</td>
<td>jdk、hadoop</td>
<td>ResourceManager</td>
</tr>
</tbody>
</table>
<h4 id="ssh免密登陆"><a href="#ssh免密登陆" class="headerlink" title="ssh免密登陆"></a>ssh免密登陆</h4><ul>
<li>namenode01需要配置所有datanode、yarn、namenode的免密登陆。</li>
<li>namenode02需要配置namenode01的免密登陆。</li>
<li>yarn01需要配置所有nodemanager与resourcemanager的免密登陆。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">#在namenode01上生成密匙</div><div class="line">ssh-keygen</div><div class="line">#namenode01拷贝密匙(包括自己)</div><div class="line">ssh-copy-id namenode01</div><div class="line">ssh-copy-id namenode02</div><div class="line">ssh-copy-id datanode01</div><div class="line">ssh-copy-id datanode02</div><div class="line">ssh-copy-id datanode03</div><div class="line">ssh-copy-id yarn01</div><div class="line">ssh-copy-id yarn02</div><div class="line"></div><div class="line">#在namenode02上生成密匙</div><div class="line">ssh-keygen</div><div class="line">ssh-copy-id namenode01</div><div class="line">ssh-copy-id namenode02</div><div class="line"></div><div class="line">#在yarn01上生成密匙</div><div class="line">ssh-keygen</div><div class="line">#yarn01拷贝密匙</div><div class="line">ssh-copy-id yarn02</div><div class="line">ssh-copy-id datanode01</div><div class="line">ssh-copy-id datanode02</div><div class="line">ssh-copy-id datanode03</div></pre></td></tr></table></figure>
<h4 id="安装zookeeper"><a href="#安装zookeeper" class="headerlink" title="安装zookeeper"></a>安装zookeeper</h4><ol>
<li>解压zookeeper</li>
<li>重命名zookeeper/conf下的zoo_sample.cfg为zoo.cfg : mv zoo_sample.cfg zoo.cfg</li>
<li>在zoo.cfg中修改dataDir=$ZOOKEEPERHOME/data 这个文件需要自己创建<br>例如:dataDir=/home/application/zookeeper-3.4.5/data</li>
<li>在zoo.cfg中最后添加 server.id=ip:2888:3888<br>例如:<pre><code>server.1=datanode01:2888:3888
server.2=datanode02:2888:3888
server.3=datanode03:2888:3888
</code></pre></li>
<li>在$ZOOKEEPERHOME/data目录中创建一个myid文件并写入id。<br>例如: echo 1 &gt;/home/application/zookeeper-3.4.5/data/myid<br>id需要跟zoo.cfg中配置的一致。</li>
</ol>
<h4 id="core-site-xml"><a href="#core-site-xml" class="headerlink" title="core-site.xml"></a>core-site.xml</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&lt;configuration&gt;</div><div class="line">	&lt;!-- 指定hdfs的nameservice为ns1 --&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;fs.defaultFS&lt;/name&gt;</div><div class="line">		&lt;value&gt;hdfs://ns1/&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;!-- 指定hadoop临时目录 --&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;hadoop.tmp.dir&lt;/name&gt;</div><div class="line">		&lt;value&gt;/home/application/hadoop-2.6.0/tmp&lt;/value&gt;</div><div class="line">	&lt;/property&gt;				</div><div class="line">	&lt;!-- 指定zookeeper地址 --&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;ha.zookeeper.quorum&lt;/name&gt;</div><div class="line">		&lt;value&gt;datanode01:2181,datanode02:2181,datanode03:2181&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure>
<h4 id="hdfs-site-xml"><a href="#hdfs-site-xml" class="headerlink" title="hdfs-site.xml"></a>hdfs-site.xml</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">&lt;configuration&gt;</div><div class="line">	&lt;!--指定hdfs的nameservice为ns1，需要和core-site.xml中的保持一致.</div><div class="line">	  这个名字是逻辑名字,可以是任意的,它将被用来配置在集群中作为HDFS的绝对路径组件。--&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;dfs.nameservices&lt;/name&gt;</div><div class="line">		&lt;value&gt;ns1&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;!-- ns1下面有两个NameNode，分别是nn1，nn2 --&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;dfs.ha.namenodes.ns1&lt;/name&gt;</div><div class="line">		&lt;value&gt;nn1,nn2&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;!-- nn1的RPC通信地址 --&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;dfs.namenode.rpc-address.ns1.nn1&lt;/name&gt;</div><div class="line">		&lt;value&gt;namenode01:9000&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;!-- nn1的http通信地址 --&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;dfs.namenode.http-address.ns1.nn1&lt;/name&gt;</div><div class="line">		&lt;value&gt;namenode01:50070&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;!-- nn2的RPC通信地址 --&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;dfs.namenode.rpc-address.ns1.nn2&lt;/name&gt;</div><div class="line">		&lt;value&gt;namenode02:9000&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;!-- nn2的http通信地址 --&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;dfs.namenode.http-address.ns1.nn2&lt;/name&gt;</div><div class="line">		&lt;value&gt;namenode02:50070&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;!-- 指定NameNode的元数据在JournalNode上的存放位置 --&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;dfs.namenode.shared.edits.dir&lt;/name&gt;</div><div class="line">		&lt;value&gt;qjournal://datanode01:8485;datanode02:8485;datanode03:8485/ns1&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;!-- 指定JournalNode在本地磁盘存放数据的位置 --&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;dfs.journalnode.edits.dir&lt;/name&gt;</div><div class="line">		&lt;value&gt;/home/application/hadoop-2.6.0/journaldata&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;!-- 开启NameNode失败自动切换 --&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;dfs.ha.automatic-failover.enabled&lt;/name&gt;</div><div class="line">		&lt;value&gt;true&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;!-- 配置失败自动切换实现方式 --&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;dfs.client.failover.proxy.provider.ns1&lt;/name&gt;</div><div class="line">		&lt;value&gt;org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;!-- 配置隔离机制方法，多个机制用换行分割，即每个机制暂用一行--&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;dfs.ha.fencing.methods&lt;/name&gt;</div><div class="line">		&lt;value&gt;</div><div class="line">			sshfence</div><div class="line">			shell(/bin/true)</div><div class="line">		&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;!-- 使用sshfence隔离机制时需要ssh免登陆 --&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;dfs.ha.fencing.ssh.private-key-files&lt;/name&gt;</div><div class="line">		&lt;value&gt;/root/.ssh/id_rsa&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;!-- 配置sshfence隔离机制超时时间 --&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;dfs.ha.fencing.ssh.connect-timeout&lt;/name&gt;</div><div class="line">		&lt;value&gt;30000&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure>
<h4 id="mapred-site-xml"><a href="#mapred-site-xml" class="headerlink" title="mapred-site.xml"></a>mapred-site.xml</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;configuration&gt;</div><div class="line">	&lt;!-- 指定mr框架为yarn方式 --&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;mapreduce.framework.name&lt;/name&gt;</div><div class="line">		&lt;value&gt;yarn&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure>
<h4 id="yarn-site-xml"><a href="#yarn-site-xml" class="headerlink" title="yarn-site.xml"></a>yarn-site.xml</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">&lt;configuration&gt;</div><div class="line">	&lt;!-- 开启RM高可用 --&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;yarn.resourcemanager.ha.enabled&lt;/name&gt;</div><div class="line">		&lt;value&gt;true&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;!-- 指定RM的cluster id 这是一个逻辑名称,可以是任意的 --&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;yarn.resourcemanager.cluster-id&lt;/name&gt;</div><div class="line">		&lt;value&gt;yarncluster&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;!-- 指定RM的名字 --&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;yarn.resourcemanager.ha.rm-ids&lt;/name&gt;</div><div class="line">		&lt;value&gt;rm1,rm2&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;!-- 分别指定RM的地址 --&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;yarn.resourcemanager.hostname.rm1&lt;/name&gt;</div><div class="line">		&lt;value&gt;yarn01&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;yarn.resourcemanager.hostname.rm2&lt;/name&gt;</div><div class="line">		&lt;value&gt;yarn02&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;!-- 指定zk集群地址 --&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;yarn.resourcemanager.zk-address&lt;/name&gt;</div><div class="line">		&lt;value&gt;datanode01:2181,datanode02:2181,datanode03:2181&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;property&gt;</div><div class="line">		&lt;name&gt;yarn.nodemanager.aux-services&lt;/name&gt;</div><div class="line">		&lt;value&gt;mapreduce_shuffle&lt;/value&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure>
<h4 id="slaves"><a href="#slaves" class="headerlink" title="slaves"></a>slaves</h4><p>&nbsp;&nbsp;slaves指定子节点(DataNode)位置,因为yarn与HDFS分开启动,所以在yarn01中slaves指定的是NodeManager的位置。</p>
<h3 id="启动HA集群"><a href="#启动HA集群" class="headerlink" title="启动HA集群"></a>启动HA集群</h3><ol>
<li>启动zookeeper集群</li>
<li>启动JournalNode,一旦JNs启动，必须进行一次初始化同步在两个HA的NameNode，主要是为了元数据。<br>sbin/hadoop-daemon.sh start journalnode</li>
<li>格式化HDFS。<br>在namenode01上执行命令 hdfs namenode -format<br>格式化后会在根据core-site.xml中的hadoop.tmp.dir配置生成个文件,为了同步元数据,需要将tmp文件夹copy到namenode02上。<br>scp -r tmp/ namenode02:/home/application/hadoop-2.6.0/<br>也可以使用命令 hdfs namenode -bootstrapStandby</li>
<li><p>格式化ZKFC<br>在namenode01上执行命令 hdfs zkfc -formatZK</p>
</li>
<li><p>启动HDFS<br>在namenode01上执行命令 sbin/start-dfs.sh</p>
</li>
<li><p>启动Yarn<br>在yarn01上执行命令 sbin/start-yarn.sh。</p>
</li>
<li><p>因为自带的start-yarn.sh脚本并不会远程启动第二个RM,所以需要在yarn02上单独启动一个RM。<br>在yarn02上执行命令 sbin/yarn-daemon.sh start resourcemanager</p>
</li>
</ol>
<h3 id="管理命令"><a href="#管理命令" class="headerlink" title="管理命令"></a>管理命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Usage: DFSHAAdmin [-ns &lt;nameserviceId&gt;]</div><div class="line">    [-transitionToActive &lt;serviceId&gt;]</div><div class="line">    [-transitionToStandby &lt;serviceId&gt;]</div><div class="line">    [-failover [--forcefence] [--forceactive] &lt;serviceId&gt; &lt;serviceId&gt;]</div><div class="line">    [-getServiceState &lt;serviceId&gt;]</div><div class="line">    [-checkHealth &lt;serviceId&gt;]</div><div class="line">    [-help &lt;command&gt;]</div></pre></td></tr></table></figure>
<p>&nbsp;&nbsp;描述了常用的命令，每个子命令的详细信息你应该运行”hdfs haadmin -help <command>“.</p>
<p><strong>transitionToActive &amp;&amp; transitionToStandby</strong> </p>
<p>&nbsp;&nbsp;切换NameNode的状态（Active或者Standby),这些子命令会使NameNode分别转换状态。</p>
<p><strong>failover</strong></p>
<p>&nbsp;&nbsp;启动两个NameNode之间的故障迁移。</p>
<p>&nbsp;&nbsp;这个子命令会从第一个NameNode迁移到第二个，如果第一个NameNode处于备用状态,这个命令只是没有错误的转换第二个节点到活动状态。如果第一个NameNode处于活跃状态,试图将优雅地转换到备用状态。如果失败,过滤方法(如由dfs.ha.fencing.methods配置)将尝试过滤直到成功。只有在这个过程之后第二个NameNode会转换为活动状态，如果没有过滤方法成功，第二个nameNode将不会活动并返回一个错误。</p>
<p><strong>getServiceState</strong></p>
<p>&nbsp;&nbsp;连接到NameNode，去判断现在的状态打印“standby”或者“active”去标准的输出。这个子命令可以被corn jobs或者是监控脚本使用，为了针对不同状态的NameNode采用不同的行为。</p>
<p><strong>checkHealth</strong></p>
<p>&nbsp;&nbsp;连接NameNode检查健康，NameNode能够执行一些诊断,包括检查如果内部服务正在运行。如果返回0表明NameNode健康，否则返回非0.可以使用此命令用于监测目的。</p>
<p>&nbsp;&nbsp;注意：这个功能实现的不完整，目前除了NameNode完全的关闭，其他全部返回成功。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sylvanassun.github.io/2016/07/15/2016-07-15-Hadoop03-HA/" data-id="cj4z0jkay000iuomjifhiggs3" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hadoop/">Hadoop</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端开发/">后端开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/大数据/">大数据</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016-07-14-Hadoop02-MapReduce" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/14/2016-07-14-Hadoop02-MapReduce/" class="article-date">
  <time datetime="2016-07-14T10:00:00.000Z" itemprop="datePublished">2016-07-14</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/14/2016-07-14-Hadoop02-MapReduce/">Hadoop学习笔记(2)-Mapreduce</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://ww4.sinaimg.cn/mw690/63503acbjw1f5w446w8pcj20bp08rweu.jpg" alt=""></p>
<h3 id="什么是MapReduce"><a href="#什么是MapReduce" class="headerlink" title="什么是MapReduce"></a>什么是MapReduce</h3><p>&nbsp;&nbsp;MapReduce是一种分布式计算模型，由Google提出，主要用于搜索领域，解决海量数据的计算问题。</p>
<p>&nbsp;&nbsp;MapReduce是处理大量半结构化数据集合的编程模型。编程模型是一种处理并结构化特定问题的方式。例如，在一个关系数据库中，使用一种集合语言执行查询，如SQL。告诉语言想要的结果，并将它提交给系统来计算出如何产生计算。还可以用更传统的语言(C++，Java)，一步步地来解决问题。这是两种不同的编程模型，MapReduce就是另外一种。</p>
<p>&nbsp;&nbsp;MapReduce和Hadoop是相互独立的，实际上又能相互配合工作得很好。</p>
<h3 id="Yarn概述"><a href="#Yarn概述" class="headerlink" title="Yarn概述"></a>Yarn概述</h3><p>&nbsp;&nbsp;Yarn是一个分布式的资源管理系统，用以提高分布式的集群环境下的资源利用率，这些资源包括内存、IO、网络、磁盘等。其产生的原因是为了解决原MapReduce框架的不足。最初MapReduce的committer们还可以周期性的在已有的代码上进行修改，可是随着代码的增加以及原MapReduce框架设计的不足，在原MapReduce框架上进行修改变得越来越困难，所以MapReduce的committer们决定从架构上重新设计MapReduce,使下一代的MapReduce(MRv2/Yarn)框架具有更好的扩展性、可用性、可靠性、向后兼容性和更高的资源利用率以及能支持除了MapReduce计算框架外的更多的计算框架。</p>
<h3 id="原MapReduce架构的不足"><a href="#原MapReduce架构的不足" class="headerlink" title="原MapReduce架构的不足"></a>原MapReduce架构的不足</h3><p><img src="http://ww4.sinaimg.cn/mw690/63503acbjw1f5w4495s9rj20sa0foac1.jpg" alt=""></p>
<ul>
<li>JobTracker是集群事务的集中处理点，存在单点故障。</li>
<li>JobTracker需要完成的任务太多，既要维护job的状态又要维护job的task的状态，造成过多的资源消耗。</li>
<li>在taskTracker端，用map/reduce task作为资源的表示过于简单，没有考虑到CPU、内存等资源情况，当把两个需要消耗大内存的task调度到一起，很容易出现OOM(Out Of Memory内存不足)。</li>
<li>把资源强制划分为map/reduce slot,当只有map task时，reduce slot不能用；当只有reduce task时，map slot不能用，容易造成资源利用不足。</li>
</ul>
<h3 id="MRv2-Yarn工作流程"><a href="#MRv2-Yarn工作流程" class="headerlink" title="MRv2/Yarn工作流程"></a>MRv2/Yarn工作流程</h3><h4 id="Yarn架构"><a href="#Yarn架构" class="headerlink" title="Yarn架构"></a>Yarn架构</h4><p>&nbsp;&nbsp;Yarn/MRv2最基本的想法是将原JobTracker主要的资源管理和job调度/监视功能分开作为两个单独的守护进程。</p>
<p>&nbsp;&nbsp;有一个全局的ResourceManager(RM)和每个Application有一个ApplicationMaster(AM)，Application相当于map-reduce job或者DAG jobs。</p>
<p>&nbsp;&nbsp;ResourceManager和NodeManager(NM)组成了基本的数据计算框架。ResourceManager协调集群的资源利用，任何client或者运行着的applicatitonMaster想要运行job或者task都得向RM申请一定的资源。ApplicatonMaster是一个框架特殊的库，对于MapReduce框架而言有它自己的AM实现，用户也可以实现自己的AM，在运行的时候，AM会与NM一起来启动和监视tasks。 </p>
<p><strong>ResourceManager</strong></p>
<p>ResourceManager作为资源的协调者有两个主要的组件：Scheduler和ApplicationsManager(AsM)。</p>
<p>Scheduler负责分配最少但满足application运行所需的资源量给Application。Scheduler只是基于资源的使用情况进行调度，并不负责监视/跟踪application的状态，当然也不会处理失败的task。RM使用resource container概念来管理集群的资源，resource container是资源的抽象，每个container包括一定的内存、IO、网络等资源，不过目前的实现只包括内存一种资源。</p>
<p>ApplicationsManager负责处理client提交的job以及协商第一个container以供applicationMaster运行，并且在applicationMaster失败的时候会重新启动applicationMaster。下面阐述RM具体完成的一些功能。</p>
<ol>
<li>资源调度：Scheduler从所有运行着的application收到资源请求后构建一个全局的资源分配计划，然后根据application特殊的限制以及全局的一些限制条件分配资源。</li>
<li>资源监视：Scheduler会周期性的接收来自NM的资源使用率的监控信息，另外applicationMaster可以从Scheduler得到属于它的已完成的container的状态信息。</li>
<li><p>Application提交：</p>
<ul>
<li>client向AsM获得一个applicationIDclient将application定义以及需要的jar包.</li>
<li>client将application定义以及需要的jar包文件等上传到hdfs的指定目录，由yarn-site.xml的yarn.app.mapreduce.am.staging-dir指定.</li>
<li>client构造资源请求的对象以及application的提交context发送给AsM.</li>
<li>AsM接收application的提交context.</li>
<li>AsM根据application的信息向Scheduler协商一个Container供applicationMaster运行，然后启动applicationMaster.</li>
<li>向该container所属的NM发送launchContainer信息启动该container,也即启动applicationMaster、AsM向client提供运行着的AM的状态信息.</li>
</ul>
</li>
<li><p>AM的生命周期：AsM负责系统中所有AM的生命周期的管理。AsM负责AM的启动，当AM启动后，AM会周期性的向AsM发送heartbeat，默认是1s，AsM据此了解AM的存活情况，并且在AM fail时负责重启AM，若是一定时间过后(默认10分钟)没有收到AM的heartbeat，AsM就认为该AM已经fail。</p>
</li>
</ol>
<p><strong>NodeManager</strong></p>
<p>&nbsp;&nbsp;NM主要负责启动RM分配给AM的container以及代表AM的container，并且会监视container的运行情况。在启动container的时候，NM会设置一些必要的环境变量以及将container运行所需的jar包、文件等从hdfs下载到本地，也就是所谓的资源本地化；当所有准备工作做好后，才会启动代表该container的脚本将程序启动起来。启动起来后，NM会周期性的监视该container运行占用的资源情况，若是超过了该container所声明的资源量，则会kill掉该container所代表的进程。</p>
<p>&nbsp;&nbsp;NM还提供了一个简单的服务以管理它所在机器的本地目录。Applications可以继续访问本地目录即使那台机器上已经没有了属于它的container在运行。例如，Map-Reduce应用程序使用这个服务存储map output并且shuffle它们给相应的reduce task。</p>
<p>&nbsp;&nbsp;NM上还可以扩展自己的服务，yarn提供了一个yarn.nodemanager.aux-services的配置项，通过该配置，用户可以自定义一些服务，例如Map-Reduce的shuffle功能就是采用这种方式实现的。</p>
<p>NM在本地为每个运行着的application生成如下的目录结构：</p>
<p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f5w44b7lxfj208u05dt9v.jpg" alt=""></p>
<p>Container目录下的目录结构如下： </p>
<p><img src="http://ww1.sinaimg.cn/mw690/63503acbjw1f5w44bjrc6j206m05jq3d.jpg" alt=""></p>
<p>&nbsp;&nbsp;在启动一个container的时候，NM就执行该container的default_container_executor.sh，该脚本内部会执行launch_container.sh。launch_container.sh会先设置一些环境变量，最后启动执行程序的命令。对于MapReduce而言，启动AM就执行org.apache.hadoop.mapreduce.v2.app.MRAppMaster；启动map/reduce task就执行org.apache.hadoop.mapred.YarnChild。 </p>
<p><strong>ApplicationMaster</strong></p>
<p>&nbsp;&nbsp;ApplicationMaster是一个框架特殊的库，对于Map-Reduce计算模型而言有它自己的ApplicationMaster实现，对于其他的想要运行在yarn上的计算模型而言，必须得实现针对该计算模型的ApplicationMaster用以向RM申请资源运行task，比如运行在yarn上的spark框架也有对应的ApplicationMaster实现，归根结底，yarn是一个资源管理的框架，并不是一个计算框架，要想在yarn上运行应用程序，还得有特定的计算框架的实现。</p>
<h4 id="工作流程"><a href="#工作流程" class="headerlink" title="工作流程"></a>工作流程</h4><p><img src="http://ww1.sinaimg.cn/mw690/63503acbjw1f5w48pm9byj20ui0kl0uy.jpg" alt=""></p>
<ol>
<li>JobClient向ResourceManager(AsM)申请提交一个job。</li>
<li>RM返回jobId和job提交路径。</li>
<li>JobClient提交job相关的文件。</li>
<li>向RM汇报提交完成。</li>
<li>RM将job写入Job Queue。</li>
<li>NodeManager(NM)向Job Queue领取任务。</li>
<li>ApplicationMaster(AM)启动,向RM进行注册。</li>
<li>RM向AM返回资源信息。</li>
<li>AM启动map。</li>
<li>当所有map任务完成后,AM启动reduce。 </li>
<li>AM监视运行着的task直到完成,当task失败时,申请新的container运行失败的task。</li>
<li>当每个map/reduce task完成后,AM运行MR OutputCommitter的cleanup 代码，进行一些收尾工作。</li>
<li>当所有的map/reduce完成后,AM运行OutputCommitter的必要的job commit或者abort APIs。</li>
<li>AM注销自己。</li>
</ol>
<h3 id="Shuffle过程"><a href="#Shuffle过程" class="headerlink" title="Shuffle过程"></a>Shuffle过程</h3><p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f5w449wf5hj20mv0aodh4.jpg" alt=""></p>
<p><img src="http://ww4.sinaimg.cn/mw690/63503acbjw1f5w44an439j20k10g5mzg.jpg" alt=""></p>
<h4 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h4><ol>
<li><p>每个输入分片会让一个map任务来处理，默认情况下，以HDFS的一个块的大小（默认为64M）为一个分片，当然我们也可以设置块的大小。map输出的结果会暂且放在一个环形内存缓冲区中（该缓冲区的大小默认为100M，由io.sort.mb属性控制），当该缓冲区快要溢出时（默认为缓冲区大小的80%，由io.sort.spill.percent属性控制），会在本地文件系统中创建一个溢出文件，将该缓冲区中的数据写入这个文件。</p>
</li>
<li><p>在写入磁盘之前，线程首先根据reduce任务的数目将数据划分为相同数目的分区，也就是一个reduce任务对应一个分区的数据。这样做是为了避免有些reduce任务分配到大量数据，而有些reduce任务却分到很少数据，甚至没有分到数据的尴尬局面。其实分区就是对数据进行hash的过程。然后对每个分区中的数据进行排序，如果此时设置了Combiner，将排序后的结果进行Combia操作，这样做的目的是让尽可能少的数据写入到磁盘。</p>
</li>
<li><p>当map任务输出最后一个记录时，可能会有很多的溢出文件，这时需要将这些文件合并。合并的过程中会不断地进行排序和combia操作，目的有两个：</p>
<ul>
<li>尽量减少每次写入磁盘的数据量；</li>
<li>尽量减少下一复制阶段网络传输的数据量。最后合并成了一个已分区且已排序的文件。</li>
</ul>
<p>为了减少网络传输的数据量，这里可以将数据压缩，只要将mapred.compress.map.out设置为true就可以了。</p>
</li>
<li><p>将分区中的数据拷贝给相对应的reduce Task。有人可能会问：分区中的数据怎么知道它对应的reduce是哪个呢？其实map任务一直和其父TaskTracker保持联系，而TaskTracker又一直和JobTracker保持心跳。所以JobTracker中保存了整个集群中的宏观信息。只要reduce任务向JobTracker获取对应的map输出位置就ok了哦。</p>
</li>
</ol>
<h4 id="Reduce"><a href="#Reduce" class="headerlink" title="Reduce"></a>Reduce</h4><ol>
<li><p>Reduce会接收到不同map任务传来的数据，并且每个map传来的数据都是有序的。如果reduce端接受的数据量相当小，则直接存储在内存中（缓冲区大小由mapred.job.shuffle.input.buffer.percent属性控制，表示用作此用途的堆空间的百分比），如果数据量超过了该缓冲区大小的一定比例（由mapred.job.shuffle.merge.percent决定），则对数据合并后溢写到磁盘中。</p>
</li>
<li><p>随着溢写文件的增多，后台线程会将它们合并成一个更大的有序的文件，这样做是为了给后面的合并节省时间。其实不管在map端还是reduce端，MapReduce都是反复地执行排序，合并操作。</p>
</li>
<li><p>合并的过程中会产生许多的中间文件（写入磁盘了），但MapReduce会让写入磁盘的数据尽可能地少，并且最后一次合并的结果并没有写入磁盘，而是直接输入到reduce函数。</p>
</li>
</ol>
<h3 id="WordCount案例"><a href="#WordCount案例" class="headerlink" title="WordCount案例"></a>WordCount案例</h3><h4 id="Mapper"><a href="#Mapper" class="headerlink" title="Mapper"></a>Mapper</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWordCountMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">LongWritable</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</div><div class="line">		<span class="comment">// 读取一行的value</span></div><div class="line">		String line = value.toString();</div><div class="line">		<span class="comment">// 按照规则切分</span></div><div class="line">		String[] words = line.split(<span class="string">" "</span>);</div><div class="line">		<span class="comment">// 按照&lt;单词,1&gt;的格式输出</span></div><div class="line">		<span class="keyword">for</span> (String word : words) &#123;</div><div class="line">			context.write(<span class="keyword">new</span> Text(word), <span class="keyword">new</span> LongWritable(<span class="number">1</span>));</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Reducer"><a href="#Reducer" class="headerlink" title="Reducer"></a>Reducer</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWordCountReducer</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>, <span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">LongWritable</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;LongWritable&gt; values, Context context)</span></span></div><div class="line">			<span class="keyword">throws</span> IOException, InterruptedException &#123;</div><div class="line">		<span class="comment">// 初始化计数器</span></div><div class="line">		<span class="keyword">long</span> count = <span class="number">0</span>;</div><div class="line">		<span class="comment">// 迭代values,累加计数器计算出总次数</span></div><div class="line">		<span class="keyword">for</span> (LongWritable value : values) &#123;</div><div class="line">			count += value.get();</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 输出&lt;单词,总次数&gt;</span></div><div class="line">		context.write(key, <span class="keyword">new</span> LongWritable(count));</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Main"><a href="#Main" class="headerlink" title="Main"></a>Main</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyWordCountDriver</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></div><div class="line">	    <span class="keyword">throws</span> IOException, ClassNotFoundException, InterruptedException &#123;</div><div class="line">		Configuration conf = <span class="keyword">new</span> Configuration();</div><div class="line">		<span class="comment">// 构造一个job对象</span></div><div class="line">		Job wordCountJob = Job.getInstance(conf);</div><div class="line"></div><div class="line">		<span class="comment">// 指定job用到的jar包位置,这里使用当前类</span></div><div class="line">		wordCountJob.setJarByClass(MyWordCountDriver.class);</div><div class="line"></div><div class="line">		<span class="comment">// 指定mapper</span></div><div class="line">		wordCountJob.setMapperClass(MyWordCountMapper.class);</div><div class="line">		<span class="comment">// 指定reducer</span></div><div class="line">		wordCountJob.setReducerClass(MyWordCountReducer.class);</div><div class="line"></div><div class="line">		<span class="comment">// 指定mapper输出key/value的类型</span></div><div class="line">		wordCountJob.setMapOutputKeyClass(Text.class);</div><div class="line">		wordCountJob.setMapOutputValueClass(LongWritable.class);</div><div class="line"></div><div class="line">		<span class="comment">// 指定reducer输出key/value的类型</span></div><div class="line">		wordCountJob.setOutputKeyClass(Text.class);</div><div class="line">		wordCountJob.setOutputValueClass(LongWritable.class);</div><div class="line"></div><div class="line">		<span class="comment">// 指定输入数据的路径</span></div><div class="line">		FileInputFormat.setInputPaths(wordCountJob, <span class="keyword">new</span> Path(args[<span class="number">0</span>]));</div><div class="line">		<span class="comment">// 指定输出结果的路径</span></div><div class="line">		FileOutputFormat.setOutputPath(wordCountJob, <span class="keyword">new</span> Path(args[<span class="number">1</span>]));</div><div class="line">		<span class="comment">// 通过yarn客户端进行提交,参数2为是否打印到控制台</span></div><div class="line">		wordCountJob.waitForCompletion(<span class="keyword">true</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="启动MapReduce"><a href="#启动MapReduce" class="headerlink" title="启动MapReduce"></a>启动MapReduce</h4><p>&nbsp;&nbsp;<strong>方式1:</strong> 将程序打成jar包,上传到hadoop中执行。hadoop jar <jar> [mainClass] args…</jar></p>
<p>&nbsp;&nbsp;<strong>方式2:</strong> 将程序打成jar包,在本地IDE上直接运行(需要代码指定jar)。</p>
<h3 id="自定义Sort"><a href="#自定义Sort" class="headerlink" title="自定义Sort"></a>自定义Sort</h3><h4 id="bean"><a href="#bean" class="headerlink" title="bean"></a>bean</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowBean</span> <span class="keyword">implements</span> <span class="title">WritableComparable</span>&lt;<span class="title">FlowBean</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> Long upFlow;</div><div class="line">	<span class="keyword">private</span> Long downFlow;</div><div class="line">	<span class="keyword">private</span> Long sumFlow;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAll</span><span class="params">(Long upFlow, Long downFlow)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.upFlow = upFlow;</div><div class="line">		<span class="keyword">this</span>.downFlow = downFlow;</div><div class="line">		<span class="keyword">this</span>.sumFlow = upFlow + downFlow;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Long <span class="title">getUpFlow</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> upFlow;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUpFlow</span><span class="params">(Long upFlow)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.upFlow = upFlow;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Long <span class="title">getDownFlow</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> downFlow;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDownFlow</span><span class="params">(Long downFlow)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.downFlow = downFlow;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> Long <span class="title">getSumFlow</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> sumFlow;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSumFlow</span><span class="params">(Long sumFlow)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.sumFlow = sumFlow;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"FlowBean [upFlow="</span> + upFlow + <span class="string">", downFlow="</span> + downFlow</div><div class="line">				+ <span class="string">", sumFlow="</span> + sumFlow + <span class="string">"]"</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 序列化</div><div class="line">	 */</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutput out)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		out.writeLong(upFlow);</div><div class="line">		out.writeLong(downFlow);</div><div class="line">		out.writeLong(sumFlow);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 反序列化</div><div class="line">	 */</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFields</span><span class="params">(DataInput in)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		upFlow = in.readLong();</div><div class="line">		downFlow = in.readLong();</div><div class="line">		sumFlow = in.readLong();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 降序排序 -1 大于 0 等于 1小于</div><div class="line">	 */</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(FlowBean o)</span> </span>&#123;</div><div class="line">		<span class="comment">// 如果当前类的总和大于其他类的总和 则返回-1(大于) false 1(小于)</span></div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.sumFlow &gt; o.getSumFlow() ? -<span class="number">1</span> : <span class="number">1</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="main"><a href="#main" class="headerlink" title="main"></a>main</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowSummarySort</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 因为只有key才能进行排序,所以输出key为FlowBean</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@author</span> sylvanasp</div><div class="line">	 * <span class="doctag">@version</span> 1.0</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowSummarySortMapper</span></span></div><div class="line">			<span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">FlowBean</span>, <span class="title">Text</span>&gt; &#123;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span></span></div><div class="line">				<span class="keyword">throws</span> IOException, InterruptedException &#123;</div><div class="line">			String line = value.toString();</div><div class="line">			String[] fields = StringUtils.split(line, <span class="string">"\t"</span>);</div><div class="line">			String phoneNum = fields[<span class="number">0</span>];</div><div class="line">			Long upFlow = Long.parseLong(fields[<span class="number">1</span>]);</div><div class="line">			Long downFlow = Long.parseLong(fields[<span class="number">2</span>]);</div><div class="line"></div><div class="line">			FlowBean flowBean = <span class="keyword">new</span> FlowBean();</div><div class="line">			flowBean.setAll(upFlow, downFlow);</div><div class="line">			context.write(flowBean, <span class="keyword">new</span> Text(phoneNum));</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 因为在mapper中已经完成了排序,所以reducer中需要将phoneNum重新设置为key</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@author</span> sylvanasp</div><div class="line">	 * <span class="doctag">@version</span> 1.0</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowSummarySortReducer</span></span></div><div class="line">			<span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">FlowBean</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">FlowBean</span>&gt; &#123;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(FlowBean bean, Iterable&lt;Text&gt; phoneNum,</span></span></div><div class="line">				Context context) <span class="keyword">throws</span> IOException, InterruptedException &#123;</div><div class="line">			<span class="comment">// 因为每个bean都是完全独立的,所以Iterable中只有一个数据</span></div><div class="line">			<span class="keyword">for</span> (Text phoneNumKey : phoneNum) &#123;</div><div class="line">				context.write(phoneNumKey, bean);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		Configuration conf = <span class="keyword">new</span> Configuration();</div><div class="line">		Job job = Job.getInstance(conf);</div><div class="line">		job.setJarByClass(FlowSummarySort.class);</div><div class="line">		job.setMapperClass(FlowSummarySortMapper.class);</div><div class="line">		job.setReducerClass(FlowSummarySortReducer.class);</div><div class="line"></div><div class="line">		job.setMapOutputKeyClass(FlowBean.class);</div><div class="line">		job.setMapOutputValueClass(Text.class);</div><div class="line"></div><div class="line">		job.setOutputKeyClass(Text.class);</div><div class="line">		job.setOutputValueClass(FlowBean.class);</div><div class="line"></div><div class="line">		FileInputFormat.setInputPaths(job, <span class="keyword">new</span> Path(args[<span class="number">0</span>]));</div><div class="line">		FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(args[<span class="number">1</span>]));</div><div class="line"></div><div class="line">		<span class="keyword">int</span> result = job.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>;</div><div class="line">		System.exit(result);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="自定义Partition"><a href="#自定义Partition" class="headerlink" title="自定义Partition"></a>自定义Partition</h3><h4 id="partitioner"><a href="#partitioner" class="headerlink" title="partitioner"></a>partitioner</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyPartitioner</span> <span class="keyword">extends</span> <span class="title">Partitioner</span>&lt;<span class="title">Text</span>, <span class="title">FlowBean</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">// 使用map模拟数据库</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> HashMap&lt;String, Integer&gt; map = <span class="keyword">new</span> HashMap&lt;String, Integer&gt;();</div><div class="line"></div><div class="line">	<span class="comment">// 初始化分区规则</span></div><div class="line">	<span class="keyword">static</span> &#123;</div><div class="line">		map.put(<span class="string">"136"</span>, <span class="number">0</span>);</div><div class="line">		map.put(<span class="string">"137"</span>, <span class="number">1</span>);</div><div class="line">		map.put(<span class="string">"138"</span>, <span class="number">2</span>);</div><div class="line">		map.put(<span class="string">"139"</span>, <span class="number">3</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPartition</span><span class="params">(Text key, FlowBean value, <span class="keyword">int</span> numPartitions)</span> </span>&#123;</div><div class="line">		<span class="comment">// 获取手机号前3位</span></div><div class="line">		String phonePrefix = key.toString().substring(<span class="number">0</span>, <span class="number">3</span>);</div><div class="line">		<span class="comment">// 根据手机号前缀获得对应的分区编号</span></div><div class="line">		Integer partitionId = map.get(phonePrefix);</div><div class="line">		<span class="comment">// 如果手机号不在分区规则内,则分配到分区4。</span></div><div class="line">		<span class="keyword">return</span> partitionId == <span class="keyword">null</span> ? <span class="number">4</span> : partitionId;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="main-1"><a href="#main-1" class="headerlink" title="main"></a>main</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowSummaryPartition</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowSummaryPartitionMapper</span></span></div><div class="line">			<span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">FlowBean</span>&gt; &#123;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(LongWritable key, Text value, Context context)</span></span></div><div class="line">				<span class="keyword">throws</span> IOException, InterruptedException &#123;</div><div class="line">			String line = value.toString();</div><div class="line">			String[] fields = StringUtils.split(line, <span class="string">"\t"</span>);</div><div class="line"></div><div class="line">			String phoneNum = fields[<span class="number">1</span>];</div><div class="line">			Long upFlow = Long.parseLong(fields[fields.length - <span class="number">3</span>]);</div><div class="line">			Long downFlow = Long.parseLong(fields[fields.length - <span class="number">2</span>]);</div><div class="line"></div><div class="line">			FlowBean flowBean = <span class="keyword">new</span> FlowBean();</div><div class="line">			flowBean.setAll(upFlow, downFlow);</div><div class="line">			context.write(<span class="keyword">new</span> Text(phoneNum), flowBean);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowSummaryPartitionReducer</span></span></div><div class="line">			<span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>, <span class="title">FlowBean</span>, <span class="title">Text</span>, <span class="title">FlowBean</span>&gt; &#123;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;FlowBean&gt; beans,</span></span></div><div class="line">				Context context) <span class="keyword">throws</span> IOException, InterruptedException &#123;</div><div class="line">			<span class="keyword">long</span> upSum = <span class="number">0</span>;</div><div class="line">			<span class="keyword">long</span> downSum = <span class="number">0</span>;</div><div class="line"></div><div class="line">			<span class="keyword">for</span> (FlowBean bean : beans) &#123;</div><div class="line">				upSum += bean.getUpFlow();</div><div class="line">				downSum += bean.getDownFlow();</div><div class="line">			&#125;</div><div class="line">			FlowBean flowBean = <span class="keyword">new</span> FlowBean();</div><div class="line">			flowBean.setAll(upSum, downSum);</div><div class="line">			context.write(key, flowBean);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		Configuration conf = <span class="keyword">new</span> Configuration();</div><div class="line">		Job job = Job.getInstance(conf);</div><div class="line"></div><div class="line">		job.setJarByClass(FlowSummaryPartition.class);</div><div class="line">		job.setMapperClass(FlowSummaryPartitionMapper.class);</div><div class="line">		job.setReducerClass(FlowSummaryPartitionReducer.class);</div><div class="line"></div><div class="line">		job.setOutputKeyClass(Text.class);</div><div class="line">		job.setOutputValueClass(FlowBean.class);</div><div class="line"></div><div class="line">		<span class="comment">// 设置分区器</span></div><div class="line">		job.setPartitionerClass(MyPartitioner.class);</div><div class="line">		<span class="comment">// 设置Reducer Task 实例数量 (与分区数一致)</span></div><div class="line">		job.setNumReduceTasks(<span class="number">5</span>);</div><div class="line"></div><div class="line">		FileInputFormat.setInputPaths(job, <span class="keyword">new</span> Path(args[<span class="number">0</span>]));</div><div class="line">		FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(args[<span class="number">1</span>]));</div><div class="line"></div><div class="line">		<span class="keyword">int</span> result = job.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>;</div><div class="line">		System.exit(result);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="END"><a href="#END" class="headerlink" title="END"></a>END</h3><blockquote>
<p>部分资料来源于<a href="http://blog.sina.com.cn/s/blog_829a682d0101lc9d.html&amp;http://weixiaolu.iteye.com/blog/1474172" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_829a682d0101lc9d.html&amp;http://weixiaolu.iteye.com/blog/1474172</a></p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sylvanassun.github.io/2016/07/14/2016-07-14-Hadoop02-MapReduce/" data-id="cj4z0jkb6000muomj69qpgd87" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hadoop/">Hadoop</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端开发/">后端开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/大数据/">大数据</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/2/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/2017/">2017</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ActiveMQ/">ActiveMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hadoop/">Hadoop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HashMap/">HashMap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/">JVM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Lucene/">Lucene</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyBatis/">MyBatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyCat/">MyCat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringMVC/">SpringMVC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/solr/">solr</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/全文检索引擎/">全文检索引擎</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/后端开发/">后端开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多线程/">多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/大数据/">大数据</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库/">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构/">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/符号表/">符号表</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编程思想/">编程思想</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/2017/" style="font-size: 17.78px;">2017</a> <a href="/tags/ActiveMQ/" style="font-size: 10px;">ActiveMQ</a> <a href="/tags/Hadoop/" style="font-size: 14.44px;">Hadoop</a> <a href="/tags/HashMap/" style="font-size: 10px;">HashMap</a> <a href="/tags/JVM/" style="font-size: 12.22px;">JVM</a> <a href="/tags/Java/" style="font-size: 18.89px;">Java</a> <a href="/tags/Lucene/" style="font-size: 10px;">Lucene</a> <a href="/tags/MyBatis/" style="font-size: 12.22px;">MyBatis</a> <a href="/tags/MyCat/" style="font-size: 10px;">MyCat</a> <a href="/tags/Nginx/" style="font-size: 10px;">Nginx</a> <a href="/tags/Spring/" style="font-size: 15.56px;">Spring</a> <a href="/tags/SpringMVC/" style="font-size: 11.11px;">SpringMVC</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/solr/" style="font-size: 10px;">solr</a> <a href="/tags/全文检索引擎/" style="font-size: 11.11px;">全文检索引擎</a> <a href="/tags/后端开发/" style="font-size: 20px;">后端开发</a> <a href="/tags/多线程/" style="font-size: 10px;">多线程</a> <a href="/tags/大数据/" style="font-size: 14.44px;">大数据</a> <a href="/tags/数据库/" style="font-size: 10px;">数据库</a> <a href="/tags/数据结构/" style="font-size: 16.67px;">数据结构</a> <a href="/tags/符号表/" style="font-size: 13.33px;">符号表</a> <a href="/tags/算法/" style="font-size: 13.33px;">算法</a> <a href="/tags/编程思想/" style="font-size: 10px;">编程思想</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/06/27/2017-06-27-DynamicProgramming/">什么是动态规划?</a>
          </li>
        
          <li>
            <a href="/2017/06/16/2017-06-16-RedBlackTree/">红黑树那点事儿</a>
          </li>
        
          <li>
            <a href="/2017/06/14/2017-06-14-sort_algorithms_qucikSort/">深入浅出排序算法(3)-快速排序</a>
          </li>
        
          <li>
            <a href="/2017/06/12/2017-06-12-sort_algorithmes_mergeSort/">深入浅出排序算法(2)-归并排序</a>
          </li>
        
          <li>
            <a href="/2017/06/09/2017-06-09-sort_algorithms_heapSort/">深入浅出排序算法(1)-堆排序</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 SylvanasSun<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>