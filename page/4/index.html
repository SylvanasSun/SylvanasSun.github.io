<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>SylvanasSun Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="这里是SylvanasSun的个人博客,与你一起发现更大的世界。">
<meta property="og:type" content="website">
<meta property="og:title" content="SylvanasSun Blog">
<meta property="og:url" content="https://sylvanassun.github.io/page/4/index.html">
<meta property="og:site_name" content="SylvanasSun Blog">
<meta property="og:description" content="这里是SylvanasSun的个人博客,与你一起发现更大的世界。">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SylvanasSun Blog">
<meta name="twitter:description" content="这里是SylvanasSun的个人博客,与你一起发现更大的世界。">
  
    <link rel="alternate" href="/atom.xml" title="SylvanasSun Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">SylvanasSun Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">SylvanasSun的博客 | SylvanasSun Blog</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://sylvanassun.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-2016-07-12-Hadoop-HDFS" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/12/2016-07-12-Hadoop-HDFS/" class="article-date">
  <time datetime="2016-07-12T10:00:00.000Z" itemprop="datePublished">2016-07-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/12/2016-07-12-Hadoop-HDFS/">Hadoop学习笔记(1)-HDFS</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://ww4.sinaimg.cn/mw690/63503acbjw1f5w446w8pcj20bp08rweu.jpg" alt=""></p>
<h3 id="Hadoop概述"><a href="#Hadoop概述" class="headerlink" title="Hadoop概述"></a>Hadoop概述</h3><p>Hadoop是一个由Apache基金会所开发的分布式系统基础架构。</p>
<p><img src="http://ww4.sinaimg.cn/mw690/63503acbjw1f5w4478njsj20as05wwep.jpg" alt=""></p>
<p>&nbsp;&nbsp;Hadoop 由许多元素构成。其最底部是 Hadoop Distributed File System（HDFS），它存储 Hadoop 集群中所有存储节点上的文件。HDFS的上一层是MapReduce 引擎，该引擎由 JobTrackers 和 TaskTrackers 组成。</p>
<p><strong>HDFS</strong></p>
<p>&nbsp;&nbsp;对外部客户机而言，HDFS就像一个传统的分级文件系统。可以创建、删除、移动或重命名文件，等等。但是 HDFS 的架构是基于一组特定的节点构建的，这是由它自身的特点决定的。这些节点包括 NameNode（仅一个），它在 HDFS 内部提供元数据服务；DataNode，它为 HDFS 提供存储块。由于仅存在一个 NameNode，因此这是 HDFS 的一个缺点（单点失败）。</p>
<p>&nbsp;&nbsp;存储在 HDFS 中的文件被分成块，然后将这些块复制到多个计算机中（DataNode）。这与传统的 RAID 架构大不相同。块的大小（通常为 64MB）和复制的块数量在创建文件时由客户机决定。NameNode 可以控制所有文件操作。HDFS 内部的所有通信都基于标准的 TCP/IP 协议。</p>
<p>&nbsp;&nbsp;HDFS和现有的分布式文件系统有很多共同点。但同时，它和其他的分布式文件系统的区别也是很明显的。HDFS是一个高度容错性的系统，适合部署在廉价的机器上。HDFS能提供高吞吐量的数据访问，非常适合大规模数据集上的应用。HDFS放宽了一部分POSIX约束，来实现流式读取文件系统数据的目的。HDFS在最开始是作为Apache Nutch搜索引擎项目的基础架构而开发的。HDFS是Apache Hadoop Core项目的一部分。</p>
<p><strong>NameNode</strong></p>
<p>&nbsp;&nbsp;NameNode 是一个通常在HDFS实例中的单独机器上运行的软件。它负责管理文件系统名称空间和控制外部客户机的访问。NameNode 决定是否将文件映射到 DataNode 上的复制块上。对于最常见的 3 个复制块，第一个复制块存储在同一机架的不同节点上，最后一个复制块存储在不同机架的某个节点上。</p>
<p>&nbsp;&nbsp;实际的 I/O事务并没有经过 NameNode，只有表示 DataNode 和块的文件映射的元数据经过 NameNode。当外部客户机发送请求要求创建文件时，NameNode 会以块标识和该块的第一个副本的 DataNode IP 地址作为响应。这个 NameNode 还会通知其他将要接收该块的副本的 DataNode。</p>
<p>&nbsp;&nbsp;NameNode 在一个称为FsImage的文件中存储所有关于文件系统名称空间的信息。这个文件和一个包含所有事务的记录文件（这里是 EditLog）将存储在 NameNode 的本地文件系统上。FsImage 和 EditLog 文件也需要复制副本，以防文件损坏或 NameNode 系统丢失。</p>
<p>&nbsp;&nbsp;NameNode本身不可避免地具有SPOF（Single Point Of Failure）单点失效的风险，主备模式并不能解决这个问题，通过Hadoop Non-stop namenode才能实现100% uptime可用时间。</p>
<p><strong>DataNode</strong></p>
<p>&nbsp;&nbsp;DataNode 也是一个通常在 HDFS实例中的单独机器上运行的软件。Hadoop 集群包含一个 NameNode 和大量 DataNode。DataNode通常以机架的形式组织，机架通过一个交换机将所有系统连接起来。Hadoop 的一个假设是：机架内部节点之间的传输速度快于机架间节点的传输速度。</p>
<p>&nbsp;&nbsp;DataNode 响应来自 HDFS 客户机的读写请求。它们还响应来自 NameNode 的创建、删除和复制块的命令。NameNode 依赖来自每个 DataNode 的定期心跳（heartbeat）消息。每条消息都包含一个块报告，NameNode 可以根据这个报告验证块映射和其他文件系统元数据。如果 DataNode 不能发送心跳消息，NameNode 将采取修复措施，重新复制在该节点上丢失的块。</p>
<h3 id="HDFS体系结构"><a href="#HDFS体系结构" class="headerlink" title="HDFS体系结构"></a>HDFS体系结构</h3><p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f5w447vawzj20hq0aptar.jpg" alt=""></p>
<ul>
<li><strong>NameNode</strong>:唯一的master节点,管理HDFS的名称空间和数据块映射信息、配置副本策略和处理客户端请求。</li>
<li><strong>Secondary NameNode</strong>:辅助NameNode，分担NameNode工作，定期合并fsimage和edits并推送给NameNode，紧急情况下可辅助恢复NameNode。</li>
<li><strong>DataNode</strong>:Slave节点，实际存储数据、执行数据块的读写并汇报存储信息给NameNode。</li>
<li><strong>FSImage</strong>:元数据镜像文件。</li>
<li><strong>Edits</strong>:元数据的操作日志。</li>
</ul>
<h3 id="HDFSWriteOperation"><a href="#HDFSWriteOperation" class="headerlink" title="HDFSWriteOperation"></a>HDFSWriteOperation</h3><p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f5w48p90chj20k20bzdgr.jpg" alt=""></p>
<p>&nbsp;&nbsp;在分布式文件系统中，需要确保数据的一致性。对于HDFS来说，直到所有要保存数据的DataNodes确认它们都有文件的副本时，数据才被认为写入完成。因此，数据一致性是在写的阶段完成的。一个客户端无论选择从哪个DataNode读取，都将得到相同的数据。</p>
<ol>
<li>客户端请求NameNode,表示写入文件。</li>
<li>NameNode响应客户端,并告诉客户端将文件保存到DataNodeA、B、D。</li>
<li>客户端连接DataNodeA写入文件,DataNode集群内完成复制。</li>
<li>DataNodeA将文件副本发送给DataNodeB。</li>
<li>DataNodeB将文件副本发送给DataNodeD。</li>
<li>DataNodeD返回确认消息给DataNodeB。</li>
<li>DataNodeB返回确认消息给DataNodeA。</li>
<li>DataNodeA返回确认消息给客户端,写入完成。</li>
</ol>
<p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f5w448fsbnj20gn0a6acc.jpg" alt=""></p>
<ol>
<li>Client调用DistributedFileSystem的create()函数创建新文件。</li>
<li>DistributedFileSystem使用RPC调用NameNode创建一个没有block关联的新文件,NameNode在创建之前将进行校验,如果校验通过,NameNode则创建一个新文件并记录一条记录,否则抛出IO异常。</li>
<li>前两步成功后,将会返回一个DFSOutputStream对象,DFSOutputStream可以协调NameNode与DataNode,当客户端写入数据到DFSOutputStream,DFSOutputStream会将数据分割为一个一个Packet(数据包),并写入数据队列。</li>
<li>DataStreamer处理数据队列,它会先去询问NameNode存储到哪几个DataNode,例如Replication为3,则会去找到3个最适合的DataNode。DataStreamer会将DataNode排成一个Pipeline,它会将Packet按队列输出到管道中的第一个DataNode,第一个DataNode又会把Packet输出到第二个DataNode,直到最后一个DataNode。</li>
<li>DataStreamer中还有一个Ack Queue,Ack Queue之中也含有Packet。Ack Queue负责接收DataNode的确认响应,当Pipeline中的所有DataNode都确认完毕后,Ack Queue将移除对应的Packet。</li>
<li>Client完成数据写入,关闭流。</li>
<li>DataStreamer等待Ack Queue信息,当收到最后一个信息时,通知NameNode把文件标记为完成。</li>
</ol>
<h3 id="HDFSReadOperation"><a href="#HDFSReadOperation" class="headerlink" title="HDFSReadOperation"></a>HDFSReadOperation</h3><p><img src="http://ww4.sinaimg.cn/mw690/63503acbjw1f5w48ovukqj20jm0ermy3.jpg" alt=""></p>
<ol>
<li>客户端请求NameNode,表示读取文件。</li>
<li>NameNode响应客户端,将block(数据块)的信息发送给客户端。</li>
<li>客户端检查数据块信息,连接相关的DataNode。</li>
<li>DataNodeA将block1发送给客户端。</li>
<li>DataNodeB将block2发送给客户端。</li>
<li>拼接数据,读取完成。</li>
</ol>
<p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f5w4486azhj20g209adi1.jpg" alt=""></p>
<ol>
<li>Client调用FileSystem的open()函数打开希望读取的文件。</li>
<li>DistributedFileSystem使用RPC调用NameNode确定文件起始块的位置，同一Block按照重复数会返回多个位置，这些位置按照Hadoop集群拓扑结构排序，距离客户端近的排在前面。</li>
<li>前两步成功后,将会返回一个DFSInputStream对象,DFSInputStream可以协调NameNode与DataNode。客户端对DFSInputStream输入流调用read()函数。</li>
<li>DFSInputStream连接距离最近的DataNode，通过对数据流反复调用read()函数，可以将数据从DataNode传输到客户端。</li>
<li>当到达Block的末端时，DFSInputStream会关闭与该DataNode的连接，然后寻找下一个Block的最佳DataNode，这些操作对客户端来说是透明的。</li>
<li>客户端完成读取，对FSDataInputStream调用close()关闭文件读取。</li>
</ol>
<h3 id="HDFSShell命令"><a href="#HDFSShell命令" class="headerlink" title="HDFSShell命令"></a>HDFSShell命令</h3><p>&nbsp;&nbsp;既然 HDFS 是存取数据的分布式文件系统，那么对 HDFS 的操作，就是文件系统的基本 操作，比如文件的创建、修改、删除、修改权限等，文件夹的创建、删除、重命名等。对 HDFS 的操作命令类似于 Linux 的 shell 对文件的操作，如 ls、mkdir、rm 等。 我们执行以下操作的时候，一定要确定 hadoop 是正常运行的，使用 jps 命令确保看到 各个 hadoop 进程。 </p>
<table>
<thead>
<tr>
<th>命令名</th>
<th>格式</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>-ls</td>
<td>-ls&lt;路径&gt;</td>
<td>查看指定路径的当前目录结构</td>
</tr>
<tr>
<td>-lsr</td>
<td>-lsr&lt;路径&gt;</td>
<td>递归查看指定路径的目录结构</td>
</tr>
<tr>
<td>-du</td>
<td>-du&lt;路径&gt;</td>
<td>统计目录下个文件大小</td>
</tr>
<tr>
<td>-dus</td>
<td>-dus&lt;路径&gt;</td>
<td>汇总统计目录下文件(夹)大小</td>
</tr>
<tr>
<td>-count</td>
<td>-count[-q]&lt;路径&gt;</td>
<td>统计文件(夹)数量</td>
</tr>
<tr>
<td>-mv</td>
<td>-mv&lt;源路径&gt;&lt;目的路径&gt;</td>
<td>移动</td>
</tr>
<tr>
<td>-cp</td>
<td>-cp&lt;源路径&gt;&lt;目的路径&gt;</td>
<td>复制</td>
</tr>
<tr>
<td>-rm</td>
<td>-rm[-skipTrash]&lt;路径&gt;</td>
<td>删除文件/空白文件夹</td>
</tr>
<tr>
<td>-rmr</td>
<td>-rmr[-skipTrash]&lt;路径&gt;</td>
<td>递归删除</td>
</tr>
<tr>
<td>-put</td>
<td>-put&lt;多个 linux 上的文件&gt;<hdfs 路径=""></hdfs></td>
<td>上传文件</td>
</tr>
<tr>
<td>-copyFromLocal</td>
<td>-copyFromLocal&lt;多个 linux 上的文件&gt; <hdfs 路径=""></hdfs></td>
<td>从本地复制</td>
</tr>
<tr>
<td>-moveFromLocal</td>
<td>-moveFromLocal&lt;多个 linux 上的文件&gt; <hdfs 路径=""></hdfs></td>
<td>从本地移动</td>
</tr>
<tr>
<td>-getmerge</td>
<td>-getmerge&lt;源路径&gt;<linux 路径=""></linux></td>
<td>合并到本地</td>
</tr>
<tr>
<td>-cat</td>
<td>-cat<hdfs 路径=""></hdfs></td>
<td>查看文件内容</td>
</tr>
<tr>
<td>-text</td>
<td>-text<hdfs 路径=""></hdfs></td>
<td>查看文件内容</td>
</tr>
<tr>
<td>-copyToLocal</td>
<td>-copyToLocal[-ignoreCrc][-crc][hdfs 源路 径][linux 目的路径]</td>
<td>复制到本地</td>
</tr>
<tr>
<td>-moveToLocal</td>
<td>-moveToLocal[-crc]<hdfs 源路径=""><linux 目的路径=""></linux></hdfs></td>
<td>移动到本地</td>
</tr>
<tr>
<td>-mkdir</td>
<td>-mkdir<hdfs 路径=""></hdfs></td>
<td>创建空白文件夹</td>
</tr>
<tr>
<td>-setrep</td>
<td>-setrep[-R][-w]&lt;副本数&gt;&lt;路径&gt;</td>
<td>修改副本数量</td>
</tr>
<tr>
<td>-touchz</td>
<td>-touchz&lt;文件路径&gt;</td>
<td>创建空白文件</td>
</tr>
<tr>
<td>-stat</td>
<td>-stat[format]&lt;路径&gt;</td>
<td>显示文件统计信息</td>
</tr>
<tr>
<td>-tail</td>
<td>-tail[-f]&lt;文件&gt;</td>
<td>查看文件尾部信息</td>
</tr>
<tr>
<td>-chmod</td>
<td>-chmod[-R]&lt;权限模式&gt;[路径]</td>
<td>修改权限</td>
</tr>
<tr>
<td>-chown</td>
<td>-chown[-R][属主][:[属组]] 路径</td>
<td>修改属主</td>
</tr>
<tr>
<td>-chgrp</td>
<td>-chgrp[-R] 属组名称 路径</td>
<td>修改属组</td>
</tr>
<tr>
<td>-help</td>
<td>-help[命令选项]</td>
<td>帮助</td>
</tr>
</tbody>
</table>
<h3 id="使用JAVA操作HDFS"><a href="#使用JAVA操作HDFS" class="headerlink" title="使用JAVA操作HDFS"></a>使用JAVA操作HDFS</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HdfsTest</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> Configuration conf = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">private</span> FileSystem fs = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">private</span> FSDataInputStream DFSInputStream = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 初始化FlieSystem</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@throws</span> IOException</div><div class="line">	 * <span class="doctag">@throws</span> InterruptedException</div><div class="line">	 */</div><div class="line">	<span class="meta">@Before</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</div><div class="line">		conf = <span class="keyword">new</span> Configuration();</div><div class="line">		conf.set(<span class="string">"fs.defaultFS"</span>, <span class="string">"hdfs://192.168.145.145:9000"</span>);</div><div class="line">		fs = fs.get(URI.create(<span class="string">"hdfs://192.168.145.145:9000"</span>), conf, <span class="string">"root"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 读取文件</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@throws</span> IOException</div><div class="line">	 * <span class="doctag">@throws</span> IllegalArgumentException</div><div class="line">	 */</div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReadAsOpen</span><span class="params">()</span> <span class="keyword">throws</span> IllegalArgumentException, IOException </span>&#123;</div><div class="line">		Path path = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			path = <span class="keyword">new</span> Path(<span class="string">"/test"</span>);</div><div class="line">			<span class="keyword">if</span> (fs.exists(path)) &#123;</div><div class="line">				DFSInputStream = fs.open(path);</div><div class="line">				IOUtils.copyBytes(DFSInputStream, System.out, conf);</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			IOUtils.closeStream(DFSInputStream);</div><div class="line">			fs.close();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 上传本地文件</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@throws</span> IOException</div><div class="line">	 */</div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUpload</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		Path src = <span class="keyword">null</span>;</div><div class="line">		Path dst = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			src = <span class="keyword">new</span> Path(<span class="string">"f:/saber_by_wlop-d8tjwa5.jpg"</span>);<span class="comment">// 原路径</span></div><div class="line">			dst = <span class="keyword">new</span> Path(<span class="string">"/saber.jpg"</span>);<span class="comment">// 目标路径</span></div><div class="line">			<span class="comment">// 参数1为是否删除原文件,true为删除,默认为false</span></div><div class="line">			fs.copyFromLocalFile(<span class="keyword">false</span>, src, dst);</div><div class="line">			<span class="comment">// 打印文件路径</span></div><div class="line">			System.out.println(<span class="string">"Upload to "</span> + conf.get(<span class="string">"fs.default.name"</span>));</div><div class="line">			System.out.println(<span class="string">"----------------------------------------"</span>);</div><div class="line">			FileStatus[] fileStatus = fs.listStatus(dst);</div><div class="line">			<span class="keyword">for</span> (FileStatus file : fileStatus) &#123;</div><div class="line">				System.out.println(file.getPath());</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			fs.close();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 下载文件</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@throws</span> IOException</div><div class="line">	 */</div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDownload</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		Path src = <span class="keyword">null</span>;</div><div class="line">		Path dst = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="keyword">if</span> (fs.exists(src)) &#123;</div><div class="line">				src = <span class="keyword">new</span> Path(<span class="string">"/saber.jpg"</span>);</div><div class="line">				dst = <span class="keyword">new</span> Path(<span class="string">"D:/temp/"</span>);</div><div class="line">				fs.copyToLocalFile(<span class="keyword">false</span>, src, dst);</div><div class="line">				<span class="comment">// 打印文件路径</span></div><div class="line">				System.out.println(<span class="string">"Download from "</span> + conf.get(<span class="string">"fs.default.name"</span>));</div><div class="line">				System.out.println(<span class="string">"--------------------------------------------"</span>);</div><div class="line">				<span class="comment">// 迭代路径,参数2为是否递归迭代</span></div><div class="line">				RemoteIterator&lt;LocatedFileStatus&gt; iterator = fs.listFiles(src, <span class="keyword">true</span>);</div><div class="line">				<span class="keyword">while</span> (iterator.hasNext()) &#123;</div><div class="line">					LocatedFileStatus fileStatus = iterator.next();</div><div class="line">					System.out.println(fileStatus.getPath());</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			fs.close();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 创建目录</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@throws</span> IOException</div><div class="line">	 */</div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testMkdir</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		Path path = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			path = <span class="keyword">new</span> Path(<span class="string">"/create01"</span>);</div><div class="line">			<span class="comment">// 判断目录是否已存在</span></div><div class="line">			<span class="keyword">boolean</span> exists = fs.exists(path);</div><div class="line">			<span class="keyword">if</span> (!exists) &#123;</div><div class="line">				<span class="comment">// 创建目录</span></div><div class="line">				<span class="keyword">boolean</span> mkdirs = fs.mkdirs(path);</div><div class="line">				<span class="keyword">if</span> (mkdirs) &#123;</div><div class="line">					System.out.println(<span class="string">"create dir success!"</span>);</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					System.out.println(<span class="string">"create dir failure!"</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			fs.close();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 重命名文件</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@throws</span> IOException</div><div class="line">	 */</div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRename</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		Path oldPath = <span class="keyword">null</span>;</div><div class="line">		Path newPath = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			oldPath = <span class="keyword">new</span> Path(<span class="string">"/saber.jpg"</span>);</div><div class="line">			newPath = <span class="keyword">new</span> Path(<span class="string">"/saber01.jpg"</span>);</div><div class="line">			<span class="keyword">if</span> (fs.exists(oldPath)) &#123;</div><div class="line">				<span class="keyword">boolean</span> rename = fs.rename(oldPath, newPath);</div><div class="line">				<span class="keyword">if</span> (rename) &#123;</div><div class="line">					System.out.println(<span class="string">"rename success!"</span>);</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					System.out.println(<span class="string">"rename failure!"</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			fs.close();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 删除文件</div><div class="line">	 * </div><div class="line">	 * <span class="doctag">@throws</span> IOException</div><div class="line">	 */</div><div class="line">	<span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDelete</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">		Path path = <span class="keyword">null</span>;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			path = <span class="keyword">new</span> Path(<span class="string">"/saber01.jpg"</span>);</div><div class="line">			<span class="keyword">if</span> (fs.exists(path)) &#123;</div><div class="line">				<span class="keyword">boolean</span> delete = fs.deleteOnExit(path);</div><div class="line">				<span class="keyword">if</span> (delete) &#123;</div><div class="line">					System.out.println(<span class="string">"delete success!"</span>);</div><div class="line">				&#125; <span class="keyword">else</span> &#123;</div><div class="line">					System.out.println(<span class="string">"delete failure!"</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			fs.close();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sylvanassun.github.io/2016/07/12/2016-07-12-Hadoop-HDFS/" data-id="cj4z0jkaw000fuomjiqa7oct9" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Hadoop/">Hadoop</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端开发/">后端开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/大数据/">大数据</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016-07-09-MyCat" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/09/2016-07-09-MyCat/" class="article-date">
  <time datetime="2016-07-09T10:00:00.000Z" itemprop="datePublished">2016-07-09</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/09/2016-07-09-MyCat/">MyCat快速入门</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://ww4.sinaimg.cn/mw690/63503acbjw1f67ok1ytybj207s05674d.jpg" alt=""></p>
<h3 id="MyCat概述"><a href="#MyCat概述" class="headerlink" title="MyCat概述"></a>MyCat概述</h3><p> &nbsp;&nbsp;MyCat是基于Cobar二次开发的数据库中间件。它可以低成本的将现有的单机数据库和应用平滑迁移到“云”端，解决数据存储和业务规模迅速增长情况下的数据瓶颈问题。</p>
<p>&nbsp;&nbsp;从定义和分类来看，它是一个开源的分布式数据库系统，是一个实现了MySQL协议的的Server，前端用户可以把 它看作是一个数据库代理，用MySQL客户端工具和命令行访问，而其后端可以用MySQL原生（Native）协议与多个MySQL服务 器通信，也可以用JDBC协议与大多数主流数据库服务器通信，其核心功能是分表分库，即将一个大表水平分割为N个小表，存储 在后端MySQL服务器里或者其他数据库里。</p>
<p>&nbsp;&nbsp;Mycat发展到目前的版本，已经不是一个单纯的MySQL代理了，它的后端可以支持MySQL、SQL Server、Oracle、DB2、 PostgreSQL等主流数据库，也支持MongoDB这种新型NoSQL方式的存储，未来还会支持更多类型的存储。而在最终用户看 来，无论是那种存储方式，在Mycat里，都是一个传统的数据库表，支持标准的SQL语句进行数据的操作，这样一来，对前端业 务系统来说，可以大幅降低开发难度，提升开发速度，在测试阶段，可以将一个表定义为任何一种Mycat支持的存储方式，比如 MySQL的MyASIM表、内存表、或者MongoDB、LevelDB以及号称是世界上最快的内存数据库MemSQL上。试想一下，用户表 存放在MemSQL上，大量读频率远超过写频率的数据如订单的快照数据存放于InnoDB中，一些日志数据存放于MongoDB中， 而且还能把Oracle的表跟MySQL的表做关联查询，你是否有一种不能呼吸的感觉？而未来，还能通过Mycat自动将一些计算分析 后的数据灌入到Hadoop中，并能用Mycat+Storm/Spark Stream引擎做大规模数据分析，看到这里，你大概明白了，Mycat是 什么？Mycat就是BigSQL，Big Data On SQL Database。</p>
<h3 id="MyCat特点"><a href="#MyCat特点" class="headerlink" title="MyCat特点"></a>MyCat特点</h3><ul>
<li>支持SQL92标准。</li>
<li>支持Mysql集群,可以作为Proxy使用。</li>
<li>支持JDBC连接ORACLE、DB2、SQL Server。</li>
<li>支持galera for mysql集群，percona-cluster或者mariadb cluster，提供高可用性数据分片集群。</li>
<li>支持自动故障切换,实现高可用。</li>
<li>支持读写分离,Mysql双主多从,以及一主多从模式。</li>
<li>支持全局表。</li>
<li>支持独有的基于E-R关系分片策略,实现了高效的表关联查询。</li>
<li>支持多平台,部署简单。</li>
</ul>
<h3 id="MyCat原理"><a href="#MyCat原理" class="headerlink" title="MyCat原理"></a>MyCat原理</h3><p>&nbsp;&nbsp;Mycat的原理中最重要的一个动词是“拦截”，它拦截了用户发送过来的SQL语句，首先对SQL语句做了一些特定的分析：如分片分析、路由分析、读写分离分析、缓存分析等，然后将此SQL发往后端的真实数据库，并将返回的结果做适当的处理，最终再返回给用户。</p>
<p><img src="http://ww4.sinaimg.cn/mw690/63503acbjw1f67ok1abxhj20td0g0jtk.jpg" alt=""></p>
<h3 id="分片策略"><a href="#分片策略" class="headerlink" title="分片策略"></a>分片策略</h3><p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f67ok1sk3wj20fv0c40ui.jpg" alt=""></p>
<p>MyCat支持横向分片与纵向分片。</p>
<ul>
<li><strong>横向分片</strong>:一个表的数据分割到多个节点上,按照行分隔。</li>
<li><strong>纵向分片</strong>:一个数据库中有多个表A、B、C,A存储到节点1,B存储到节点2,C存储到节点3。</li>
</ul>
<p>MyCat通过定义表的分片规则来实现分片,每个表可以捆绑一个分片规则,每个分片规则指定一个分片字段并绑定一个函数,实现动态分片算法。</p>
<ol>
<li><strong>schema</strong>:逻辑库,一个逻辑库中定义了所包含的Table。</li>
<li><p><strong>table</strong></p>
<p><strong>逻辑表</strong>:既然有逻辑库，那么就会有逻辑表，分布式数据库中，对应用来说，读写数据的表就是逻辑表。逻辑表，可以是数据切分后，分布在一个或多个分片库中，也可以不做数据切分，不分片，只有一个表构成。</p>
<p><strong>分片表</strong>:指那些原有的很大数据的表，需要切分到多个数据库的表，这样，每个分片都有一部分数据，所有分片构成了完整的 数据。</p>
<p>例如在mycat配置中的t_node就属于分片表，数据按照规则被分到dn1,dn2两个分片节点(dataNode)上。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;table name=&quot;t_node&quot; primaryKey=&quot;vid&quot; autoIncrement=&quot;true&quot; dataNode=&quot;dn1,dn2&quot; rule=&quot;rule1&quot; /&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>**非分片表**:如果一个数据库中并不是所有的表都有很大的数据,某些表是可以不用进行切分的,
非分片表是相对于分片表来说的,就是不需要进行数据切分的表。

例如下面配置的t_node,只存在于一个分片节点dn1上。

<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;table name=&quot;t_node&quot; primaryKey=&quot;vid&quot; autoIncrement=&quot;true&quot; dataNode=&quot;dn1&quot; /</div></pre></td></tr></table></figure>


**ER表**:关系型数据库是基于实体关系模型(Entity-RelationshipModel)之上的,通过其描述了真实世界中的事物与关系。MyCat提出了基于E-R关系的数据分片策略,子表的记录与所关联的父表记录存放在同一个数据分片中,即子表依赖于父表,通过表分组(TableGroup)保证数据Join不会跨库操作。

**全局表**:一个真实的业务系统中，往往存在大量的类似字典表的表，这些表基本上很少变动，字典表具有以下几个特性： 

- 变动不频繁。
- 数据量总体变化不大。
- 数据规模不大。

对于这类的表，在分片的情况下，当业务表因为规模而进行分片以后，业务表与这些附属的字典表之间的关联，就成了比较棘手的问题，所以Mycat中通过数据冗余来解决这类表的join，即所有的分片都有一份数据的拷贝，所有将字典表或者符合字典表特 性的一些表定义为全局表。
</code></pre><ol>
<li><p><strong>dataNode</strong>:分片节点。数据切分后,一个大表被切分到不同的分片数据库上面,每个表分片所在的数据库就是分片节点。</p>
</li>
<li><p><strong>dataHost</strong>:节点主机。数据切分后，每个分片节点（dataNode）不一定都会独占一台机器，同一机器上面可以有多个分片数据库，这样一个或多个分片节点（dataNode）所在的机器就是节点主机（dataHost）,为了规避单节点主机并发数限制，尽量将读写压力高的分片节点 （dataNode）均衡的放在不同的节点主机（dataHost）.</p>
</li>
<li><p><strong>rule</strong>:分片规则。按照某种业务规则把数据分到某个分片的规则就是分片规则,数据切分选择合适的分片规则非常重要,将极大的避免后续数据处理的难度。</p>
</li>
<li><p><strong>sequence</strong>:全局序列号。数据切分后，原有的关系数据库中的主键约束在分布式条件下将无法使用，因此需要引入外部机制保证数据唯一性标识，这种保证全局性的数据唯一标识的机制就是全局序列号（sequence）。</p>
</li>
</ol>
<h3 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h3><p>&amp;&nbsp;&nbsp;MyCat是是使用JAVA语言开发的,所以需要先安装JAVA运行环境,并且要求JDK版本在1.7以上。</p>
<h4 id="1-环境准备"><a href="#1-环境准备" class="headerlink" title="1.环境准备"></a>1.环境准备</h4><p>JDK下载地址:<a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk7-downloads-1880260.html" target="_blank" rel="external">http://www.oracle.com/technetwork/java/javase/downloads/jdk7-downloads-1880260.html</a></p>
<p>MySQL下载地址:<a href="http://dev.mysql.com/downloads/mysql/5.5.html#downloads" target="_blank" rel="external">http://dev.mysql.com/downloads/mysql/5.5.html#downloads</a></p>
<p>MyCat下载地址:<a href="https://github.com/MyCATApache/Mycat-download" target="_blank" rel="external">https://github.com/MyCATApache/Mycat-download</a></p>
<h4 id="2-MyCat的安装"><a href="#2-MyCat的安装" class="headerlink" title="2.MyCat的安装"></a>2.MyCat的安装</h4><ol>
<li>将下载的MyCat压缩包上传到linux服务器。</li>
<li>解压缩MyCat压缩包。</li>
</ol>
<h4 id="3-MyCat目录结构"><a href="#3-MyCat目录结构" class="headerlink" title="3.MyCat目录结构"></a>3.MyCat目录结构</h4><p><img src="http://ww1.sinaimg.cn/mw690/63503acbjw1f67ok0u4qqj20j002wmyh.jpg" alt=""></p>
<p><strong>bin程序目录</strong> 存放了window版本和linux版本，除了提供封装成服务的版本之外，也提供了nowrap的shell脚本命令，方便大 家选择和修改，进入到bin目录： </p>
<ul>
<li>Windows下运行：运行: mycat.bat console 在控制台启动程序，也可以装载成服务，若此程序运行有问题，也可以运行 startup_nowrap.bat，确保java命令可以在命令执行.</li>
<li>Windows下将MyCAT做成系统服务：MyCAT提供warp方式的命令，可以将MyCAT安装成系统服务并可启动和停止。 <ul>
<li>进入bin目录下执行命令 mycat install 执行安装mycat服务. </li>
<li>输入 mycat start 启动mycat服务.</li>
</ul>
</li>
</ul>
<p><strong>conf目录</strong>存放配置文件，server.xml是Mycat服务器参数调整和用户授权的配置文件，schema.xml是逻辑库定义和表以及分片定义的配置文件，rule.xml是分片规则的配置文件，分片规则的具体一些参数信息单独存放为文件，也在这个目录下，配置文件修改，需要重启Mycat或者通过9066端口reload.</p>
<p><strong>lib目录</strong>主要存放mycat依赖的一些jar文件.</p>
<p>日志存放在logs/mycat.log中，每天一个文件，日志的配置是在conf/log4j.xml中，根据自己的需要，可以调整输出级别为 debug，debug级别下，会输出更多的信息，方便排查问题.</p>
<h4 id="4-服务启动"><a href="#4-服务启动" class="headerlink" title="4.服务启动"></a>4.服务启动</h4><p> MyCAT在Linux中部署启动时，首先需要在Linux系统的环境变量中配置MYCAT_HOME,操作方式如下： </p>
<ol>
<li>vi /etc/profile,在系统环境变量文件中增加 MYCAT_HOME=/usr/local/Mycat </li>
<li>执行 source /etc/profile 命令，使环境变量生效。</li>
</ol>
<p>如果是在多台linux系统中组建的MyCat集群,则需要在MyCat Server所在的服务器上配置对其他Ip和主机名的映射。</p>
<ol>
<li>vi /etc/hosts</li>
<li>例如<br>192.168.145.1 test_1<br>192.168.145.2 test_2</li>
</ol>
<p>配置完毕后,可以cd到/usr/local/mycat/bin目录下执行 ./mycat start 启动服务。<br><strong>注:MyCat的默认服务端口为8066.</strong></p>
<h3 id="MyCat切分数据"><a href="#MyCat切分数据" class="headerlink" title="MyCat切分数据"></a>MyCat切分数据</h3><h4 id="1-配置schema-xml"><a href="#1-配置schema-xml" class="headerlink" title="1.配置schema.xml"></a>1.配置schema.xml</h4><p>Schema.xml作为MyCat中重要的配置文件之一，管理着MyCat的逻辑库、表、分片规则、DataNode以及DataSource。弄懂这些配置，是正确使用MyCat的前提。这里就一层层对该文件进行解析。</p>
<p><strong>schema标签</strong></p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>值</th>
<th>数量限制</th>
</tr>
</thead>
<tbody>
<tr>
<td>dataNode</td>
<td>String</td>
<td>0..1</td>
</tr>
<tr>
<td>checkSQLschema</td>
<td>Boolean</td>
<td>1</td>
</tr>
<tr>
<td>sqlMaxLimit</td>
<td>Integer</td>
<td>1</td>
</tr>
</tbody>
</table>
<ul>
<li>dataNode<br>该属性用于绑定逻辑库到某个具体的database上，如果定义了这个属性，那么这个逻辑库就不能工作在分库分表模式下了。也就是说对这个逻辑库的所有操作会直接作用到绑定的dataNode上，这个schema就可以用作读写分离和主从切换，具体如下配置:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;schema name=&quot;USERDB&quot; checkSQLschema=&quot;false&quot; sqlMaxLimit=&quot;100&quot; dataNode=&quot;dn1&quot;&gt;    </div><div class="line">&lt;!—这里不能配置任何逻辑表信息--&gt; </div><div class="line">&lt;/schema&gt;</div></pre></td></tr></table></figure>
<p> 那么现在USERDB就绑定到dn1所配置的具体database上，可以直接访问这个database。当然该属性只能配置绑定到一个 database上，不能绑定多个dn。</p>
<ul>
<li><p>checkSQLschema<br>当该值设置为 true 时，如果我们执行语句<strong>select * from TESTDB.travelrecord;</strong>则MyCat会把语句修改为<strong>select * from travelrecord;</strong>。即把表示schema的字符去掉，避免发送到后端数据库执行时报（ERROR 1146 (42S02): Table ‘testdb.travelrecord’ doesn’t exist）。 不过，即使设置该值为 true ，如果语句所带的是并非是schema指定的名字，例如：<strong>select * from db1.travelrecord;</strong> 那么 MyCat并不会删除db1这个字段，如果没有定义该库的话则会报错，所以在提供SQL语句的最好是不带这个字段。</p>
</li>
<li><p>sqlMaxLimit<br>当该值设置为某个数值时。每条执行的SQL语句，如果没有加上limit语句，MyCat也会自动的加上所对应的值。例如设置值为 100，执行select <em> fromTESTDB.travelrecord;的效果为和执行select </em> from TESTDB.travelrecord limit 100;相同。 不设置该值的话，MyCat默认会把查询到的信息全部都展示出来，造成过多的输出。所以，在正常使用中，还是建议加上一个 值，用于减少过多的数据返回。<br>当然SQL语句中也显式的指定limit的大小，不受该属性的约束。<br>需要注意的是，如果运行的schema为非拆分库的，那么该属性不会生效。需要手动添加limit语句。</p>
</li>
</ul>
<p>&nbsp;&nbsp;schema 标签用于定义MyCat实例中的逻辑库，MyCat可以有多个逻辑库，每个逻辑库都有自己的相关配置。可以使用 schema 标 签来划分这些不同的逻辑库。</p>
<p>如果不配置 schema 标签，所有的表配置，会属于同一个默认的逻辑库。</p>
<p>注意：若是LINUX版本的MYSQL，则需要设置为Mysql大小写不敏感，否则可能会发生表找不到的问题。<br>在MySQL的配置文件中my.ini [mysqld] 中增加一行<br>　　lower_case_table_names = 1</p>
<p><strong>table标签</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;table name=&quot;travelrecord&quot; dataNode=&quot;dn1,dn2,dn3&quot; rule=&quot;auto-sharding-long&quot; &gt;&lt;/table&gt;</div></pre></td></tr></table></figure>
<p>Table 标签定义了MyCat中的逻辑表，所有需要拆分的表都需要在这个标签中定义。</p>
<p><strong>name属性</strong></p>
<p>逻辑表的表名,同个schema标签中定义的名字必须唯一。</p>
<p><strong>dataNode属性</strong></p>
<p>定义这个逻辑表所属的dataNode,该属性的值需要和dataNode标签中name属性的值相互对应。如果需要定义的dn过多可以使 用如下的方法减少配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;table name=&quot;travelrecord&quot; dataNode=&quot;multipleDn$0-99,multipleDn2$100-199&quot; rule=&quot;auto-sharding-long&quot; &gt;</div><div class="line">&lt;/table&gt;</div><div class="line"></div><div class="line">&lt;dataNode name=&quot;multipleDn&quot; dataHost=&quot;localhost1&quot; database=&quot;db$0-99&quot; &gt;&lt;/dataNode&gt;</div><div class="line">&lt;dataNode name=&quot;multipleDn2&quot; dataHost=&quot;localhost1&quot; database=&quot; db$0-99&quot; &gt;&lt;/dataNode&gt;</div><div class="line"></div><div class="line">这里需要注意的是database属性所指定的真实database name需要在后面添加一个，例如上面的例子中，我需要在真实的mysql 上建立名称为dbs0到dbs99的database。</div></pre></td></tr></table></figure>
<p><strong>rule属性</strong></p>
<p>该属性用于指定逻辑表要使用的规则名字，规则名字在rule.xml中定义，必须与tableRule标签中name属性属性值一一对应。</p>
<p><strong>ruleRequired属性</strong></p>
<p>该属性用于指定表是否绑定分片规则，如果配置为true，但没有配置具体rule的话 ，程序会报错。</p>
<p><strong>primaryKey属性</strong></p>
<p>该逻辑表对应真实表的主键，例如：分片的规则是使用非主键进行分片的，那么在使用主键查询的时候，就会发送查询语句到所有配置的DN上，如果使用该属性配置真实表的主键。<br>那么MyCat会缓存主键与具体DN的信息，那么再次使用非主键进行查询的 时候就不会进行广播式的查询，就会直接发送语句给具体的DN，但是尽管配置该属性，如果缓存并没有命中的话，还是会发送语 句给具体的DN，来获得数据。</p>
<p><strong>type属性</strong></p>
<p>该属性定义了逻辑表的类型，目前逻辑表只有“全局表”和”普通表”两种类型。对应的配置：</p>
<ul>
<li>全局表 global</li>
<li>普通表 不指定该值为global的所有表。</li>
</ul>
<p><strong>autoIncrement属性</strong></p>
<p>mysql对非自增长主键，使用last_insert_id()是不会返回结果的，只会返回0。所以，只有定义了自增长主键的表才可以用 last_insert_id()返回主键值。</p>
<p>mycat目前提供了自增长主键功能，但是如果对应的mysql节点上数据表，没有定义auto_increment，那么在mycat层调用 last_insert_id()也是不会返回结果的。</p>
<p>由于insert操作的时候没有带入分片键，mycat会先取下这个表对应的全局序列，然后赋值给分片键。这样才能正常的插入到数据 库中，最后使用last_insert_id()才会返回插入的分片键值。</p>
<p>如果要使用这个功能最好配合使用数据库模式的全局序列。</p>
<p>使用autoIncrement=“true”指定这个表有使用自增长主键，这样mycat才会不抛出分片键找不到的异常。<br>使用autoIncrement=“false”来禁用这个功能，当然你也可以直接删除掉这个属性。默认就是禁用的。</p>
<p><strong>needAddLimit属性</strong></p>
<p>指定表是否需要自动的在每个语句后面加上limit限制。由于使用了分库分表，数据量有时会特别巨大。这时候执行查询语句，如果恰巧又忘记了加上数量限制的话。那么查询所有的数据出来，也够等上一小会儿的。 所以，mycat就自动的为我们加上LIMIT 100。当然，如果语句中有limit，就不会在次添加了。</p>
<p>这个属性默认为true,你也可以设置成false`禁用掉默认行为。</p>
<p><strong>childTable标签</strong></p>
<p>childTable标签用于定义E-R分片的子表。通过标签上的属性与父表进行关联。</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>值</th>
<th>数量限制</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>String</td>
<td>1</td>
<td>定义子表的表名。</td>
</tr>
<tr>
<td>joinKey</td>
<td>String</td>
<td>1</td>
<td>插入子表的时候会使用这个列的值查找父表存储的数据节点。</td>
</tr>
<tr>
<td>parentKey</td>
<td>String</td>
<td>1</td>
<td>属性指定的值一般为与父表建立关联关系的列名。程序首先获取joinkey的值，再通过<strong>parentKey</strong>属性指定的列名产生查询语 句，通过执行该语句得到父表存储在哪个分片上。从而确定子表存储的位置。</td>
</tr>
<tr>
<td>primaryKey</td>
<td>String</td>
<td>0..1</td>
<td>同table标签所描述的。</td>
</tr>
<tr>
<td>needAddLimit</td>
<td>Boolean</td>
<td>0..1</td>
<td>同table标签所描述的。</td>
</tr>
</tbody>
</table>
<p><strong>dataNode标签</strong></p>
<p>dataNode 标签定义了MyCat中的数据节点，也就是我们通常说所的数据分片。一个<strong>dataNode</strong> 标签就是一个独立的数据分 片。 </p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>值</th>
<th>数量限制</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>String</td>
<td>1</td>
<td>定义数据节点的名字，这个名字需要是唯一的，我们需要在table标签上应用这个名字，来建立表与分片对应的关系。</td>
</tr>
<tr>
<td>dataHost</td>
<td>String</td>
<td>1</td>
<td>该属性用于定义该分片属于哪个数据库实例的，属性值是引用dataHost标签上定义的name属性。</td>
</tr>
<tr>
<td>database</td>
<td>String</td>
<td>1</td>
<td>该属性用于定义该分片属性哪个具体数据库实例上的具体库，因为这里使用两个纬度来定义分片，就是：实例+具体的库。因为 每个库上建立的表和表结构是一样的。所以这样做就可以轻松的对表进行水平拆分。</td>
</tr>
</tbody>
</table>
<p><strong>dataHost标签</strong></p>
<p>作为Schema.xml中最后的一个标签，该标签在mycat逻辑库中也是作为最底层的标签存在，直接定义了具体的数据库实例、读 写分离配置和心跳语句。</p>
<p><strong>name属性</strong></p>
<p>唯一标识dataHost标签，供上层的标签使用。</p>
<p><strong>maxCon属性</strong></p>
<p>指定每个读写实例连接池的最大连接。也就是说，标签内嵌套的writeHost、readHost标签都会使用这个属性的值来实例化出连接池的最大连接数。</p>
<p><strong>minCon属性</strong></p>
<p>指定每个读写实例连接池的最小连接，初始化连接池的大小。</p>
<p><strong>balance属性</strong></p>
<p>负载均衡类型，目前的取值有3种：</p>
<ol>
<li>balance=“0”, 所有读操作都发送到当前可用的writeHost上。 </li>
<li>balance=“1”，所有读操作都随机的发送到readHost。 </li>
<li>balance=“2”，所有读操作都随机的在writeHost、readhost上分发。</li>
</ol>
<p><strong>writeType属性</strong></p>
<p>负载均衡类型，目前的取值有3种： </p>
<ol>
<li>writeType=“0”, 所有写操作都发送到可用的writeHost上。 </li>
<li>writeType=“1”，所有写操作都随机的发送到readHost。 </li>
<li>writeType=“2”，所有写操作都随机的在writeHost、readhost分上发。</li>
</ol>
<p><strong>dbType属性</strong></p>
<p>指定后端连接的数据库类型，目前支持二进制的mysql协议，还有其他使用JDBC连接的数据库。例如：mongodb、oracle、 spark等。</p>
<p><strong>dbDriver属性</strong></p>
<p>指定连接后端数据库使用的Driver，目前可选的值有native和JDBC。使用native的话，因为这个值执行的是二进制的mysql协 议，所以可以使用mysql和maridb。其他类型的数据库则需要使用JDBC驱动来支持。<br>如果使用JDBC的话需要将符合JDBC 4标准的驱动JAR包放到MYCAT\lib目录下，并检查驱动JAR包中包括如下目录结构的文 件：META-INF\services\java.sql.Driver。在这个文件内写上具体的Driver类名，例如：com.mysql.jdbc.Driver。</p>
<p><strong>heartbeat标签</strong></p>
<p>这个标签内指明用于和后端数据库进行心跳检查的语句。例如,MYSQL可以使用select user()，Oracle可以使用select 1 from dual等。<br>这个标签还有一个connectionInitSql属性，主要是当使用Oracla数据库时，需要执行的初始化SQL语句就这个放到这里面来。例 如：alter session set nls_date_format=’yyyy-mm-dd hh24:miss’</p>
<p><strong>writeHost标签、readHost标签</strong></p>
<p>这两个标签都指定后端数据库的相关配置给mycat，用于实例化后端连接池。唯一不同的是，writeHost指定写实例、readHost 指定读实例，组着这些读写实例来满足系统的要求。</p>
<p>在一个dataHost内可以定义多个writeHost和readHost。但是，如果writeHost指定的后端数据库宕机，那么这个writeHost绑 定的所有readHost都将不可用。另一方面，由于这个writeHost宕机系统会自动的检测到，并切换到备用的writeHost上去。</p>
<p>这两个标签的属性相同，这里就一起介绍。</p>
<table>
<thead>
<tr>
<th>属性名</th>
<th>值</th>
<th>数量限制</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>host</td>
<td>String</td>
<td>1</td>
<td>用于标识不同实例，一般writeHost我们使用<em>M1，readHost我们用</em>S1。</td>
</tr>
<tr>
<td>url</td>
<td>String</td>
<td>1</td>
<td>后端实例连接地址，如果是使用native的dbDriver，则一般为address:port这种形式。用JDBC或其他的dbDriver，则需要特殊 指定。当使用JDBC时则可以这么写：jdbc:mysql://localhost:3306/。</td>
</tr>
<tr>
<td>password</td>
<td>String</td>
<td>1</td>
<td>后端存储实例需要的用户名字</td>
</tr>
<tr>
<td>user</td>
<td>String</td>
<td>1</td>
<td>后端存储实例需要的密码</td>
</tr>
</tbody>
</table>
<h4 id="2-配置server-xml"><a href="#2-配置server-xml" class="headerlink" title="2.配置server.xml"></a>2.配置server.xml</h4><p>server.xml几乎保存了所有mycat需要的系统配置信息。最常用的是在此配置用户名、密码及权限。</p>
<p>例如:给TESTDB配置一个test用户。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;user name=&quot;test&quot;&gt;</div><div class="line">    &lt;property name=&quot;password&quot;&gt;test&lt;/property&gt;</div><div class="line">    &lt;property name=&quot;schemas&quot;&gt;TESTDB&lt;/property&gt;</div><div class="line">    &lt;property name=&quot;readOnly&quot;&gt;true&lt;/property&gt;</div><div class="line">&lt;/user&gt;</div></pre></td></tr></table></figure>
<h4 id="3-配置rule-xml"><a href="#3-配置rule-xml" class="headerlink" title="3.配置rule.xml"></a>3.配置rule.xml</h4><p>rule.xml里面就定义了我们对表进行拆分所涉及到的规则定义。我们可以灵活的对表使用不同的分片算法，或者对表使用相同的算法但具体的参数不同。这个文件里面主要有tableRule和function这两个标签。在具体使用过程中可以按照需求添加tableRule和function。</p>
<h3 id="MyCat读写分离"><a href="#MyCat读写分离" class="headerlink" title="MyCat读写分离"></a>MyCat读写分离</h3><p>数据库读写分离对于大型系统或者访问量很高的互联网应用来说，是必不可少的一个重要功能。对于MySQL来说，标准的读写分离是主从模式，一个写节点Master后面跟着多个读节点，读节点的数量取决于系统的压力，通常是1-3个读节点的配置。</p>
<p><img src="http://ww1.sinaimg.cn/mw690/63503acbjw1f67ok0c0gsj20gx09ogmo.jpg" alt="Mycat读写分离和自动切换机制，需要mysql的主从复制机制配合。"></p>
<h4 id="1-Mysql主从复制"><a href="#1-Mysql主从复制" class="headerlink" title="1.Mysql主从复制"></a>1.Mysql主从复制</h4><p><img src="http://ww1.sinaimg.cn/mw690/63503acbjw1f67ok01dxoj20j70dota9.jpg" alt=""></p>
<p>Mysql主从配置需要注意的地方:</p>
<ol>
<li>主DBServer和从DBServer需要版本一致。</li>
<li>主DBServer和从DBServer数据一致。</li>
<li>主DB server开启二进制日志,主DB server和从DB server的server_id都必须唯一。</li>
</ol>
<h4 id="2-Mysql主服务器配置"><a href="#2-Mysql主服务器配置" class="headerlink" title="2.Mysql主服务器配置"></a>2.Mysql主服务器配置</h4><p>修改/etc路径下的my.cnf文件,在[mysqld]段中添加:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">binlog-do-db=db1</div><div class="line">binlog-ignore-db=mysql</div><div class="line">#启用二进制日志</div><div class="line">log-bin=mysql-bin</div><div class="line">#服务器唯一ID，一般取IP最后一段</div><div class="line">server-id=138</div></pre></td></tr></table></figure>
<p>修改后,重启mysql服务service mysqld restart</p>
<p>创建一个账户并授权slave。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql&gt;GRANT FILE ON *.* TO &apos;backup&apos;@&apos;%&apos; IDENTIFIED BY &apos;123456&apos;;</div><div class="line">mysql&gt;GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* to &apos;backup&apos;@&apos;%&apos; identified by &apos;123456&apos;; </div><div class="line">#一般不用root帐号，“%”表示所有客户端都可能连，只要帐号，密码正确，此处可用具体客户端IP代替，如192.168.145.226，加强安全。</div></pre></td></tr></table></figure>
<p>之后刷新权限:FLUSH PRIVILEGES;</p>
<p>可以使用show master status;命令 查询主服务器状态。</p>
<h4 id="3-Mysql从服务器配置"><a href="#3-Mysql从服务器配置" class="headerlink" title="3.Mysql从服务器配置"></a>3.Mysql从服务器配置</h4><p>修改/etc路径下的my.cnf文件,在[mysqld]段中添加一个serverid。</p>
<p>配置从服务器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mysql&gt;change master to master_host=&apos;192.168.145.138&apos;,master_user=&apos;backup&apos;,master_password=&apos;123456&apos;,</div><div class="line"> master_log_file=&apos;mysql-bin.000002&apos;,master_log_pos=679;</div></pre></td></tr></table></figure>
<p>注意语句中间不要断开，master_port为mysql服务器端口号(无引号)，master_user为执行同步操作的数据库账户，“120”无单引号(此处的120就是show master status 中看到的position的值，这里的mysql-bin.000001就是file对应的值)。</p>
<p>之后启动从服务器复制功能 mysql&gt;start slave;</p>
<p>检查从服务器状态 show slave status;</p>
<p>注：Slave_IO及Slave_SQL进程必须正常运行，即YES状态，否则都是错误的状态(如：其中一个NO均属错误)。</p>
<p>如果出现此错误：<br>Fatal error: The slave I/O thread stops because master and slave have equal MySQL server UUIDs; these UUIDs must be different for replication to work.<br>因为是mysql是克隆的系统所以mysql的uuid是一样的，所以需要修改。</p>
<p>解决方法:<br>删除/var/lib/mysql/auto.cnf文件，重新启动服务。</p>
<h4 id="4-MyCat配置"><a href="#4-MyCat配置" class="headerlink" title="4.MyCat配置"></a>4.MyCat配置</h4><p>Mycat 1.4 支持MySQL主从复制状态绑定的读写分离机制，让读更加安全可靠，配置如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;dataNode name=&quot;dn1&quot; dataHost=&quot;localhost1&quot; database=&quot;db1&quot; /&gt;</div><div class="line">	&lt;dataNode name=&quot;dn2&quot; dataHost=&quot;localhost1&quot; database=&quot;db2&quot; /&gt;</div><div class="line">	&lt;dataNode name=&quot;dn3&quot; dataHost=&quot;localhost1&quot; database=&quot;db3&quot; /&gt;</div><div class="line">	&lt;dataHost name=&quot;localhost1&quot; maxCon=&quot;1000&quot; minCon=&quot;10&quot; balance=&quot;1&quot;</div><div class="line">		writeType=&quot;0&quot; dbType=&quot;mysql&quot; dbDriver=&quot;native&quot; switchType=&quot;2&quot;  slaveThreshold=&quot;100&quot;&gt;</div><div class="line">		&lt;heartbeat&gt;show slave status&lt;/heartbeat&gt;</div><div class="line">		&lt;writeHost host=&quot;hostM&quot; url=&quot;192.168.25.138:3306&quot; user=&quot;root&quot;</div><div class="line">			password=&quot;root&quot;&gt;</div><div class="line">			&lt;readHost host=&quot;hostS&quot; url=&quot;192.168.25.166:3306&quot; user=&quot;root&quot;</div><div class="line">			password=&quot;root&quot; /&gt;</div><div class="line">		&lt;/writeHost&gt;</div><div class="line">	&lt;/dataHost&gt;</div></pre></td></tr></table></figure>
<p>readHost是从属于writeHost的，即意味着它从那个writeHost获取同步数据，因此，当它所属的writeHost宕机了，则它也不会再参与到读写分离中来，即“不工作了”，这是因为此时，它的数据已经“不可靠”了。基于这个考虑，目前mycat 1.3和1.4版本中，若想支持MySQL一主一从的标准配置，并且在主节点宕机的情况下，从节点还能读取数据，则需要在Mycat里配置为两个writeHost并设置banlance=1。</p>
<p>设置 switchType=”2” 与slaveThreshold=”100”</p>
<p>switchType 目前有三种选择：</p>
<p>-1：表示不自动切换</p>
<p>1 ：默认值，自动切换</p>
<p>2 ：基于MySQL主从同步的状态决定是否切换</p>
<p>Mycat心跳检查语句配置为 show slave status ，dataHost 上定义两个新属性: switchType=”2” 与slaveThreshold=”100”，此时意味着开启MySQL主从复制状态绑定的读写分离与切换机制。</p>
<p>Mycat心跳机制通过检测 show slave status 中的 “Seconds_Behind_Master”, “Slave_IO_Running”, “Slave_SQL_Running” 三个字段来确定当前主从同步的状态以及Seconds_Behind_Master主从复制时延。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sylvanassun.github.io/2016/07/09/2016-07-09-MyCat/" data-id="cj4z0jkav000duomj3fxvbgj5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MyCat/">MyCat</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端开发/">后端开发</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/数据库/">数据库</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016-07-03-activemq" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/03/2016-07-03-activemq/" class="article-date">
  <time datetime="2016-07-03T10:00:00.000Z" itemprop="datePublished">2016-07-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/07/03/2016-07-03-activemq/">ActiveMQ消息队列</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://ww1.sinaimg.cn/mw690/63503acbjw1f67ojz4j8kj20bk03djrj.jpg" alt=""></p>
<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>&nbsp;&nbsp;ActiveMQ 是Apache出品，最流行的，能力强劲的开源消息总线。ActiveMQ 是一个完全支持JMS1.1和J2EE 1.4规范的 JMS Provider实现,尽管JMS规范出台已经是很久的事情了,但是JMS在当今的J2EE应用中间仍然扮演着特殊的地位。</p>
<p>主要特点：</p>
<ol>
<li>多种语言和协议编写客户端。语言: Java, C, C++, C#, Ruby, Perl, Python, PHP。应用协议: OpenWire,Stomp REST,WS Notification,XMPP,AMQP</li>
<li>完全支持JMS1.1和J2EE 1.4规范 (持久化,XA消息,事务)</li>
<li>对Spring的支持,ActiveMQ可以很容易内嵌到使用Spring的系统里面去,而且也支持Spring2.0的特性</li>
<li>通过了常见J2EE服务器(如 Geronimo,JBoss 4, GlassFish,WebLogic)的测试,其中通过JCA 1.5 resource adaptors的配置,可以让ActiveMQ可以自动的部署到任何兼容J2EE 1.4 商业服务器上</li>
<li>支持多种传送协议:in-VM,TCP,SSL,NIO,UDP,JGroups,JXTA</li>
<li>支持通过JDBC和journal提供高速的消息持久化</li>
<li>从设计上保证了高性能的集群,客户端-服务器,点对点</li>
<li>支持Ajax</li>
<li>支持与Axis的整合</li>
<li>可以很容易得调用内嵌JMS provider,进行测试</li>
</ol>
<h3 id="什么是JMS规范"><a href="#什么是JMS规范" class="headerlink" title="什么是JMS规范"></a>什么是JMS规范</h3><p>&nbsp;&nbsp;JMS的全称是Java MessageService，即Java消息服务。用于在两个应用程序之间，或分布式系统中发送消息，进行异步通信。<br>&nbsp;&nbsp;它主要用于在生产者和消费者之间进行消息传递，生产者负责产生消息，而消费者负责接收消息。把它应用到实际的业务需求中的话我们可以在特定的时候利用生产者生成一消息，并进行发送，对应的消费者在接收到对应的消息后去完成对应的业务逻辑。<br>&nbsp;&nbsp;对于消息的传递有两种类型：<br>一种是点对点的，即一个生产者和一个消费者一一对应；<br>另一种是发布/订阅模式，即一个生产者产生消息并进行发送后，可以由多个消费者进行接收。<br>JMS定义了五种不同的消息正文格式，以及调用的消息类型，允许你发送并接收以一些不同形式的数据，提供现有消息格式的一些级别的兼容性。</p>
<ul>
<li>StreamMessage – Java原始值的数据流</li>
<li>MapMessage–一套名称-值对</li>
<li>TextMessage–一个字符串对象</li>
<li>ObjectMessage–一个序列化的 Java对象</li>
<li>BytesMessage–一个字节的数据流</li>
</ul>
<h3 id="JMS应用程序接口"><a href="#JMS应用程序接口" class="headerlink" title="JMS应用程序接口"></a>JMS应用程序接口</h3><p>&nbsp;&nbsp;<strong>ConnectionFactory</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;用户用来创建到JMS提供者的连接的被管对象。JMS客户通过可移植的接口访问连接，这样当下层的实现改变时，代码不需要进行修改。 管理员在JNDI名字空间中配置连接工厂，这样，JMS客户才能够查找到它们。根据消息类型的不同，用户将使用队列连接工厂，或者主题连接工厂。</p>
<p>&nbsp;&nbsp;<strong>Connection</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;连接代表了应用程序和消息服务器之间的通信链路。在获得了连接工厂后，就可以创建一个与JMS提供者的连接。根据不同的连接类型，连接允许用户创建会话，以发送和接收队列和主题到目标。</p>
<p>&nbsp;&nbsp;<strong>Destination</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;目标是一个包装了消息目标标识符的被管对象，消息目标是指消息发布和接收的地点，或者是队列，或者是主题。JMS管理员创建这些对象，然后用户通过JNDI发现它们。和连接工厂一样，管理员可以创建两种类型的目标，点对点模型的队列，以及发布者／订阅者模型的主题。</p>
<p>&nbsp;&nbsp;<strong>MessageProducer</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;由会话创建的对象，用于发送消息到目标。用户可以创建某个目标的发送者，也可以创建一个通用的发送者，在发送消息时指定目标。</p>
<p>&nbsp;&nbsp;<strong>MessageConsumer</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;由会话创建的对象，用于接收发送到目标的消息。消费者可以同步地（阻塞模式），或异步（非阻塞）接收队列和主题类型的消息。</p>
<p>&nbsp;&nbsp;<strong>Message</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;是在消费者和生产者之间传送的对象，也就是说从一个应用程序创送到另一个应用程序。一个消息有三个主要部分：</p>
<ul>
<li>消息头（必须）：包含用于识别和为消息寻找路由的操作设置。</li>
<li>一组消息属性（可选）：包含额外的属性，支持其他提供者和用户的兼容。可以创建定制的字段和过滤器（消息选择器）。</li>
<li>一个消息体（可选）：允许用户创建五种类型的消息（文本消息，映射消息，字节消息，流消息和对象消息）。</li>
</ul>
<p>消息接口非常灵活，并提供了许多方式来定制消息的内容。</p>
<p>&nbsp;&nbsp;<strong>Session</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;表示一个单线程的上下文，用于发送和接收消息。由于会话是单线程的，所以消息是连续的，就是说消息是按照发送的顺序一个一个接收的。会话的好处是它支持事务。如果用户选择了事务支持，会话上下文将保存一组消息，直到事务被提交才发送这些消息。在提交事务之前，用户可以使用回滚操作取消这些消息。一个会话允许用户创建消息生产者来发送消息，创建消息消费者来接收消息。</p>
<h3 id="JMS消息发送模式"><a href="#JMS消息发送模式" class="headerlink" title="JMS消息发送模式"></a>JMS消息发送模式</h3><p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f67ojyj0g8j20mf0fdwft.jpg" alt=""></p>
<p>&nbsp;&nbsp;在P2P模型下，一个生产者向一个特定的队列发布消息，一个消费者从该队列中读取消息。这里，生产者知道消费者的队列，并直接将消息发送到消费者的队列。这种模式被概括为：只有一个消费者将获得消息。生产者不需要在接收者消费该消息期间处于运行状态，接收者也同样不需要在消息发送时处于运行状态。每一个成功处理的消息都由接收者签收。</p>
<p>&nbsp;&nbsp;publish/subscribe模型支持向一个特定的消息主题发布消息。0或多个订阅者可能对接收来自特定消息主题的消息感兴趣。在这种模型下，发布者和订阅者彼此不知道对方。这种模式好比是匿名公告板。这种模式被概括为：多个消费者可以获得消息.在发布者和订阅者之间存在时间依赖性。发布者需要建立一个订阅（subscription），以便客户能够购订阅。订阅者必须保持持续的活动状态以接收消息，除非订阅者建立了持久的订阅。在那种情况下，在订阅者未连接时发布的消息将在订阅者重新连接时重新发布。</p>
<h3 id="安装ActiveMQ"><a href="#安装ActiveMQ" class="headerlink" title="安装ActiveMQ"></a>安装ActiveMQ</h3><ol>
<li><p>首先到官网 <a href="http://activemq.apache.org/" target="_blank" rel="external">http://activemq.apache.org/</a> 下载ActiveMQ.</p>
</li>
<li><p>因为ActiveMQ是JAVA开发的,所以依赖jdk环境。</p>
</li>
<li><p>解压ActiveMQ。</p>
</li>
<li><p>在ActiveMQ/bin目录中,./activemq start 开启ActiveMQ</p>
</li>
<li><p>在ActiveMQ/bin目录中,./activemq stop 关闭ActiveMQ</p>
</li>
<li><p>访问后台 <a href="http://ip:8161/admin" target="_blank" rel="external">http://ip:8161/admin</a>  ActiveMQ的默认后台端口为8161,Message端口为61616</p>
</li>
</ol>
<h3 id="使用ActiveMQ"><a href="#使用ActiveMQ" class="headerlink" title="使用ActiveMQ"></a>使用ActiveMQ</h3><p>&nbsp;&nbsp;使用ActiveMQ需要先引入ActiveMQ的jar包。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">       &lt;dependency&gt;</div><div class="line">	&lt;groupId&gt;org.apache.activemq&lt;/groupId&gt;</div><div class="line">	&lt;artifactId&gt;activemq-all&lt;/artifactId&gt;</div><div class="line">	&lt;version&gt;5.11.2&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<p>以下示例使用Queue模式,如要使用Topic模式只需要将Destination改成Topic即可。</p>
<h4 id="1-Producer"><a href="#1-Producer" class="headerlink" title="1.Producer"></a>1.Producer</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">   <span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testProducer</span><span class="params">()</span> <span class="keyword">throws</span> JMSException</span>&#123;</div><div class="line">	<span class="comment">// 创建连接工厂</span></div><div class="line">	ConnectionFactory connectionFactory = </div><div class="line">				<span class="keyword">new</span> ActiveMQConnectionFactory(<span class="string">"tcp://192.168.145.137:61616"</span>);</div><div class="line">	<span class="comment">// 声明Connection</span></div><div class="line">	Connection connection = <span class="keyword">null</span>;</div><div class="line">	<span class="comment">// 声明Session</span></div><div class="line">	Session session = <span class="keyword">null</span>;</div><div class="line">	<span class="comment">// 声明Producer</span></div><div class="line">	MessageProducer producer = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">try</span>&#123;</div><div class="line">		<span class="comment">// 从连接工厂中获得连接</span></div><div class="line">		connection = connectionFactory.createConnection();</div><div class="line">		<span class="comment">// 开启连接</span></div><div class="line">		connection.start();</div><div class="line">		<span class="comment">/*</span></div><div class="line">		 * 从连接中获得会话</div><div class="line">		 * 参数1:transacted  boolean型</div><div class="line">		 * 当设置为true时,将忽略参数2,acknowledgment mode被jms服务器设置 SESSION_TRANSACTED。</div><div class="line">		 * 当一个事务被提交时,消息确认就会自动发生。</div><div class="line">		 * 当设置为false时,需要设置参数2</div><div class="line">		 * Session.AUTO_ACKNOWLEDGE为自动确认，当客户成功的从receive方法返回的时候，或者从</div><div class="line">		 * MessageListener.onMessage方法成功返回的时候，会话自动确认客户收到的消息。</div><div class="line">		 * Session.CLIENT_ACKNOWLEDGE 为客户端确认。客户端接收到消息后，必须调用javax.jms.Message的</div><div class="line">		 * acknowledge方法。jms服务器才会删除消息。（默认是批量确认）</div><div class="line">		 */</div><div class="line">		session = connection.createSession(<span class="keyword">false</span>,Session.AUTO_ACKNOWLEDGE);</div><div class="line">		<span class="comment">// 创建一个Destination目的地 Queue或者Topic</span></div><div class="line">		Queue queue = session.createQueue(<span class="string">"testMessage"</span>);</div><div class="line">		<span class="comment">// 创建一个Producer生产者</span></div><div class="line">		producer = session.createProducer(queue);</div><div class="line">		<span class="comment">// 创建message</span></div><div class="line">		ActiveMQTextMessage textMessage = <span class="keyword">new</span> ActiveMQTextMessage();</div><div class="line">		textMessage.setText(<span class="string">"test"</span>);</div><div class="line">		<span class="comment">// 发送message</span></div><div class="line">		producer.send(textMessage);</div><div class="line">	&#125;<span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">		e.printStackTrace();</div><div class="line">	&#125;<span class="keyword">finally</span>&#123;</div><div class="line">		<span class="comment">// 回收资源</span></div><div class="line">		producer.close();</div><div class="line">		session.close();</div><div class="line">		connection.close();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-Consumer"><a href="#2-Consumer" class="headerlink" title="2.Consumer"></a>2.Consumer</h4><p>&nbsp;&nbsp;消费者有两种消费方式:</p>
<ol>
<li><p>同步消费。通过调用消费者的receive方法从目的地中显式提取消息。receive方法可以一直阻塞到消息到达。</p>
</li>
<li><p>异步消费。客户可以为消费者注册一个消息监听器，以定义在消息到达时所采取的动作。<br>  实现MessageListener接口，在MessageListener（）方法中实现消息的处理逻辑。</p>
</li>
</ol>
<p>同步消费</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSyncConsumer</span><span class="params">()</span> <span class="keyword">throws</span> JMSException</span>&#123;</div><div class="line">	<span class="comment">// 创建连接工厂</span></div><div class="line">	ConnectionFactory connectionFactory = </div><div class="line">					<span class="keyword">new</span> ActiveMQConnectionFactory(<span class="string">"tcp://192.168.145.137:61616"</span>);</div><div class="line">	Connection connection = <span class="keyword">null</span>;</div><div class="line">	Session session = <span class="keyword">null</span>;</div><div class="line">	MessageConsumer consumer = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">try</span>&#123;</div><div class="line">		<span class="comment">// 获得连接</span></div><div class="line">		connection = connectionFactory.createConnection();</div><div class="line">		<span class="comment">// 开启连接</span></div><div class="line">		connection.start();</div><div class="line">		<span class="comment">// 获得Session</span></div><div class="line">		session = connection.createSession(<span class="keyword">false</span>,Session.AUTO_ACKNOWLEDGE);</div><div class="line">		<span class="comment">// 创建一个目的地</span></div><div class="line">		Queue queue = session.createQueue(<span class="string">"testSynchronization"</span>);</div><div class="line">		<span class="comment">// 创建消费者</span></div><div class="line">		consumer = session.createConsumer(queue);</div><div class="line">		<span class="comment">// 使用receive同步消费</span></div><div class="line">		<span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</div><div class="line">			<span class="comment">// 设置接收信息的时间,单位为毫秒</span></div><div class="line">			Message message = consumer.receive(<span class="number">10000</span>);</div><div class="line">			<span class="keyword">if</span>(message != <span class="keyword">null</span>)&#123;</div><div class="line">				System.out.println(message);</div><div class="line">			&#125;<span class="keyword">else</span>&#123;</div><div class="line">				<span class="comment">// 超时,结束循环</span></div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;<span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">		e.printStackTrace();</div><div class="line">	&#125;<span class="keyword">finally</span>&#123;</div><div class="line">		<span class="comment">// 回收资源</span></div><div class="line">		consumer.close();</div><div class="line">		session.close();</div><div class="line">		connection.close();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>异步消费</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">   <span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAsyncConsumer</span><span class="params">()</span> <span class="keyword">throws</span> JMSException</span>&#123;</div><div class="line">	<span class="comment">// 创建连接工厂</span></div><div class="line">	ConnectionFactory connectionFactory = </div><div class="line">				<span class="keyword">new</span> ActiveMQConnectionFactory(<span class="string">"tcp://192.168.145.137:61616"</span>);</div><div class="line">	Connection connection = <span class="keyword">null</span>;</div><div class="line">	Session session = <span class="keyword">null</span>;</div><div class="line">	MessageConsumer consumer = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">try</span>&#123;</div><div class="line">		<span class="comment">// 获得连接</span></div><div class="line">		connection = connectionFactory.createConnection();</div><div class="line">		<span class="comment">// 开启连接</span></div><div class="line">		connection.start();</div><div class="line">		<span class="comment">// 获得Session</span></div><div class="line">		session = connection.createSession(<span class="keyword">false</span>,Session.AUTO_ACKNOWLEDGE);</div><div class="line">		<span class="comment">// 设置目的地</span></div><div class="line">		Queue queue = session.createQueue(<span class="string">"testAsynchronization"</span>);</div><div class="line">		<span class="comment">// 创建Consumer</span></div><div class="line">		consumer = session.createConsumer(queue);</div><div class="line">		<span class="comment">// 异步消费</span></div><div class="line">		session.setMessageListener(<span class="keyword">new</span> MessageListener() &#123;</div><div class="line">			</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message)</span> </span>&#123;</div><div class="line">				<span class="keyword">if</span>(message <span class="keyword">instanceof</span> TextMessage)&#123;</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						String text = ((TextMessage) message).getText();</div><div class="line">						System.out.println(text);</div><div class="line">					&#125; <span class="keyword">catch</span> (JMSException e) &#123;</div><div class="line">						e.printStackTrace();</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		System.in.read();</div><div class="line">	&#125;<span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">		e.printStackTrace();</div><div class="line">	&#125;<span class="keyword">finally</span>&#123;</div><div class="line">		<span class="comment">// 回收资源</span></div><div class="line">		consumer.close();</div><div class="line">		session.close();</div><div class="line">		connection.close();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="整合Spring"><a href="#整合Spring" class="headerlink" title="整合Spring"></a>整合Spring</h3><h4 id="1-配置ConnectionFactory"><a href="#1-配置ConnectionFactory" class="headerlink" title="1.配置ConnectionFactory"></a>1.配置ConnectionFactory</h4><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line">&lt;beans xmlns="http://www.springframework.org/schema/beans"</div><div class="line">	xmlns:context="http://www.springframework.org/schema/context" xmlns:p="http://www.springframework.org/schema/p"</div><div class="line">	xmlns:aop="http://www.springframework.org/schema/aop" xmlns:tx="http://www.springframework.org/schema/tx"</div><div class="line">	xmlns:jms="http://www.springframework.org/schema/jms" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"</div><div class="line">	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.0.xsd</div><div class="line">	http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.0.xsd</div><div class="line">	http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.0.xsd </div><div class="line">	http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-4.0.xsd</div><div class="line">	http://www.springframework.org/schema/jms http://www.springframework.org/schema/jms/spring-jms-4.0.xsd</div><div class="line">	http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-4.0.xsd"&gt;</div><div class="line"></div><div class="line"></div><div class="line">	&lt;!-- ActiveMQ提供的ConnectionFactory --&gt;</div><div class="line">	&lt;bean id="targetConnectionFactory" class="org.apache.activemq.ActiveMQConnectionFactory"&gt;</div><div class="line">		&lt;property name="brokerURL" value="tcp://192.168.145.137:61616" /&gt;</div><div class="line">	&lt;/bean&gt;</div><div class="line">	&lt;!-- Spring的ConnectionFactory需要注入ActiveMQ的ConnectionFactory --&gt;</div><div class="line">	&lt;bean id="connectionFactory"</div><div class="line">		class="org.springframework.jms.connection.SingleConnectionFactory"&gt;</div><div class="line">		&lt;!-- 目标ConnectionFactory对应真实的可以产生JMS Connection的ConnectionFactory --&gt;</div><div class="line">		&lt;property name="targetConnectionFactory" ref="targetConnectionFactory" /&gt;</div><div class="line">	&lt;/bean&gt;</div><div class="line">&lt;/beans&gt;</div></pre></td></tr></table></figure>
<h4 id="2-配置生产者"><a href="#2-配置生产者" class="headerlink" title="2.配置生产者"></a>2.配置生产者</h4><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">   &lt;!-- 配置生产者 --&gt;</div><div class="line">&lt;!-- Spring提供的JMS工具类，它可以进行消息发送、接收等 --&gt;</div><div class="line">&lt;bean id="jmsTemplate" class="org.springframework.jms.core.JmsTemplate"&gt;</div><div class="line">	&lt;!-- 注入Spring的连接工厂 --&gt;</div><div class="line">	&lt;property name="connectionFactory" ref="connectionFactory" /&gt;</div><div class="line">&lt;/bean&gt;</div><div class="line">&lt;!--P2P模式的Destination --&gt;</div><div class="line">&lt;bean id="queueDestination" class="org.apache.activemq.command.ActiveMQQueue"&gt;</div><div class="line">	&lt;constructor-arg&gt;</div><div class="line">		&lt;value&gt;queue&lt;/value&gt;</div><div class="line">	&lt;/constructor-arg&gt;</div><div class="line">&lt;/bean&gt;</div><div class="line">&lt;!-- publish/subscribe模式的Destination --&gt;</div><div class="line">&lt;bean id="topicDestination" class="org.apache.activemq.command.ActiveMQTopic"&gt;</div><div class="line">	&lt;constructor-arg value="topic" /&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
<h4 id="3-发送消息"><a href="#3-发送消息" class="headerlink" title="3.发送消息"></a>3.发送消息</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSend</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="comment">// 读取Spring配置文件</span></div><div class="line">		ApplicationContext applicationContext = </div><div class="line">					<span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"applicationContext.xml"</span>);</div><div class="line">		<span class="comment">// 获得JmsTemplate</span></div><div class="line">		JmsTemplate jmsTemplate = applicationContext.getBean(JmsTemplate.class);</div><div class="line">		<span class="comment">// 获得Destination</span></div><div class="line">		ActiveMQQueue queue = applicationContext.getBean(ActiveMQQueue.class);</div><div class="line">		<span class="comment">// 发送消息</span></div><div class="line">		jmsTemplate.send(queue, <span class="keyword">new</span> MessageCreator() &#123;</div><div class="line">			</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Message <span class="title">createMessage</span><span class="params">(Session session)</span> <span class="keyword">throws</span> JMSException </span>&#123;</div><div class="line">				<span class="keyword">return</span> session.createTextMessage(<span class="string">"send-spring"</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<h4 id="4-配置消费者"><a href="#4-配置消费者" class="headerlink" title="4.配置消费者"></a>4.配置消费者</h4><p>&nbsp;&nbsp;Spring通过MessageListenerContainer接收信息,并把接收到的信息分发给MessageListener进行处理。每个消费者对应每个目的地都需要有对应的MessageListenerContainer。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">&lt;!-- ActiveMQ提供的ConnectionFactory --&gt;</div><div class="line">&lt;bean id="targetConnectionFactory" class="org.apache.activemq.ActiveMQConnectionFactory"&gt;</div><div class="line">	&lt;property name="brokerURL" value="tcp://192.168.145.137:61616" /&gt;</div><div class="line">&lt;/bean&gt;</div><div class="line">&lt;!-- Spring的ConnectionFactory需要注入ActiveMQ的ConnectionFactory --&gt;</div><div class="line">&lt;bean id="connectionFactory"</div><div class="line">	class="org.springframework.jms.connection.SingleConnectionFactory"&gt;</div><div class="line">	&lt;!-- 目标ConnectionFactory对应真实的可以产生JMS Connection的ConnectionFactory --&gt;</div><div class="line">	&lt;property name="targetConnectionFactory" ref="targetConnectionFactory" /&gt;</div><div class="line">&lt;/bean&gt;</div><div class="line">   &lt;!-- 配置生产者 --&gt;</div><div class="line">&lt;!-- Spring提供的JMS工具类，它可以进行消息发送、接收等 --&gt;</div><div class="line">&lt;bean id="jmsTemplate" class="org.springframework.jms.core.JmsTemplate"&gt;</div><div class="line">	&lt;!-- 注入Spring的连接工厂 --&gt;</div><div class="line">	&lt;property name="connectionFactory" ref="connectionFactory" /&gt;</div><div class="line">&lt;/bean&gt;</div><div class="line">&lt;!--P2P模式的Destination --&gt;</div><div class="line">&lt;bean id="queueDestination" class="org.apache.activemq.command.ActiveMQQueue"&gt;</div><div class="line">	&lt;constructor-arg&gt;</div><div class="line">		&lt;value&gt;queue&lt;/value&gt;</div><div class="line">	&lt;/constructor-arg&gt;</div><div class="line">&lt;/bean&gt;</div><div class="line">&lt;!-- publish/subscribe模式的Destination --&gt;</div><div class="line">&lt;bean id="topicDestination" class="org.apache.activemq.command.ActiveMQTopic"&gt;</div><div class="line">	&lt;constructor-arg value="topic" /&gt;</div><div class="line">&lt;/bean&gt;</div><div class="line">&lt;!-- 配置监听器 --&gt;</div><div class="line">&lt;bean id="myMessageListener" class="com.activemq.MyMessageListener" /&gt;</div><div class="line">&lt;!-- 消息监听容器 --&gt;</div><div class="line">&lt;bean id="jmsContainer"</div><div class="line">	class="org.springframework.jms.listener.DefaultMessageListenerContainer"&gt;</div><div class="line">	&lt;property name="connectionFactory" ref="connectionFactory" /&gt;</div><div class="line">	&lt;property name="destination" ref="queueDestination" /&gt;</div><div class="line">	&lt;property name="messageListener" ref="myMessageListener" /&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
<p>监听器需要实现MessageListener接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMessageListener</span> <span class="keyword">implements</span> <span class="title">MessageListener</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message)</span> </span>&#123;</div><div class="line">		System.out.println(message);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Exception"><a href="#Exception" class="headerlink" title="Exception"></a>Exception</h3><p>&nbsp;&nbsp;启动ActiveMQ时,如果发生java.net.UnknownHostException异常。<br>解决方法:<br>修改 /etc/hosts 文件 添加一行 192.168.1.1(主机IP) 主机名.localdomain 主机名<br>例: 192.168.145.137 ActiveMQ.localdomain ActiveMQ</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sylvanassun.github.io/2016/07/03/2016-07-03-activemq/" data-id="cj4z0jkb5000kuomjtp95cfsb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ActiveMQ/">ActiveMQ</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端开发/">后端开发</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016-06-30-solrcloud" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/30/2016-06-30-solrcloud/" class="article-date">
  <time datetime="2016-06-30T10:00:00.000Z" itemprop="datePublished">2016-06-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/30/2016-06-30-solrcloud/">SolrCloud初体验</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://ww4.sinaimg.cn/mw690/63503acbjw1f67ocs5srhj207g05m3yl.jpg" alt=""></p>
<h3 id="什么是SolrCloud"><a href="#什么是SolrCloud" class="headerlink" title="什么是SolrCloud"></a>什么是SolrCloud</h3><p>SolrCloud是基于Solr和Zookeeper的分布式搜索方案,它的主要思想是使用Zookeeper作为集群的配置信息中心。</p>
<h3 id="SolrCloud的特点"><a href="#SolrCloud的特点" class="headerlink" title="SolrCloud的特点"></a>SolrCloud的特点</h3><h4 id="1-近实时搜索"><a href="#1-近实时搜索" class="headerlink" title="1.近实时搜索"></a>1.近实时搜索</h4><p>立即推送式的replication（也支持慢推送）。可以在秒内检索到新加入索引。</p>
<h4 id="2-自动容错"><a href="#2-自动容错" class="headerlink" title="2.自动容错"></a>2.自动容错</h4><p>SolrCloud对索引分片,并对每个分片创建多个Replication。每个Replication都可以对外提供服务。一个Replication挂掉不会影响索引服务。更强大的是，它还能自动的在其它机器上帮你把失败机器上的索引Replication重建并投入使用。</p>
<h4 id="3-查询时自动负载均衡"><a href="#3-查询时自动负载均衡" class="headerlink" title="3.查询时自动负载均衡"></a>3.查询时自动负载均衡</h4><p>SolrCloud索引的多个Replication可以分布在多台机器上,均衡查询压力。如果查询压力大，可以通过扩展机器，增加Replication来减缓。</p>
<h4 id="4-集中式的配置信息"><a href="#4-集中式的配置信息" class="headerlink" title="4.集中式的配置信息"></a>4.集中式的配置信息</h4><p>SolrCloud可以将配置文件上传到Zookeeper,由Zookeeper对配置文件进行管理。</p>
<h3 id="结构分析"><a href="#结构分析" class="headerlink" title="结构分析"></a>结构分析</h3><p>为了减少处理压力,SolrCloud需要由多台服务器共同完成索引和搜索。</p>
<h4 id="1-实现思路"><a href="#1-实现思路" class="headerlink" title="1.实现思路"></a>1.实现思路</h4><p>SolrCloud将索引数据进行分片(Shard),每个分片由多台服务器共同完成。</p>
<h4 id="2-结构"><a href="#2-结构" class="headerlink" title="2.结构"></a>2.结构</h4><p><img src="http://ww4.sinaimg.cn/mw690/63503acbjw1f67oct3xegj20rx0qfdht.jpg" alt=""></p>
<p><strong>物理结构</strong><br>SolrCloud由三个Solr服务器组成,每个Solr服务器包含2个Core。</p>
<p><strong>逻辑结构</strong><br>一个Collection包含2个Shard,每个Shard由3个core组成(一个Leader,两个Replication)。</p>
<p><strong>Collection</strong><br>Collection是一个在逻辑意义上完整的索引结构,它常常被划分为一个或多个Shard分片,它们使用相同的配置信息。如果Shard数超过一个，它就是分布式索引，SolrCloud让你通过Collection名称引用它，而不需要关心分布式检索时需要使用的和Shard相关参数。</p>
<p><strong>Core</strong><br>一个Solr中包含一个或者多个Solr Core，每个Solr Core可以独立提供索引和查询功能，每个Solr Core对应一个索引或者Collection的Shard，Solr Core的提出是为了增加管理灵活性和共用资源。在SolrCloud中有个不同点是它使用的配置是在Zookeeper中的，传统的Solr core的配置文件是在磁盘上的配置目录中。</p>
<p><strong>Shard</strong><br>Collection的逻辑分片。每个Shard被化成一个或者多个replicas，通过选举确定哪个是Leader。</p>
<p><strong>Replication</strong><br>在master-slave结构中,Replication是一个从节点,同一个Shard下主从节点存储的数据是一致的。</p>
<p><strong>Leader</strong><br>在master-slave结构中,Leader是一个主节点,Leader是赢得选举的Replication。选举可以发生在任何时间，但是通常它们仅在某个Solr实例发生故障时才会触发。当索引documents时，SolrCloud会传递它们到此Shard对应的Leader，Leader再分发它们到全部Shard的Replication。</p>
<h3 id="SolrCloud的搭建"><a href="#SolrCloud的搭建" class="headerlink" title="SolrCloud的搭建"></a>SolrCloud的搭建</h3><h4 id="1-Zookeeper"><a href="#1-Zookeeper" class="headerlink" title="1.Zookeeper"></a>1.Zookeeper</h4><p>SolrCloud需要Zookeeper进行管理,所以需要先安装Zookeeper。</p>
<ul>
<li><p>.解压缩zookeeper.tar.gz,并复制出3个Zookeeper实例。</p>
</li>
<li><p>.进入zookeeper01目录,创建一个data文件夹,并在data中创建一个myid文件,内容为1(其他Zookeeper实例为2和3)。</p>
</li>
<li><p>进入conf文件夹,将zoo_sample.cfg改名为zoo.cfg</p>
</li>
<li><p>vim zoo.cfg 修改dataDir=data文件夹所在的目录,<br>添加:<br>server.myid的值=ip:每个Zookeeper服务器之间的通讯端口:Zookeeper与其他应用的通讯端口。(每个Zookeeper实例都需要添加这行内容)<br>例如:</p>
<p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f67ocpgc1zj20d80cwdjc.jpg" alt=""></p>
</li>
</ul>
<h4 id="2-Solr实例"><a href="#2-Solr实例" class="headerlink" title="2.Solr实例"></a>2.Solr实例</h4><ul>
<li><p>安装一个单机的Solr实例,并复制成4份,分别对应4个SolrHome。</p>
</li>
<li><p>修改SolrHome的solr.xml文件</p>
<p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f67ocqpcfqj20he097acw.jpg" alt=""></p>
</li>
<li><p>将配置文件上传到Zookeeper,当配置文件发生改变时,需要重新上传。</p>
</li>
</ul>
<pre><code> java -classpath .:/usr/local/solr-cloud/solr-lib/* org.apache.solr.cloud.ZkCLI -cmd upconfig -zkhost 127.0.0.1:2181,127.0.0.1:2182,127.0.0.1:2183 -confdir /usr/local/solr-cloud/solrhome01/collection1/conf  -confname solr-conf

-cmd upconfig 上传配置文件命令
-zkhost Zookeeper集群的ip与端口
-confdir 配置文件的目录
-confname 上传到Zookeeper后的文件夹名称

其中参数/usr/local/solr-cloud/solr-lib/可以自己创建，内容如下：
        复制tomcat/webapps/solr/WEB-INF/lib下所有jar包
        复制example/lib/ext下所有jar包
        复制example/resources/log4j.properties
</code></pre><ul>
<li><p>通知Solr实例Zookeeper的地址,需要修改tomcat/bin/catalina.sh<br>添加一行:JAVA_OPTS=”-DzkHost=Zookeeper集群的地址列表”</p>
<p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f67ocr82b3j20ig04ptas.jpg" alt=""></p>
</li>
</ul>
<h4 id="3-设置Shard"><a href="#3-设置Shard" class="headerlink" title="3.设置Shard"></a>3.设置Shard</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://web容器/solr/admin/collections?action=CREATE&amp;name=Collection名称&amp;numShards=Shard个数&amp;replicationFactor=Replication个数</div></pre></td></tr></table></figure>
<p>例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">http://192.168.145.150:8080/solr/admin/collections?action=CREATE&amp;name=collection2&amp;numShards=2&amp;replicationFactor=2</div><div class="line">上面的命令为 创建一个name为collection2的Collection,并分成了2个Shard,每个Shard有2个Replication</div></pre></td></tr></table></figure>
<p>删除一个Collection</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">http://192.168.145.150:8080/solr/admin/collections?action=DELETE&amp;name=collection1</div><div class="line">上面的命令为 删除一个name为collection1的Collection</div></pre></td></tr></table></figure>
<h3 id="Spring整合SolrCloud"><a href="#Spring整合SolrCloud" class="headerlink" title="Spring整合SolrCloud"></a>Spring整合SolrCloud</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&lt;!-- SolrCloud --&gt;</div><div class="line">	&lt;bean id=&quot;cloudSolrServer&quot; class=&quot;org.apache.solr.client.solrj.impl.CloudSolrServer&quot;&gt;</div><div class="line">		&lt;constructor-arg name=&quot;zkHost&quot;</div><div class="line">			value=&quot;192.168.145.136:2181,192.168.145.136:2182,192.168.145.136:2183&quot; /&gt;</div><div class="line">		&lt;!-- 设置默认搜索的Collection --&gt;</div><div class="line">		&lt;property name=&quot;defaultCollection&quot; value=&quot;collection2&quot; /&gt;</div><div class="line">	&lt;/bean&gt;</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sylvanassun.github.io/2016/06/30/2016-06-30-solrcloud/" data-id="cj4z0jkat000buomjo6ppkedn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/solr/">solr</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/全文检索引擎/">全文检索引擎</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端开发/">后端开发</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016-06-27-redis-cluster01" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/27/2016-06-27-redis-cluster01/" class="article-date">
  <time datetime="2016-06-27T10:00:00.000Z" itemprop="datePublished">2016-06-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/27/2016-06-27-redis-cluster01/">如何搭建与维护一个Redis集群</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f67o71v3m6j20av0640st.jpg" alt=""></p>
<h3 id="Redis集群架构"><a href="#Redis集群架构" class="headerlink" title="Redis集群架构"></a>Redis集群架构</h3><p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f67o70ppf9j20dr0fudhb.jpg" alt=""></p>
<ol>
<li><p>每一个<code>Redis</code>节点使用PING-PONG的形式互相通信。</p>
</li>
<li><p>当半数以上的节点fail时,则整个集群失效。</p>
</li>
<li><p>客户端不需要连接集群所有节点,只要连接集群中任意一个节点即可。</p>
</li>
<li><p><code>Redis</code>集群中内置了16384个哈希槽,当操作数据时,<code>Redis</code>会对key使用crc16算法算出一个结果,<br>并把结果对16384取余,每个key都会对应0-16383之间的哈希槽,<code>Redis</code>会根据节点数量平均的将<br>哈希槽映射到不同的节点上。</p>
</li>
</ol>
<h3 id="Redis投票机制"><a href="#Redis投票机制" class="headerlink" title="Redis投票机制"></a>Redis投票机制</h3><p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f67o717oqhj20cn0acmy4.jpg" alt=""></p>
<p><code>Redis</code>集群中每一个节点都会参与投票,如果当半数以上的节点认为一个节点通信超时,则该节点fail。</p>
<p>当集群中任意节点的master(主机)挂掉,且这个节点没有slave(从机),则整个集群进入fail状态。</p>
<h3 id="搭建Redis集群"><a href="#搭建Redis集群" class="headerlink" title="搭建Redis集群"></a>搭建Redis集群</h3><h4 id="1-安装Ruby环境"><a href="#1-安装Ruby环境" class="headerlink" title="1.安装Ruby环境"></a>1.安装Ruby环境</h4><p>因为redis-trib.rb脚本依赖ruby环境,所以需要先安装ruby。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum install ruby </div><div class="line">yum install rubygems</div></pre></td></tr></table></figure>
<p>安装ruby和redis的接口程序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gem install /usr/local/redis-3.0.0.gem</div></pre></td></tr></table></figure>
<h4 id="2-搭建Redis集群"><a href="#2-搭建Redis集群" class="headerlink" title="2.搭建Redis集群"></a>2.搭建Redis集群</h4><p>一个<code>Redis</code>集群最少需要3组主从机,即6个<code>Redis</code>。</p>
<p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f67o71g231j20cz03lta6.jpg" alt=""></p>
<p>修改redis.conf配置文件,将集群开关开启。</p>
<p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f67obgv67nj20an07gdim.jpg" alt=""></p>
<p>启动<code>Redis</code>实例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">cd redis01</div><div class="line">./redis-server redis.conf</div><div class="line">cd ..</div><div class="line">cd redis02</div><div class="line">./redis-server redis.conf</div><div class="line">cd ..</div><div class="line">cd redis03</div><div class="line">./redis-server redis.conf</div><div class="line">cd ..</div><div class="line">cd redis04</div><div class="line">./redis-server redis.conf</div><div class="line">cd ..</div><div class="line">cd redis05</div><div class="line">./redis-server redis.conf</div><div class="line">cd ..</div><div class="line">cd redis06</div><div class="line">./redis-server redis.conf</div><div class="line">cd ..</div></pre></td></tr></table></figure>
<p>使用redis-trib.rb创建集群</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./redis-trib.rb create --replicas 1 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005  127.0.0.1:7006</div></pre></td></tr></table></figure>
<h4 id="3-添加主节点"><a href="#3-添加主节点" class="headerlink" title="3.添加主节点"></a>3.添加主节点</h4><p>如果想添加一个port为7007的<code>Redis</code>实例,可以使用以下命令。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./redis-trib.rb add-node 127.0.0.1:7007 127.0.0.1:7001</div></pre></td></tr></table></figure>
<p>当添加了一个主节点后,需要重新分配哈希槽。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./redis-trib.rb reshard 127.0.0.1:7001</div></pre></td></tr></table></figure>
<h4 id="4-添加从节点"><a href="#4-添加从节点" class="headerlink" title="4.添加从节点"></a>4.添加从节点</h4><p>添加一个port为7008的<code>Redis</code>实例做为7007的从节点。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./redis-trib.rb add-node --slave --master-id cad9f7413ec6842c971dbcc2c48b4ca959eb5db4  127.0.0.1:7008 127.0.0.1:7001</div></pre></td></tr></table></figure>
<p>命令格式: ./redis-trib.rb add-node –slave –master-id 主节点id 新加从节点的ip和端口 集群中节点的ip和端口(任意一个节点)。</p>
<p>主节点id可以在client中使用 <strong>cluster nodes</strong> 命令查询。</p>
<p>注意: 如果原来该结点在集群中的配置信息已经生成到cluster-config-file指定的配置文件中（如果cluster-config-file没有指定则默认为nodes.conf),则会报错:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[ERR] Node XXXXXX is not empty. Either the node already knows other nodes (check with CLUSTER NODES) or contains some key in database 0</div></pre></td></tr></table></figure>
<p>解决方法: 删除生成的配置文件 nodes.conf,再执行./redis-trib.rb add-node命令。</p>
<h4 id="5-删除节点"><a href="#5-删除节点" class="headerlink" title="5.删除节点"></a>5.删除节点</h4><p>./redis-trib.rb del-node 要删除的节点的ip和端口 节点id<br>注意: 如果这个节点已经占有哈希槽,则无法删除,需要先将哈希槽分配出去。</p>
<h3 id="Jedis连接集群"><a href="#Jedis连接集群" class="headerlink" title="Jedis连接集群"></a>Jedis连接集群</h3><p>使用Jedis连接集群需要先创建JedisCluster对象。代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test01</span><span class="params">()</span></span>&#123;</div><div class="line">	Set&lt;HostAndPort&gt; nodes = <span class="keyword">new</span> HashSet&lt;HostAndPort&gt;();</div><div class="line">	nodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"192.168.145.134"</span>, <span class="number">7001</span>));</div><div class="line">	nodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"192.168.145.134"</span>, <span class="number">7002</span>));</div><div class="line">	nodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"192.168.145.134"</span>, <span class="number">7003</span>));</div><div class="line">	nodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"192.168.145.134"</span>, <span class="number">7004</span>));</div><div class="line">	nodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"192.168.145.134"</span>, <span class="number">7005</span>));</div><div class="line">	nodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"192.168.145.134"</span>, <span class="number">7006</span>));</div><div class="line">	<span class="comment">// 创建JedisCluster</span></div><div class="line">	JedisCluster jedisCluster = <span class="keyword">new</span> JedisCluster(nodes);</div><div class="line">	<span class="comment">// 操作redis</span></div><div class="line">	String set = jedisCluster.set(<span class="string">"hello"</span>, <span class="string">"helloWorld"</span>);</div><div class="line">	String hello = jedisCluster.get(<span class="string">"hello"</span>);</div><div class="line">	System.out.println(set);</div><div class="line">	System.out.println(hello);</div><div class="line">	<span class="comment">// 关闭JedisCluster</span></div><div class="line">	jedisCluster.close();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在Spring容器中维护:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">   &lt;bean class=&quot;redis.clients.jedis.JedisCluster&quot;&gt;</div><div class="line">	&lt;constructor-arg name=&quot;nodes&quot;&gt;</div><div class="line">		&lt;set&gt;</div><div class="line">			&lt;bean class=&quot;redis.clients.jedis.HostAndPort&quot;&gt;</div><div class="line">				&lt;constructor-arg name=&quot;host&quot; value=&quot;192.168.145.134&quot;/&gt;</div><div class="line">				&lt;constructor-arg name=&quot;port&quot; value=&quot;7001&quot;/&gt;</div><div class="line">			&lt;/bean&gt;</div><div class="line">			&lt;bean class=&quot;redis.clients.jedis.HostAndPort&quot;&gt;</div><div class="line">				&lt;constructor-arg name=&quot;host&quot; value=&quot;192.168.145.134&quot;/&gt;</div><div class="line">				&lt;constructor-arg name=&quot;port&quot; value=&quot;7002&quot;/&gt;</div><div class="line">			&lt;/bean&gt;</div><div class="line">			&lt;bean class=&quot;redis.clients.jedis.HostAndPort&quot;&gt;</div><div class="line">				&lt;constructor-arg name=&quot;host&quot; value=&quot;192.168.145.134&quot;/&gt;</div><div class="line">				&lt;constructor-arg name=&quot;port&quot; value=&quot;7003&quot;/&gt;</div><div class="line">			&lt;/bean&gt;</div><div class="line">			&lt;bean class=&quot;redis.clients.jedis.HostAndPort&quot;&gt;</div><div class="line">				&lt;constructor-arg name=&quot;host&quot; value=&quot;192.168.145.134&quot;/&gt;</div><div class="line">				&lt;constructor-arg name=&quot;port&quot; value=&quot;7004&quot;/&gt;</div><div class="line">			&lt;/bean&gt;</div><div class="line">			&lt;bean class=&quot;redis.clients.jedis.HostAndPort&quot;&gt;</div><div class="line">				&lt;constructor-arg name=&quot;host&quot; value=&quot;192.168.145.134&quot;/&gt;</div><div class="line">				&lt;constructor-arg name=&quot;port&quot; value=&quot;7005&quot;/&gt;</div><div class="line">			&lt;/bean&gt;</div><div class="line">			&lt;bean class=&quot;redis.clients.jedis.HostAndPort&quot;&gt;</div><div class="line">				&lt;constructor-arg name=&quot;host&quot; value=&quot;192.168.145.134&quot;/&gt;</div><div class="line">				&lt;constructor-arg name=&quot;port&quot; value=&quot;7006&quot;/&gt;</div><div class="line">			&lt;/bean&gt;</div><div class="line">		&lt;/set&gt;</div><div class="line">	&lt;/constructor-arg&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sylvanassun.github.io/2016/06/27/2016-06-27-redis-cluster01/" data-id="cj4z0jkas000auomjnagwrkac" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/redis/">redis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端开发/">后端开发</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016-06-24-nginx-initiation" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/24/2016-06-24-nginx-initiation/" class="article-date">
  <time datetime="2016-06-24T10:00:00.000Z" itemprop="datePublished">2016-06-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/24/2016-06-24-nginx-initiation/">如何安装与搭建一个Nginx服务器</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f67nyh9gq7j20cp075wel.jpg" alt=""></p>
<h3 id="Nginx介绍"><a href="#Nginx介绍" class="headerlink" title="Nginx介绍"></a>Nginx介绍</h3><p><code>Nginx</code>是一款轻量级的Web 服务器/反向代理服务器及电子邮件（IMAP/POP3）代理服务器，并在一个BSD-like 协议下发行。由俄罗斯的程序设计师Igor Sysoev所开发，供俄国大型的入口网站及搜索引擎Rambler使用。</p>
<h3 id="Nginx应用场景"><a href="#Nginx应用场景" class="headerlink" title="Nginx应用场景"></a>Nginx应用场景</h3><ol>
<li>作为http服务器使用并独立提供http服务。</li>
<li>虚拟主机。</li>
<li>用于反向代理与负载均衡,当并发量非常大时,可以使用<code>Nginx</code>对服务器集群进行反向代理与负载均衡,提高吞吐量。</li>
</ol>
<h3 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h3><p><img src="http://ww1.sinaimg.cn/mw690/63503acbjw1f67nz4ekjmj20tq0eqgmx.jpg" alt=""></p>
<p>反向代理是指以代理服务器来接受internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给internet上请求连接的客户端，此时代理服务器对外就表现为一个反向代理服务器。</p>
<h3 id="Nginx安装流程"><a href="#Nginx安装流程" class="headerlink" title="Nginx安装流程"></a>Nginx安装流程</h3><ol>
<li><p>Nginx依赖于以下4个库</p>
<ul>
<li><p>gcc<br>  安装nginx需要先将官网下载的源码进行编译，编译依赖gcc环境</p>
<pre><code>**yum install gcc-c++**
</code></pre></li>
<li><p>pcre<br>  PCRE(Perl Compatible Regular Expressions)是一个Perl库，包括 perl 兼容的正则表达式库。nginx的http模块使用pcre来解析正则表达式，所以需要在linux上安装pcre库。<br>   <strong>yum install -y pcre pcre-devel</strong></p>
</li>
<li><p>zlib<br>  zlib库提供了很多种压缩和解压缩的方式，nginx使用zlib对http包的内容进行gzip，所以需要在linux上安装zlib库。<br>   <strong>yum install -y zlib zlib-devel</strong></p>
</li>
<li><p>openssl<br>  OpenSSL 是一个强大的安全套接字层密码库，囊括主要的密码算法、常用的密钥和证书封装管理功能及SSL协议，并提供丰富的应用程序供测试或其它目的使用。<br>nginx不仅支持http协议，还支持https（即在ssl协议上传输http），所以需要在linux安装openssl库。<br>  <strong>yum install -y openssl openssl-devel</strong></p>
</li>
<li><p>一键安装依赖包 <strong>yum -y install zlib zlib-devel openssl openssl–devel pcre pcre-devel</strong>     </p>
</li>
</ul>
</li>
<li><p>解压Nginx源码包  </p>
</li>
<li><p>使用configure创建makefile</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">./configure \</div><div class="line">--prefix=/usr/local/nginx \</div><div class="line">--pid-path=/var/run/nginx/nginx.pid \</div><div class="line">--lock-path=/var/lock/nginx.lock \</div><div class="line">--error-log-path=/var/log/nginx/error.log \</div><div class="line">--http-log-path=/var/log/nginx/access.log \</div><div class="line">--with-http_gzip_static_module \</div><div class="line">--http-client-body-temp-path=/var/temp/nginx/client \</div><div class="line">--http-proxy-temp-path=/var/temp/nginx/proxy \</div><div class="line">--http-fastcgi-temp-path=/var/temp/nginx/fastcgi \</div><div class="line">--http-uwsgi-temp-path=/var/temp/nginx/uwsgi \</div><div class="line">--http-scgi-temp-path=/var/temp/nginx/scgi</div></pre></td></tr></table></figure>
<ol>
<li><p>make &amp; make install</p>
</li>
<li><p>cd /usr/local/nginx/sbin 目录 </p>
<ul>
<li><p><strong>./nginx</strong> 开启<code>Nginx</code></p>
</li>
<li><p><strong>./nginx -s stop</strong> 关闭<code>Nginx</code></p>
</li>
<li><p><strong>./nginx -s reload</strong> 重新加载<code>Nginx</code>配置文件</p>
</li>
</ul>
</li>
</ol>
<h3 id="Nginx配置文件"><a href="#Nginx配置文件" class="headerlink" title="Nginx配置文件"></a>Nginx配置文件</h3><p><img src="http://ww4.sinaimg.cn/mw690/63503acbjw1f67o1jecrjj20ic0jwdj6.jpg" alt=""></p>
<p>nginx.conf是<code>Nginx</code>的主要配置文件,它的主要结构如下</p>
<ul>
<li><p>worker_process表示工作进程的数量，一般设置为cpu的核数</p>
</li>
<li><p>worker_connections表示每个工作进程的最大连接数</p>
</li>
<li><p>server{} 定义了一个虚拟机,如果要添加一个虚拟机,则添加一个server{}即可。</p>
<ul>
<li><p>listen监听的端口</p>
</li>
<li><p>server_name监听的域名</p>
</li>
<li><p>location{}配置匹配的URI</p>
<ul>
<li><p>root 指定URI查找的资源路径,为相对路径。</p>
</li>
<li><p>index 指定首页的名称,可以配置多个。</p>
</li>
<li><p>proxy_pass 指定反向代理转发的路径。</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Nginx配置负载均衡"><a href="#Nginx配置负载均衡" class="headerlink" title="Nginx配置负载均衡"></a>Nginx配置负载均衡</h3><p><img src="http://ww4.sinaimg.cn/mw690/63503acbjw1f67o1j87tcj20cf08pq44.jpg" alt=""></p>
<p>对upstream test{}中的2个web服务器配置了负载均衡,weight设置权值,权值越高的服务器承载的压力就越大。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sylvanassun.github.io/2016/06/24/2016-06-24-nginx-initiation/" data-id="cj4z0jkao0008uomjtwkocd93" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Nginx/">Nginx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端开发/">后端开发</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016-06-19-lucene" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/19/2016-06-19-lucene/" class="article-date">
  <time datetime="2016-06-18T16:00:00.000Z" itemprop="datePublished">2016-06-19</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/19/2016-06-19-lucene/">使用Lucene实现全文检索</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="1-Lucene介绍"><a href="#1-Lucene介绍" class="headerlink" title="1. Lucene介绍"></a>1. Lucene介绍</h3><p> Lucene是apache下的一个开源的全文检索引擎工具包,但它不是一个完整的全文检索引擎,而是一个全文检索引擎的架构,提供了完整的查询引擎和索引引擎,部分文本分析引擎（英文与德文两种西方语言）。<br>它为软件开发人员提供一个简单易用的工具包（类库）,以方便的在目标系统中实现全文检索的功能。</p>
<h4 id="全文检索"><a href="#全文检索" class="headerlink" title="全文检索"></a>全文检索</h4><p> 全文检索首先将要查询的目标文档中的词提取出来，组成索引，通过查询索引达到搜索目标文档的目的。这种先建立索引，再对索引进行搜索的过程就叫全文检索（Full-text Search）。</p>
<h4 id="Lucene的优点"><a href="#Lucene的优点" class="headerlink" title="Lucene的优点"></a>Lucene的优点</h4><ol>
<li>索引文件格式独立于应用平台。Lucene定义了一套以8位字节为基础的索引文件格式，使得兼容系统或者不同平台的应用能够共享建立的索引文件。</li>
<li>在传统全文检索引擎的倒排索引的基础上，实现了分块索引，能够针对新的文件建立小文件索引，提升索引速度。然后通过与原有索引的合并，达到优化的目的。</li>
<li>优秀的面向对象的系统架构，使得对于Lucene扩展的学习难度降低，方便扩充新功能。</li>
<li>设计了独立于语言和文件格式的文本分析接口，索引器通过接受Token流完成索引文件的创立，用户扩展新的语言和文件格式，只需要实现文本分析的接口。</li>
<li>已经默认实现了一套强大的查询引擎，用户无需自己编写代码即可使系统可获得强大的查询能力，Lucene的查询实现中默认实现了布尔操作、模糊查询（Fuzzy Search[11]）、分组查询等等。</li>
</ol>
<h3 id="2-Lucene检索流程"><a href="#2-Lucene检索流程" class="headerlink" title="2. Lucene检索流程"></a>2. Lucene检索流程</h3><p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f67nt0n317j20o60l80u0.jpg" alt=""></p>
<ul>
<li>创建索引流程:Gather Data(采集数据) –&gt; 构造文档对象 –&gt; 分词 –&gt; 创建索引并存入索引库</li>
<li>搜索流程:用户发起搜索请求 –&gt; 创建查询对象 –&gt; 从索引库中搜索 –&gt; 渲染并返回搜索结果</li>
</ul>
<h3 id="3-索引的逻辑结构"><a href="#3-索引的逻辑结构" class="headerlink" title="3. 索引的逻辑结构"></a>3. 索引的逻辑结构</h3><ul>
<li>一个非结构化的数据统一格式为<code>document</code>文档,一个<code>document</code>可以有多个<code>field</code>。</li>
<li>当用户搜索时,Lucene会从索引域中搜索,并找到对应的<code>document</code>,将<code>document</code>中的<code>filed</code>进行分词,然后根据分词创建索引。</li>
</ul>
<h3 id="4-创建索引"><a href="#4-创建索引" class="headerlink" title="4. 创建索引"></a>4. 创建索引</h3><h4 id="创建索引的流程"><a href="#创建索引的流程" class="headerlink" title="创建索引的流程"></a>创建索引的流程</h4><p><img src="http://ww1.sinaimg.cn/mw690/63503acbjw1f67nv272uaj20ag0fumxd.jpg" alt=""></p>
<ol>
<li>IndexWriter是核心对象,它可以完成创建索引、更新索引、删除索引等操作。</li>
<li>Directory负责对索引进行存储,它是一个抽象类,子类为FSDirectory(文件中存储)、RAMDirectory(内存中存储)</li>
</ol>
<h4 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createIndex</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="comment">// 获得原始数据</span></div><div class="line">	ItemsDao itemsDao = <span class="keyword">new</span> ItemsDaoImpl();</div><div class="line">	List&lt;Items&gt; items = itemsDao.findAllItems();</div><div class="line">	<span class="comment">// 创建Document</span></div><div class="line">	List&lt;Document&gt; documents = <span class="keyword">new</span> ArrayList&lt;Document&gt;();</div><div class="line">	Document document = <span class="keyword">null</span>;</div><div class="line">	<span class="comment">// 遍历原始数据并封装到field</span></div><div class="line">	<span class="keyword">for</span> (Items item : items) &#123;</div><div class="line">		document = <span class="keyword">new</span> Document();</div><div class="line">		<span class="comment">/**</span></div><div class="line">		 * 参数1:field的域名 参数2:要封装的数据 参数3:是否存储</div><div class="line">		 */</div><div class="line">		Field name = <span class="keyword">new</span> TextField(<span class="string">"name"</span>, item.getName(), Store.YES);</div><div class="line">		Field id = <span class="keyword">new</span> StringField(<span class="string">"id"</span>, item.getId().toString(), Store.YES);</div><div class="line">		Field price = <span class="keyword">new</span> TextField(<span class="string">"price"</span>, item.getPrice().toString(), Store.YES);</div><div class="line">		<span class="comment">// 将field封装到document</span></div><div class="line">		document.add(name);</div><div class="line">		document.add(id);</div><div class="line">		document.add(price);</div><div class="line"></div><div class="line">		documents.add(document);</div><div class="line">	&#125;</div><div class="line">	<span class="comment">// 创建一个标准分析器</span></div><div class="line">	Analyzer analyzer = <span class="keyword">new</span> StandardAnalyzer();</div><div class="line">	<span class="comment">// 索引库目录</span></div><div class="line">	Directory directory = FSDirectory.open(<span class="keyword">new</span> File(<span class="string">"D:\\Repository\\indexDatabase\\test"</span>));</div><div class="line">	<span class="comment">// 创建IndexWriterConfig</span></div><div class="line">	IndexWriterConfig indexWriterConfig = <span class="keyword">new</span> IndexWriterConfig(analyzer);</div><div class="line">	IndexWriter indexWriter = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="comment">// 创建IndexWriter</span></div><div class="line">		indexWriter = <span class="keyword">new</span> IndexWriter(directory, indexWriterConfig);</div><div class="line">		<span class="keyword">for</span> (Document doc : documents) &#123;</div><div class="line">			indexWriter.addDocument(doc);</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">		e.printStackTrace();</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		<span class="comment">// 关闭IndexWriter</span></div><div class="line">		indexWriter.close();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="5-搜索索引"><a href="#5-搜索索引" class="headerlink" title="5. 搜索索引"></a>5. 搜索索引</h3><h4 id="使用QueryParse"><a href="#使用QueryParse" class="headerlink" title="使用QueryParse"></a>使用QueryParse</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">searchIndex</span><span class="params">()</span> <span class="keyword">throws</span> ParseException </span>&#123;</div><div class="line">	<span class="comment">// 创建标准分析器</span></div><div class="line">	Analyzer analyzer = <span class="keyword">new</span> StandardAnalyzer();</div><div class="line">	<span class="comment">// 创建QueryParser,c</span></div><div class="line">	<span class="comment">// 参数1:Field域名 参数2:分析器</span></div><div class="line">	QueryParser queryParser = <span class="keyword">new</span> QueryParser(<span class="string">"name"</span>, analyzer);</div><div class="line">	<span class="comment">// 创建Query 查找name为冰箱的</span></div><div class="line">	Query query = queryParser.parse(<span class="string">"name:冰箱"</span>);</div><div class="line">	<span class="comment">// 索引库目录</span></div><div class="line">	Directory directory = FSDirectory.open(<span class="keyword">new</span> File(<span class="string">"D:\\Repository\\indexDatabase\\test"</span>));</div><div class="line">	IndexReader indexReader = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="comment">// 创建IndexReader</span></div><div class="line">		indexReader = DirectoryReader.open(directory);</div><div class="line">		<span class="comment">// 创建IndexSearcher</span></div><div class="line">		IndexSearcher indexSearcher = <span class="keyword">new</span> IndexSearcher(indexReader);</div><div class="line">		<span class="comment">// 执行搜索,并返回TopDoc对象 参数1:query对象 参数2:最大记录数</span></div><div class="line">		TopDocs topDocs = indexSearcher.search(query, <span class="number">10</span>);</div><div class="line">		<span class="comment">// 获得TopDocs中的记录对象</span></div><div class="line">		ScoreDoc[] scoreDocs = topDocs.scoreDocs;</div><div class="line">		<span class="keyword">for</span> (ScoreDoc scoreDoc : scoreDocs) &#123;</div><div class="line">			<span class="comment">// 获得doc的ID</span></div><div class="line">			<span class="keyword">int</span> docId = scoreDoc.doc;</div><div class="line">			<span class="comment">// 根据id查找到doc</span></div><div class="line">			Document doc = indexSearcher.doc(docId);</div><div class="line">			<span class="comment">// 打印数据</span></div><div class="line">			System.out.println(<span class="string">"商品名: "</span> + doc.get(<span class="string">"name"</span>));</div><div class="line">			System.out.println(<span class="string">"价格: "</span> + doc.get(<span class="string">"price"</span>));</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">		e.printStackTrace();</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		<span class="comment">// 关闭reader</span></div><div class="line">		indexReader.close();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="使用Query的子类"><a href="#使用Query的子类" class="headerlink" title="使用Query的子类"></a>使用Query的子类</h4><p><strong>TermQuery</strong></p>
<p>TermQuery使用搜索关键词进行查询。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">searcher</span><span class="params">(Query query)</span> </span>&#123;</div><div class="line">	<span class="comment">// 索引库</span></div><div class="line">	Directory directory = FSDirectory.open(<span class="keyword">new</span> File(<span class="string">"D:\\Repository\\indexDatabase\\test"</span>));</div><div class="line">	<span class="comment">// IndexReader</span></div><div class="line">	IndexReader reader = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		reader = DirectoryReader.open(directory);</div><div class="line">		<span class="comment">// IndexSearcher</span></div><div class="line">		IndexSearcher searcher = <span class="keyword">new</span> IndexSearcher(reader);</div><div class="line">		TopDocs topDocs = searcher.search(query, <span class="number">10</span>);</div><div class="line">		ScoreDoc[] scoreDocs = topDocs.scoreDocs;</div><div class="line">		<span class="keyword">for</span> (ScoreDoc scoreDoc : scoreDocs) &#123;</div><div class="line">			<span class="keyword">int</span> docId = scoreDoc.doc;</div><div class="line">			Document document = searcher.doc(docId);</div><div class="line">			System.out.println(<span class="string">"商品id :"</span> + document.get(<span class="string">"id"</span>));</div><div class="line">			System.out.println(<span class="string">"商品名称 :"</span> + document.get(<span class="string">"name"</span>));</div><div class="line">			System.out.println(<span class="string">"商品价格 :"</span> + document.get(<span class="string">"price"</span>));</div><div class="line">		&#125;</div><div class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">		e.printStackTrace();</div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line">		reader.close();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">termQuery</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="comment">// 创建TermQuery 查询name中有冰箱的 等效于 name:冰箱</span></div><div class="line">	Query query = <span class="keyword">new</span> TermQuery(<span class="keyword">new</span> Term(<span class="string">"name"</span>, <span class="string">"冰箱"</span>));</div><div class="line">	searcher(query);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>NumericRangeQuery</strong></p>
<p>数字范围查询</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">numericRangeQuery</span><span class="params">()</span></span>&#123;</div><div class="line">	<span class="comment">// 创建查询</span></div><div class="line">	<span class="comment">// 第一个参数：域名</span></div><div class="line">	<span class="comment">// 第二个参数：最小值</span></div><div class="line">	<span class="comment">// 第三个参数：最大值</span></div><div class="line">	<span class="comment">// 第四个参数：是否包含最小值</span></div><div class="line">	<span class="comment">// 第五个参数：是否包含最大值</span></div><div class="line">	Query query = NumericRangeQuery.newLongRange(<span class="string">"price"</span>, l00, <span class="number">1000</span>, <span class="keyword">true</span>,<span class="keyword">true</span>);</div><div class="line">	<span class="comment">// 2、 执行搜索</span></div><div class="line">	searcher(query);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>BooleanQuery</strong></p>
<p>布尔查询,用于组合条件查询。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">   <span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">booleanQuery</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">	BooleanQuery query = <span class="keyword">new</span> BooleanQuery();</div><div class="line">	Query query1 = <span class="keyword">new</span> TermQuery(<span class="keyword">new</span> Term(<span class="string">"id"</span>, <span class="string">"3"</span>));</div><div class="line">	Query query2 = NumericRangeQuery.newFloatRange(<span class="string">"price"</span>, <span class="number">10f</span>, <span class="number">200f</span>,</div><div class="line">			<span class="keyword">true</span>, <span class="keyword">true</span>);</div><div class="line"></div><div class="line">	<span class="comment">//MUST：查询条件必须满足，相当于AND</span></div><div class="line">	<span class="comment">//SHOULD:查询条件可选，相当于OR</span></div><div class="line">	<span class="comment">//MUST_NOT：查询条件不能满足，相当于NOT非</span></div><div class="line">	query.add(query1, Occur.MUST);</div><div class="line">	query.add(query2, Occur.SHOULD);</div><div class="line">	</div><div class="line">	System.out.println(query);</div><div class="line"></div><div class="line">	searcher(query);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ol>
<li>MUST和MUST表示“与”的关系，即“交集”。 </li>
<li>MUST和MUST_NOT前者包含后者不包含。</li>
<li>MUST_NOT和MUST_NOT没有结果,没有意义。</li>
<li>SHOULD与MUST表示MUST，SHOULD失去意义。</li>
<li>SHOUlD与MUST_NOT相当于MUST与MUST_NOT。</li>
<li>SHOULD与SHOULD表示“或”的概念。</li>
</ol>
<h3 id="6-删除索引"><a href="#6-删除索引" class="headerlink" title="6. 删除索引"></a>6. 删除索引</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deleteIndex</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="comment">// 指定索引库</span></div><div class="line">		Directory directory = FSDirectory.open(<span class="keyword">new</span> File(<span class="string">"D:\\Repository\\indexDatabase\\test"</span>));</div><div class="line">		<span class="comment">// 创建IndexWriterConfig</span></div><div class="line">		IndexWriterConfig indexWriterConfig = <span class="keyword">new</span> IndexWriterConfig(<span class="keyword">new</span> StandardAnalyzer());</div><div class="line">		<span class="comment">// 创建IndexWriter</span></div><div class="line">		IndexWriter indexWriter = <span class="keyword">new</span> IndexWriter(directory, indexWriterConfig);</div><div class="line">		<span class="comment">// 删除指定的索引</span></div><div class="line">		indexWriter.deleteDocuments(<span class="keyword">new</span> Term(<span class="string">"name"</span>,<span class="string">"冰箱"</span>));</div><div class="line">		<span class="comment">// 关闭indexWriter</span></div><div class="line">		indexWriter.close();</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<h3 id="7-修改索引"><a href="#7-修改索引" class="headerlink" title="7. 修改索引"></a>7. 修改索引</h3><p>在Lucene中修改索引即是替换索引,先将原来的索引删除,再保存新的索引。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">modifyIndex</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="comment">// 指定索引库</span></div><div class="line">	Directory directory = FSDirectory.open(<span class="keyword">new</span> File(<span class="string">"D:\\Repository\\indexDatabase\\test"</span>));</div><div class="line">	<span class="comment">// IndexWriterConfig</span></div><div class="line">	IndexWriterConfig indexWriterConfig = <span class="keyword">new</span> IndexWriterConfig(<span class="keyword">new</span> StandardAnalyzer());</div><div class="line">	<span class="comment">// IndexWriter</span></div><div class="line">	IndexWriter indexWriter = <span class="keyword">new</span> IndexWriter(directory, indexWriterConfig);</div><div class="line">	<span class="comment">// 创建一个Document</span></div><div class="line">	Document document = <span class="keyword">new</span> Document();</div><div class="line">	Field name = <span class="keyword">new</span> TextField(<span class="string">"name"</span>, <span class="string">"比利海灵顿"</span>, Store.YES);</div><div class="line">	document.add(name);</div><div class="line">	<span class="comment">// 修改索引</span></div><div class="line">	indexWriter.updateDocument(<span class="keyword">new</span> Term(<span class="string">"name"</span>, <span class="string">"冰箱"</span>), document);</div><div class="line">	indexWriter.close();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="8-相关度排序"><a href="#8-相关度排序" class="headerlink" title="8. 相关度排序"></a>8. 相关度排序</h3><p>Lucene通过计算Term的权重,对查询关键字和索引文档的相关度进行打分,分越高的就排在越前面。</p>
<p>影响Term的权重有两个因素:</p>
<ul>
<li>Term Frequency:Term在文档中的出现频率,次数越多,则代表这个Term对该文档越重要,即权重越高。</li>
<li>Document Frequency:指多少文档包含这个Term的频率,频率越高,则代表这个Term越不重要,即权重越低。</li>
</ul>
<h4 id="手动设置权值"><a href="#手动设置权值" class="headerlink" title="手动设置权值"></a>手动设置权值</h4><p><strong>在创建索引时设置权值</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">  <span class="keyword">for</span> (Items item : items) &#123;</div><div class="line">	document = <span class="keyword">new</span> Document();</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 参数1:field的域名 参数2:要封装的数据 参数3:是否存储</div><div class="line">	 */</div><div class="line">	Field name = <span class="keyword">new</span> TextField(<span class="string">"name"</span>, item.getName(), Store.YES);</div><div class="line">	Field id = <span class="keyword">new</span> StringField(<span class="string">"id"</span>, item.getId().toString(), Store.YES);</div><div class="line">	Field price = <span class="keyword">new</span> TextField(<span class="string">"price"</span>, item.getPrice().toString(), Store.YES);</div><div class="line">	<span class="comment">// 给name域增加权值</span></div><div class="line">	name.setBoost(<span class="number">100f</span>);</div><div class="line">	<span class="comment">// 将field封装到document</span></div><div class="line">	document.add(name);</div><div class="line">	document.add(id);</div><div class="line">	document.add(price);</div><div class="line"></div><div class="line">	documents.add(document);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>在搜索时设置权值</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBoosts</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		<span class="comment">// 搜索的域名数组</span></div><div class="line">		String[] fields = &#123; <span class="string">"name"</span>, <span class="string">"price"</span> &#125;;</div><div class="line">		<span class="comment">// 设置权值</span></div><div class="line">		Map&lt;String, Float&gt; boosts = <span class="keyword">new</span> HashMap&lt;String, Float&gt;();</div><div class="line">		<span class="comment">// 给name域设置权重</span></div><div class="line">		boosts.put(<span class="string">"name"</span>, <span class="number">100f</span>);</div><div class="line">		<span class="comment">// 创建MultiFieldQueryParse</span></div><div class="line">		MultiFieldQueryParser multiFieldQueryParser = <span class="keyword">new</span> MultiFieldQueryParser(fields, <span class="keyword">new</span> StandardAnalyzer(), boosts);</div><div class="line">		<span class="comment">// 创建Query</span></div><div class="line">		Query query = multiFieldQueryParser.parse(<span class="string">"冰箱"</span>);</div><div class="line">		searcher(query);</div><div class="line">	&#125;</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sylvanassun.github.io/2016/06/19/2016-06-19-lucene/" data-id="cj4z0jkai0004uomjcqfjgvze" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Lucene/">Lucene</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/全文检索引擎/">全文检索引擎</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端开发/">后端开发</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016-06-17-springmvc-02" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/17/2016-06-17-springmvc-02/" class="article-date">
  <time datetime="2016-06-16T16:00:00.000Z" itemprop="datePublished">2016-06-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/17/2016-06-17-springmvc-02/">Spring MVC进阶应用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Spring-MVC-进阶应用"><a href="#Spring-MVC-进阶应用" class="headerlink" title="Spring MVC 进阶应用"></a>Spring MVC 进阶应用</h2><h3 id="参数绑定"><a href="#参数绑定" class="headerlink" title="参数绑定"></a>参数绑定</h3><p> 客户端发送请求时传递的参数默认是键值对格式,<code>Spring MVC</code>通过参数绑定组件将请求的参数串进行类型转换。<br> <code>Spring MVC</code>使用Controller方法的形参接收请求传来的参数。</p>
<h4 id="1-Spring-MVC默认内置的形参类型"><a href="#1-Spring-MVC默认内置的形参类型" class="headerlink" title="1. Spring MVC默认内置的形参类型"></a>1. Spring MVC默认内置的形参类型</h4><ul>
<li>HttpServletRequest </li>
<li>HttpServletResponse </li>
<li>HttpSession </li>
<li>Model 一个接口,可以将数据填充到request域对象中。</li>
<li>ModelMap Model接口的实现。</li>
</ul>
<p>这5个对象可以直接通过形参注入并使用。</p>
<h4 id="2-简单数据类型绑定"><a href="#2-简单数据类型绑定" class="headerlink" title="2. 简单数据类型绑定"></a>2. 简单数据类型绑定</h4><p>前端页面表单中的name或者URL中的key与Controller方法中的形参名称一致,即可完成绑定。<br>如果名称不一致,可以使用<code>@RequestParam</code>注解指定名称完成绑定。<br>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">URL: http:<span class="comment">//xxxxx?SID=1</span></div><div class="line"></div><div class="line">Controller:</div><div class="line"><span class="comment">// 将SID的数据封装到形参id中。</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">update</span> <span class="params">(@RequestParam(<span class="string">"SID"</span>)</span> Integer id,Model model)</span></div></pre></td></tr></table></figure>
<p><strong>RequestParam注解</strong></p>
<ul>
<li>value:参数名,即传入参数的名称。</li>
<li>required:默认为true,表示请求中要有相应的参数,否则报错:Status 400 - Required Integer parameter ‘XXXX’ is not present</li>
<li>defaultValue:默认值,没有同名参数时,则使用默认值。</li>
</ul>
<h4 id="3-JavaBean对象类型绑定"><a href="#3-JavaBean对象类型绑定" class="headerlink" title="3. JavaBean对象类型绑定"></a>3. JavaBean对象类型绑定</h4><p>前端页面表单中的name或者URL中的key与JavaBean中的属性名进行匹配。<br>如果参数名称一致,则将参数绑定到JavaBean中的属性上。<br>如果JavaBean中包装了对象类型,传入参数的名称则需要按照 对象.属性 的格式编写,并且属性要与JavaBean中包装的对象中的属性名称一致。</p>
<h4 id="4-集合类型绑定"><a href="#4-集合类型绑定" class="headerlink" title="4. 集合类型绑定"></a>4. 集合类型绑定</h4><p><strong>数组类型绑定</strong><br>使用checkbox复选框时,会将参数绑定到一个数组中。<br>例如:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">前端页面:</div><div class="line">&lt;input type=<span class="string">"checkbox"</span> name=<span class="string">"cId"</span> value=<span class="string">"1"</span>&gt;</div><div class="line">&lt;input type=<span class="string">"checkbox"</span> name=<span class="string">"cId"</span> value=<span class="string">"2"</span>&gt;</div><div class="line"></div><div class="line">Controller:</div><div class="line"><span class="comment">// 使用一个数组接收复选框的参数</span></div><div class="line"> <span class="function"><span class="keyword">public</span> String <span class="title">delete</span> <span class="params">(Integer[] cId,Model model)</span></span></div></pre></td></tr></table></figure>
<p><strong>List集合类型绑定</strong><br>Controller不能直接在形参中定义List,需要在包装类中定义List。<br>页面中的编写格式: list名[index].属性名<br>例如:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">c:forEach</span> <span class="attr">items</span>=<span class="string">"$&#123;list&#125;"</span> <span class="attr">var</span>=<span class="string">"user"</span> <span class="attr">varStatus</span>=<span class="string">"status"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"list[$&#123;status.index&#125;].name"</span> <span class="attr">value</span>=<span class="string">"$&#123;user.name&#125;"</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">c:forEach</span>&gt;</span></div></pre></td></tr></table></figure>
<p><strong>Map集合类型绑定</strong><br>Controller不能直接在形参中定义Map,需要在包装类中定义Map。<br>页面中的编写格式:map名[‘key’]<br>例如:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">c:forEach</span> <span class="attr">items</span>=<span class="string">"$&#123;list&#125;"</span> <span class="attr">var</span>=<span class="string">"user"</span> <span class="attr">varStatus</span>=<span class="string">"status"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">td</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"map['name']"</span> <span class="attr">value</span>=<span class="string">"$&#123;user.name&#125;"</span> /&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">c:forEach</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="Converter"><a href="#Converter" class="headerlink" title="Converter"></a>Converter</h3><p>当请求参数中含有日期类型时,需要自定义一个类型转换器转换成我们需要的日期格式。<br>创建一个类实现Converter接口就可以自定义一个类型转换器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Converter&lt;需要转换的数据的类型,转换的类型&gt;</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DateConverter</span> <span class="keyword">implements</span> <span class="title">Converter</span>&lt;<span class="title">String</span>, <span class="title">Date</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> Date <span class="title">convert</span><span class="params">(String source)</span> </span>&#123;</div><div class="line">		<span class="keyword">try</span>&#123;</div><div class="line">			<span class="comment">// 转换日期格式</span></div><div class="line">			SimpleDateFormat format = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</div><div class="line">			<span class="keyword">return</span> format.parse(source);</div><div class="line">		&#125;<span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		<span class="comment">// 出现异常,则返回null</span></div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>之后需要在处理器适配器中注册Converter</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;!-- 注册注解方式的适配器与映射器 --&gt;</div><div class="line">&lt;mvc:annotation-driven conversion-service=<span class="string">"conversionService"</span> /&gt;</div><div class="line"></div><div class="line">&lt;bean id=<span class="string">"conversionService"</span></div><div class="line">	class=<span class="string">"org.springframework.format.support.FormattingConversionServiceFactoryBean"</span>&gt;</div><div class="line">	&lt;property name=<span class="string">"converters"</span>&gt;</div><div class="line">		&lt;list&gt;</div><div class="line">			&lt;!-- 日期类型转换器 --&gt;</div><div class="line">			&lt;bean class=<span class="string">"com.sun.ssm.converter.DateConverter"</span>&gt;&lt;/bean&gt;</div><div class="line">		&lt;/list&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
<h3 id="Validation"><a href="#Validation" class="headerlink" title="Validation"></a>Validation</h3><p>Spring MVC本身没有实现表现层校验的部分，它本身支持JSR 303校验规范，而这个规范的官方参考实现是hibernate validator。</p>
<p>所以Spring MVC想要实现校验,需要导入Hibernate-validator jar包。</p>
<p>在配置文件中配置validator校验器</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&lt;!-- 配置校验器 --&gt;</div><div class="line">&lt;bean id=<span class="string">"validator"</span> class=<span class="string">"org.springframework.validation.beanvalidation.LocalValidatorFactoryBean"</span>&gt;</div><div class="line">	&lt;!-- 校验器提供者 --&gt;</div><div class="line">	&lt;property name=<span class="string">"providerClass"</span> value=<span class="string">"org.hibernate.validator.HibernateValidator"</span> /&gt;</div><div class="line">	&lt;!-- 指定校验使用的资源文件，在文件中配置校验错误信息，</div><div class="line">			如果不指定，默认使用classpath下的ValidationMessages<span class="selector-class">.properties</span> </div><div class="line">	--&gt;</div><div class="line">	&lt;property name=<span class="string">"validationMessageSource"</span> ref=<span class="string">"messageSource"</span> /&gt;</div><div class="line">&lt;/bean&gt;</div><div class="line">	</div><div class="line">&lt;!-- 校验错误信息的资源文件 --&gt;</div><div class="line">&lt;bean id=<span class="string">"messageSource"</span> class=<span class="string">"org.springframework.context.support.ReloadableResourceBundleMessageSource"</span>&gt;</div><div class="line">	&lt;!-- 指定文件路径 --&gt;</div><div class="line">	&lt;property name=<span class="string">"basenames"</span>&gt;</div><div class="line">		&lt;list&gt;</div><div class="line">			&lt;value&gt;classpath:validationMessages&lt;/value&gt;</div><div class="line">		&lt;/list&gt;</div><div class="line">	&lt;/property&gt;</div><div class="line">	&lt;!-- 指定文件的编码 --&gt;</div><div class="line">	&lt;property name=<span class="string">"fileEncodings"</span> value=<span class="string">"utf8"</span>/&gt;</div><div class="line">	&lt;!-- 资源文件内容缓存的时间，单位秒 --&gt;</div><div class="line">	&lt;property name=<span class="string">"cacheSeconds"</span> value=<span class="string">"120"</span> /&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
<p>在处理器适配器中注册Validator</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&lt;!-- 注册注解方式的适配器与映射器 --&gt;</div><div class="line">&lt;mvc:annotation-driven conversion-service=<span class="string">"conversionService"</span> validator=<span class="string">"validator"</span> /&gt;</div></pre></td></tr></table></figure>
<p>在JavaBean中可以使用注解制定校验规则。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">ValidationMessages.properties:</div><div class="line">    user.username.size.error=用户名长度格式为<span class="number">1</span>-<span class="number">10</span>之间</div><div class="line"></div><div class="line">JavaBean:</div><div class="line"> <span class="meta">@Size</span>(min=<span class="number">1</span>,max=<span class="number">10</span>,message=<span class="string">"&#123;user.username.size.error&#125;"</span>)</div><div class="line"> <span class="keyword">private</span> String username;</div></pre></td></tr></table></figure>
<p>Controller中在需要检验的形参前使用<code>@Validated</code>注解,并在形参中注入一个BindingResult对象接收校验错误信息。<br><code>@Validated</code>注解和BindingResult顺序是固定的。(<code>@Validated</code>在前)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/updateUser"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">updateUser</span><span class="params">(@Validated User user,BindingResult bindingResult,Model model)</span> </span>&#123;</div><div class="line">    <span class="comment">// 判断是否有校验错误信息,如果有则代表校验未通过</span></div><div class="line">	<span class="keyword">if</span>(bindingResult.hasErrors())&#123;</div><div class="line">	    <span class="comment">// 获得校验错误信息集合</span></div><div class="line">		List&lt;ObjectError&gt; allErrors = bindingResult.getAllErrors();</div><div class="line">		<span class="comment">// 将校验错误信息集合存入request域中</span></div><div class="line">		model.addAttribute(<span class="string">"errors"</span>, allErrors);</div><div class="line">			</div><div class="line">		<span class="comment">//检验未通过,重新跳转到修改页面</span></div><div class="line">		<span class="keyword">return</span> <span class="string">"updateUser"</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>分组校验</strong></p>
<p>因为校验规则是在JavaBean中定义的,所以当同一个JavaBean需要被多个Controller使用时,可能根据需求需要不同的校验。</p>
<p>在这种情况下,可以使用一个标识作用的接口进行分组。</p>
<p>定义一个空接口作为分组的标识:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ValidationGroup</span> </span>&#123;</div><div class="line">	</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在JavaBean中使用分组:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Size</span>(min=<span class="number">1</span>,max=<span class="number">10</span>,message=<span class="string">"&#123;user.username.size.error&#125;"</span>,groups=&#123;ValidationGroup.class&#125;)</div><div class="line"><span class="keyword">private</span> String username;</div></pre></td></tr></table></figure>
<p>在Controller中使用分组校验:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/updateUser"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">updateUser</span><span class="params">(@Validated(value=&#123;ValidationGroup.class&#125;)</span> User user,</span></div><div class="line">                            BindingResult bindingResult,Model model) &#123;</div><div class="line">    <span class="comment">// 判断是否有校验错误信息,如果有则代表校验未通过</span></div><div class="line">	<span class="keyword">if</span>(bindingResult.hasErrors())&#123;</div><div class="line">	    <span class="comment">// 获得校验错误信息集合</span></div><div class="line">		List&lt;ObjectError&gt; allErrors = bindingResult.getAllErrors();</div><div class="line">		<span class="comment">// 将校验错误信息集合存入request域中</span></div><div class="line">		model.addAttribute(<span class="string">"errors"</span>, allErrors);</div><div class="line">			</div><div class="line">		<span class="comment">//检验未通过,重新跳转到修改页面</span></div><div class="line">		<span class="keyword">return</span> <span class="string">"updateUser"</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>主要的验证注解如下:</p>
<table>
<thead>
<tr>
<th>注解</th>
<th>适用的数据类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>@AssertFalse</td>
<td>Boolean, boolean</td>
<td>验证注解的元素值是false</td>
</tr>
<tr>
<td>@AssertTrue</td>
<td>Boolean, boolean</td>
<td>验证注解的元素值是true</td>
</tr>
<tr>
<td>@DecimalMax（value=x）</td>
<td>BigDecimal, BigInteger, String, byte,short, int, long and the respective wrappers of the primitive types. Additionally supported by HV: any sub-type of Number andCharSequence.</td>
<td>验证注解的元素值小于等于@ DecimalMax指定的value值</td>
</tr>
<tr>
<td>@DecimalMin（value=x）</td>
<td>BigDecimal, BigInteger, String, byte,short, int, long and the respective wrappers of the primitive types. Additionally supported by HV: any sub-type of Number andCharSequence.</td>
<td>验证注解的元素值小于等于@ DecimalMin指定的value值</td>
</tr>
<tr>
<td>@Digits(integer=整数位数, fraction=小数位数)</td>
<td>BigDecimal, BigInteger, String, byte,short, int, long and the respective wrappers of the primitive types. Additionally supported by HV: any sub-type of Number andCharSequence.</td>
<td>验证注解的元素值的整数位数和小数位数上限</td>
</tr>
<tr>
<td>@Future</td>
<td>java.util.Date, java.util.Calendar; Additionally supported by HV, if theJoda Time date/time API is on the class path: any implementations ofReadablePartial andReadableInstant.</td>
<td>验证注解的元素值（日期类型）比当前时间晚</td>
</tr>
<tr>
<td>@Max（value=x）</td>
<td>BigDecimal, BigInteger, byte, short,int, long and the respective wrappers of the primitive types. Additionally supported by HV: any sub-type ofCharSequence (the numeric value represented by the character sequence is evaluated), any sub-type of Number.</td>
<td>验证注解的元素值小于等于@Max指定的value值</td>
</tr>
<tr>
<td>@Min（value=x）</td>
<td>BigDecimal, BigInteger, byte, short,int, long and the respective wrappers of the primitive types. Additionally supported by HV: any sub-type of CharSequence (the numeric value represented by the char sequence is evaluated), any sub-type of Number.</td>
<td>验证注解的元素值大于等于@Min指定的value值</td>
</tr>
<tr>
<td>@NotNull</td>
<td>Any type</td>
<td>验证注解的元素值不是null</td>
</tr>
<tr>
<td>@Null</td>
<td>Any type</td>
<td>验证注解的元素值是null</td>
</tr>
<tr>
<td>@Past</td>
<td>java.util.Date, java.util.Calendar; Additionally supported by HV, if theJoda Time date/time API is on the class path: any implementations ofReadablePartial andReadableInstant.</td>
<td>验证注解的元素值（日期类型）比当前时间早</td>
</tr>
<tr>
<td>@Pattern(regex=正则表达式, flag=)</td>
<td>String. Additionally supported by HV: any sub-type of CharSequence.</td>
<td>验证注解的元素值与指定的正则表达式匹配</td>
</tr>
<tr>
<td>@Size(min=最小值, max=最大值)</td>
<td>String, Collection, Map and arrays. Additionally supported by HV: any sub-type of CharSequence.</td>
<td>验证注解的元素值的在min和max（包含）指定区间之内，如字符长度、集合大小</td>
</tr>
<tr>
<td>@Valid</td>
<td>Any non-primitive type（引用类型）</td>
<td>验证关联的对象，如账户对象里有一个订单对象，指定验证订单对象</td>
</tr>
<tr>
<td>@NotEmpty</td>
<td>CharSequence,Collection, Map and Arrays</td>
<td>验证注解的元素值不为null且不为空（字符串长度不为0、集合大小不为0）</td>
</tr>
<tr>
<td>@Range(min=最小值, max=最大值)</td>
<td>CharSequence, Collection, Map and Arrays,BigDecimal, BigInteger, CharSequence, byte, short, int, long and the respective wrappers of the primitive types</td>
<td>验证注解的元素值在最小值和最大值之间</td>
</tr>
<tr>
<td>@NotBlank</td>
<td>CharSequence</td>
<td>验证注解的元素值不为空（不为null、去除首位空格后长度为0），不同于@NotEmpty，@NotBlank只应用于字符串且在比较时会去除字符串的空格</td>
</tr>
<tr>
<td>@Length(min=下限, max=上限)</td>
<td>CharSequence</td>
<td>验证注解的元素值长度在min和max区间内</td>
</tr>
<tr>
<td>@Email</td>
<td>CharSequence</td>
<td>验证注解的元素值是Email，也可以通过正则表达式和flag指定自定义的email格式</td>
</tr>
</tbody>
</table>
<h3 id="数据回显"><a href="#数据回显" class="headerlink" title="数据回显"></a>数据回显</h3><p>Spring MVC默认支持数据回显。</p>
<p>Spring MVC会在Controller返回之前,自动将形参中的JavaBean放入Request域中,默认名称为类名首字母小写。<br>只要前端页面动态获取数据的key与JavaBean名称一致,即可完成数据回显。<br>如果名称不一致,也可以用<code>@ModelAttribute</code>注解指定形参放入Request域中的key名。</p>
<h3 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h3><p>Spring MVC使用Multipart解析器完成文件上传,而Multipart解析器需要依赖以下2个jar包:</p>
<ul>
<li>commons-fileupload</li>
<li>commons-io</li>
</ul>
<p><strong>配置Multipart解析器</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;bean id=<span class="string">"multipartResolver"</span> class=<span class="string">"org.springframework.web.multipart.commons.CommonsMultipartResolver"</span>&gt;</div><div class="line">    &lt;!-- 限制上传文件的最大长度 --&gt;</div><div class="line">    &lt;property name=<span class="string">"maxUploadSize"</span> value=<span class="string">"10*1024*1024"</span>/&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
<p>需要在Controller形参中注入一个MultipartFile对象接收文件,该对象名字要与传入的文件名相同。<br><strong>文件上传示例</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 判断是否上传了文件</span></div><div class="line"><span class="keyword">if</span>(file!= <span class="keyword">null</span>)&#123;</div><div class="line">		<span class="comment">//原始文件名称</span></div><div class="line">		String fileName = file.getOriginalFilename();</div><div class="line">		<span class="comment">//判断文件名是否为空</span></div><div class="line">		<span class="keyword">if</span>(fileName != <span class="keyword">null</span> &amp;&amp; !<span class="string">""</span>.equals(fileName))</div><div class="line">		&#123;</div><div class="line">			<span class="comment">// 文件存放的路径</span></div><div class="line">			String path = <span class="string">"D:\\temps\\"</span>;</div><div class="line">		    <span class="comment">// 判断文件存放路径是否存在</span></div><div class="line">		    File dirFile = <span class="keyword">new</span> File(path);</div><div class="line">		    <span class="comment">// 文件夹不存在,自动创建一个文件夹</span></div><div class="line">		    <span class="keyword">if</span>(!dirFile.exists()) &#123;</div><div class="line">		        dirFile.mkdirs();</div><div class="line">		    &#125;</div><div class="line">		    <span class="comment">// 使用UUID拼接一个唯一文件名</span></div><div class="line">			String newFileName = UUID.randomUUID()+fileName.substring(fileName.lastIndexOf(<span class="string">"."</span>));</div><div class="line">			<span class="comment">//新的文件</span></div><div class="line">			File newFile = <span class="keyword">new</span> File(path+newFileName);</div><div class="line">			<span class="comment">//把上传的文件保存成一个新的文件</span></div><div class="line">			file.transferTo(newFile);</div><div class="line">		&#125;</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<h3 id="Interceptor"><a href="#Interceptor" class="headerlink" title="Interceptor"></a>Interceptor</h3><p>Spring MVC的拦截器是针对处理器进行拦截的,当HandlerMapping查找处理器时,会被拦截器拦截。</p>
<p>可以通过实现HandlerIntercepter接口,自定义一个拦截器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHandlerInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span></span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">// Handler执行前调用,返回值为true则放行,false则不放行。</span></div><div class="line">	<span class="comment">// 应用场景:登录验证,权限授权</span></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request,HttpServletResponse response, </span></span></div><div class="line">	                    Object handler) <span class="keyword">throws</span> Exception &#123;</div><div class="line">		</div><div class="line">		</div><div class="line">		<span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">// Handler开始执行,并且在返回ModelAndView之前调用</span></div><div class="line">	<span class="comment">// 应用场景:操作ModelAndView对象</span></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest request,HttpServletResponse response, Object handler,</span></span></div><div class="line">			ModelAndView modelAndView) <span class="keyword">throws</span> Exception &#123;</div><div class="line">		</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="comment">// Handler执行完后调用</span></div><div class="line">	<span class="comment">// 应用场景:异常处理、日志</span></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request,</span></span></div><div class="line">			HttpServletResponse response, Object handler, Exception ex)</div><div class="line">			<span class="keyword">throws</span> Exception &#123;</div><div class="line">		</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>配置拦截器</strong></p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;!-- 配置全局拦截器 --&gt;</div><div class="line">&lt;mvc:interceptors&gt;</div><div class="line">	&lt;mvc:interceptor&gt;</div><div class="line">		&lt;!-- <span class="comment">/**表示所有URL和子URL路径 --&gt;</span></div><div class="line">		&lt;mvc:mapping path="/**" /&gt;</div><div class="line">		&lt;bean class="com.sun.interceptor.MyHandlerInterceptor" /&gt;</div><div class="line">	&lt;/mvc:interceptor&gt;</div><div class="line">&lt;/mvc:interceptors&gt;</div></pre></td></tr></table></figure>
<p><strong>拦截器的执行顺序</strong></p>
<ul>
<li>preHandle()为正向顺序执行,postHandle()和afterCompletion()为逆向顺序执行。</li>
<li>如果第一个拦截器返回值为false,那它之后所有的拦截器都不会执行。</li>
<li>如果一个拦截器返回值为false,那么它的postHandle()和afterCompletion()都不会执行。</li>
<li>只要有一个拦截器的返回值为false,则所有拦截器的postHandle()都不会执行。</li>
</ul>
<h3 id="RESTful"><a href="#RESTful" class="headerlink" title="RESTful"></a>RESTful</h3><blockquote>
<p>一种软件架构风格，设计风格而不是标准，只是提供了一组设计原则和约束条件。它主要用于客户端和服务器交互类的软件。基于这个风格设计的软件可以更简洁，更有层次，更易于实现缓存等机制。</p>
</blockquote>
<p>实现REST风格需要在DispatcherServlet中将url映射模式改为 / </p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;servlet-mapping&gt;</div><div class="line">    &lt;servlet-name&gt;springmvc&lt;/servlet-name&gt;</div><div class="line">    &lt;url-pattern&gt;/&lt;/url-pattern&gt;</div><div class="line">&lt;/servlet-mapping&gt;</div></pre></td></tr></table></figure>
<p>但是当映射模式为/时会把静态资源一起拦截,需要配置才能访问静态资源。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;mvc:resources location=<span class="string">"/js/"</span> mapping=<span class="string">"/js/**"</span>/&gt;</div><div class="line">&lt;mvc:resources location=<span class="string">"/css/"</span> mapping=<span class="string">"/css/**"</span>/&gt;</div><div class="line">&lt;mvc:resources location=<span class="string">"/jquery/"</span> mapping=<span class="string">"/jquery/**"</span>/&gt;</div></pre></td></tr></table></figure>
<p>Springmvc会把mapping映射到ResourceHttpRequestHandler，这样静态资源在经过DispatcherServlet转发时就可以找到对应的Handler了。</p>
<p><strong>在Controller中实现RESTful</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/update/&#123;id&#125;"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">update</span><span class="params">(@PathVariable Integer id,Model model)</span></span></div></pre></td></tr></table></figure>
<ul>
<li><code>@PathVariable</code>:将URL中的模板变量映射到形参上,如果形参与模板变量名称不一致,可以使用value=” “设置为模板变量的名称完成映射。</li>
<li>{id}:模板变量。例如URL为 xxxx/update/1,模板变量update/{id}就可以将1封装到{id}中。</li>
</ul>
<h3 id="JSON"><a href="#JSON" class="headerlink" title="JSON"></a>JSON</h3><p>Spring MVC默认使用MappingJacksonHttpMessageConverter对json数据进行转换，所以需要导入Jackson的jar包。</p>
<p>Spring MVC可以使用2个注解完成JSON数据的交互操作。</p>
<ul>
<li><code>@RequestBody</code>:如果请求参数传入的是json数据,使用<code>RequestBody</code>可以将json转换为java对象。</li>
<li><code>@ResponseBody</code>:将返回值的java对象转换为json输出。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sylvanassun.github.io/2016/06/17/2016-06-17-springmvc-02/" data-id="cj4z0jkab0001uomjq0oi0hmz" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpringMVC/">SpringMVC</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端开发/">后端开发</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016-06-15-springmvc-process" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/15/2016-06-15-springmvc-process/" class="article-date">
  <time datetime="2016-06-14T16:00:00.000Z" itemprop="datePublished">2016-06-15</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/15/2016-06-15-springmvc-process/">Spring MVC原理及流程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="Spring-MVC介绍"><a href="#Spring-MVC介绍" class="headerlink" title="Spring MVC介绍"></a>Spring MVC介绍</h3><ol>
<li>Spring MVC属于SpringFrameWork的后续产品，已经融合在Spring Web Flow里面。</li>
<li>通过策略接口，Spring MVC是高度可配置的，而且包含多种视图技术，例如 JavaServer Pages（JSP）、Velocity、Tiles、iText和POI。</li>
<li>使用 Spring 可插入的MVC架构，从而在使用Spring进行WEB开发时，可以选择使用Spring的SpringMVC框架或集成其他MVC开发框架，如Struts1，Struts2等。</li>
<li>Spring MVC是一个完全基于MVC模式(Model、View、Controller)的框架。</li>
</ol>
<h3 id="Spring-MVC工作原理"><a href="#Spring-MVC工作原理" class="headerlink" title="Spring MVC工作原理"></a>Spring MVC工作原理</h3><p><img src="http://ww1.sinaimg.cn/mw690/63503acbjw1f4v325kscyj20ui0qi776.jpg" alt=""></p>
<p>Spring MVC工作流程:</p>
<ol>
<li>用户发起请求。</li>
<li>DispatcherServlet接收到请求,并去调用HandlerMapping查找处理器。</li>
<li>HandlerMapping根据请求的URL查找对应的处理器,并返回给前端控制器DispatcherServlet。</li>
<li>DispatcherServlet调用HandlerAdapter执行处理器。</li>
<li>HandlerAdapter先判断处理器的类型进行适配,然后执行处理器。</li>
<li>处理器进行数据和业务请求的处理,将ModelAndView对象返回给HandlerAdapter。</li>
<li>HandlerAdapter将ModelAndView对象返回到前端控制器DispatcherServlet。</li>
<li>DispatcherServlet调用ViewResolver解析逻辑视图ModelAndView。</li>
<li>ViewResolver通过逻辑视图的名称查找对应的视图对象,并返回给前端控制器。</li>
<li>DispatcherServlet调用View渲染视图到前端。</li>
<li>响应处理的结果。</li>
</ol>
<p>Spring MVC主要由以下几个部分组成:</p>
<ul>
<li>前端控制器(DispatcherServlet):接收请求并响应到前端,并且负责各组件职责的分派。</li>
<li>处理器(Handler):处理数据与业务请求,Handler需要符合适配器的规则。</li>
<li>处理器映射器(HandlerMapping):根据每个请求的URL查找对应的处理器Handler。</li>
<li>处理器适配器(HandlerAdapter):根据类型适配每个处理器Handler并执行。</li>
<li>视图解析器(ViewResolver):根据逻辑视图的名称将逻辑视图解析为视图对象。</li>
<li>视图(View):在Spring MVC中,View是一个接口,通过不同的实现类支持不同的类型。(jsp、freemarker等)</li>
</ul>
<p>注：</p>
<ul>
<li>DispatcherServlet在创建时会默认从DispatcherServlet.properties中加载springmvc的各个组件配置。</li>
<li>如果在servletname-servlet.xml(Spring MVC配置文件)中配置了各个组件的配置则会优先使用servletname-servlet.xml中的配置。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sylvanassun.github.io/2016/06/15/2016-06-15-springmvc-process/" data-id="cj4z0jkak0005uomj9gbyll9s" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpringMVC/">SpringMVC</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端开发/">后端开发</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-2016-06-12-mybatis-study notes02" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/06/12/2016-06-12-mybatis-study notes02/" class="article-date">
  <time datetime="2016-06-11T16:00:00.000Z" itemprop="datePublished">2016-06-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/06/12/2016-06-12-mybatis-study notes02/">MyBatis学习笔记-02</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f4pf96s0tcj209302caa2.jpg" alt="MyBatis"></p>
<h3 id="关联映射"><a href="#关联映射" class="headerlink" title="关联映射"></a>关联映射</h3><h4 id="1-业务关系分析"><a href="#1-业务关系分析" class="headerlink" title="1. 业务关系分析"></a>1. 业务关系分析</h4><p>在进行多表关联查询之前,需要对表结构的关联关系与业务关系进行分析与理解。<br>下图以用户,订单,明细,商品表为例分析:<br><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f4tl89vexqj20fd0ba74p.jpg" alt="数据模型分析"></p>
<ul>
<li>用户表与订单表<ul>
<li>一个用户可以创建多个订单 (一对多)</li>
<li>一个订单只能由一个用户创建(一对一)</li>
</ul>
</li>
<li>订单表与明细表<ul>
<li>一个订单可以含有多个订单明细(一对多)</li>
<li>一个订单明细只能对应一个订单(一对一)</li>
</ul>
</li>
<li>明细表与商品表<ul>
<li>一个订单明细只能对应一个商品(一对一)</li>
<li>一个商品可以被包含在多个订单明细中(一对多)</li>
</ul>
</li>
<li>订单表与商品表 (间接关系)<ul>
<li>一个订单可以拥有多个订单明细,而一个订单明细对应一个商品,即一个订单可以拥有多个商品。<ul>
<li>order -&gt; orderdetail -&gt; items 一对多</li>
</ul>
</li>
<li>一个商品可以被包含在多个订单明细中,而一个订单明细对应一个订单,即一个商品可以被包含在多个订单中。<ul>
<li>item -&gt; orderdetail -&gt; order 一对多</li>
</ul>
</li>
<li>订单与商品是多对多关系。</li>
</ul>
</li>
<li>用户表与商品表 (间接关系)<ul>
<li>一个用户可以创建多个订单,一个订单可以对应多个订单明细,一个订单明细对应一个商品,即一个用户可以购买多个商品。<ul>
<li>user -&gt; order -&gt; orderdetail -&gt; item 一对多</li>
</ul>
</li>
<li>一个商品可以被包含在多个订单明细中,一个订单明细对应一个订单,一个订单对应一个用户,即一个商品可以对应多个用户。<ul>
<li>item -&gt; orderdetail -&gt; order -&gt; user 一对多</li>
</ul>
</li>
<li>用户与商品是多对多关系。</li>
</ul>
</li>
</ul>
<h4 id="2-一对一关联查询"><a href="#2-一对一关联查询" class="headerlink" title="2. 一对一关联查询"></a>2. 一对一关联查询</h4><blockquote>
<p>在多表查询时,单表的JavaBean不能满足结果集的映射,所以可以使用继承的方法来扩展JavaBean。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.sun.test.entity;</div><div class="line"></div><div class="line"><span class="comment">// Orders的扩展类</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrdersExtends</span> <span class="keyword">extends</span> <span class="title">Orders</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> User user;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> user;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUser</span><span class="params">(User user)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.user = user;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的做法与在Orders类中添加一个User类型的属性作用相同。</p>
<blockquote>
<p>映射文件配置</p>
</blockquote>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">&lt;mapper namespace=<span class="string">"com.sun.test.mapper.OrdersMapper"</span>&gt;</div><div class="line"></div><div class="line">	&lt;!-- selectOrdersAndUserRetMap --&gt;</div><div class="line">	&lt;!-- resultMap可以使用extends字段继承一个type一致的resultMap  --&gt;</div><div class="line">	&lt;resultMap type=<span class="string">"ordersExtends"</span> id=<span class="string">"selectOrdersAndUserRetMap"</span>&gt;</div><div class="line">		&lt;!-- 主键 --&gt;</div><div class="line">		&lt;id column=<span class="string">"id"</span> property=<span class="string">"id"</span> /&gt;</div><div class="line">		&lt;!-- 其他字段 --&gt;</div><div class="line">		&lt;result column=<span class="string">"user_id"</span> property=<span class="string">"userId"</span>/&gt;</div><div class="line">		&lt;result column=<span class="string">"number"</span> property=<span class="string">"number"</span>/&gt;</div><div class="line">		&lt;result column=<span class="string">"createtime"</span> property=<span class="string">"createtime"</span>/&gt;</div><div class="line">		&lt;result column=<span class="string">"note"</span> property=<span class="string">"note"</span>/&gt;  </div><div class="line">		&lt;!-- association:一对一映射</div><div class="line">			 	property:关联对象在JavaBean中封装的属性名</div><div class="line">			 	javaType:关联对象的Java类型</div><div class="line">		 --&gt;</div><div class="line">		&lt;association property=<span class="string">"user"</span> javaType=<span class="string">"com.sun.test.entity.User"</span>&gt;</div><div class="line">			&lt;id column=<span class="string">"user_id"</span> property=<span class="string">"id"</span>/&gt;</div><div class="line">			&lt;result column=<span class="string">"username"</span> property=<span class="string">"username"</span>/&gt;</div><div class="line">			&lt;result column=<span class="string">"address"</span> property=<span class="string">"address"</span>/&gt;			</div><div class="line">		&lt;/association&gt; </div><div class="line">	&lt;/resultMap&gt;</div><div class="line">	</div><div class="line">	&lt;!-- 查询订单与用户信息 --&gt;</div><div class="line">	&lt;select id=<span class="string">"selectOrdersAndUser"</span> resultMap=<span class="string">"selectOrdersAndUserRetMap"</span>&gt;</div><div class="line">		SELECT</div><div class="line">			orders<span class="selector-class">.id</span>,</div><div class="line">			orders<span class="selector-class">.user_id</span>,</div><div class="line">			orders<span class="selector-class">.number</span>,</div><div class="line">			orders<span class="selector-class">.createtime</span>,</div><div class="line">			orders<span class="selector-class">.note</span>,</div><div class="line">			`user`<span class="selector-class">.username</span>,</div><div class="line">			`user`<span class="selector-class">.address</span></div><div class="line">		FROM</div><div class="line">			orders,</div><div class="line">			`user`</div><div class="line">		WHERE orders<span class="selector-class">.user_id</span> = `user`<span class="selector-class">.id</span></div><div class="line">	&lt;/select&gt;</div><div class="line">	</div><div class="line">&lt;/mapper&gt;</div></pre></td></tr></table></figure>
<h4 id="3-一对多关联查询"><a href="#3-一对多关联查询" class="headerlink" title="3. 一对多关联查询"></a>3. 一对多关联查询</h4><blockquote>
<p>一对多查询与一对一查询类似,我们要查询商品以及订单明细则需要在商品类中扩展一个List集合。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Items</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Integer id;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String name;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Float price;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String pic;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Date createtime;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String detail;</div><div class="line">    </div><div class="line">    <span class="comment">// 一对多  一个商品对应多个订单明细</span></div><div class="line">    <span class="keyword">private</span> List&lt;Orderdetail&gt; orderdetails;</div></pre></td></tr></table></figure>
<blockquote>
<p>映射文件配置</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">&lt;mapper namespace="com.sun.test.mapper.ItemsMapper"&gt;</div><div class="line"></div><div class="line">	&lt;!-- (一对多)查询商品以及对应的订单明细 --&gt;</div><div class="line">	&lt;select id="selectItemsAndOrderdetail" resultMap="selectItemsAndOrderdetailRetMap"&gt;</div><div class="line">		SELECT</div><div class="line">			items.id,</div><div class="line">			items.`name`,</div><div class="line">			items.price,</div><div class="line">			orderdetail.id orderdetail_id,</div><div class="line">			orderdetail.items_num</div><div class="line">		FROM</div><div class="line">			items,</div><div class="line">			orderdetail</div><div class="line">		WHERE</div><div class="line">			items.id = orderdetail.items_id;</div><div class="line">	&lt;/select&gt;</div><div class="line"></div><div class="line">	&lt;!-- selectItemsAndOrderdetailRetMap --&gt;</div><div class="line">	&lt;resultMap type="items" id="selectItemsAndOrderdetailRetMap"&gt;</div><div class="line">		&lt;id column="id" property="id"/&gt;</div><div class="line">		&lt;result column="name" property="name"/&gt;</div><div class="line">		&lt;result column="price" property="price"/&gt;</div><div class="line">		&lt;!-- 一对多关联</div><div class="line">			 collection:一对多映射</div><div class="line">			 	ofType:这个集合参数的类型</div><div class="line">		 --&gt;</div><div class="line">		 &lt;collection property="orderdetails" ofType="orderdetail"&gt;</div><div class="line">		 	&lt;id column="orderdetail_id" property="id"/&gt;</div><div class="line">		 	&lt;result column="items_num" property="itemsNum"/&gt;</div><div class="line">		 &lt;/collection&gt;</div><div class="line">	&lt;/resultMap&gt;</div><div class="line"></div><div class="line">&lt;/mapper&gt;</div></pre></td></tr></table></figure>
<h4 id="4-多对多关联查询"><a href="#4-多对多关联查询" class="headerlink" title="4. 多对多关联查询"></a>4. 多对多关联查询</h4><blockquote>
<p>查询商品以及对应的用户信息。</p>
<ol>
<li>在商品类中添加一个订单明细集合(一个商品对应多个订单明细)</li>
<li>在订单明细类中添加一个订单属性(一个订单明细对应一个订单)</li>
<li>在订单类中添加一个用户属性(一个订单对应一个用户)</li>
</ol>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 一对多  一个商品对应多个订单明细</span></div><div class="line"><span class="keyword">private</span> List&lt;Orderdetail&gt; orderdetails;</div><div class="line"></div><div class="line"><span class="comment">// 一对一 一个订单明细对应一个订单</span></div><div class="line"><span class="keyword">private</span> Orders orders;</div><div class="line"></div><div class="line"><span class="comment">//一对一 一个订单对应一个用户</span></div><div class="line"><span class="keyword">private</span> User user;</div></pre></td></tr></table></figure>
<blockquote>
<p>映射文件配置</p>
</blockquote>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">&lt;!-- 查询商品以及对应的用户 --&gt;</div><div class="line">&lt;select id=<span class="string">"selectItemsAndUser"</span> resultMap=<span class="string">"selectItemsAndUserRetMap"</span>&gt;</div><div class="line">	SELECT</div><div class="line">		items<span class="selector-class">.id</span>,</div><div class="line">		items.`name`,</div><div class="line">		items<span class="selector-class">.price</span>,</div><div class="line">		`user`<span class="selector-class">.id</span> user_id,</div><div class="line">		`user`<span class="selector-class">.username</span>,</div><div class="line">		`user`<span class="selector-class">.address</span>,</div><div class="line">		orderdetail<span class="selector-class">.id</span> orderdetail_id,</div><div class="line">		orders<span class="selector-class">.id</span> orders_id</div><div class="line">	FROM</div><div class="line">		items,</div><div class="line">		orderdetail,</div><div class="line">		orders,</div><div class="line">		`user`</div><div class="line">	WHERE</div><div class="line">		items<span class="selector-class">.id</span> = orderdetail<span class="selector-class">.items_id</span></div><div class="line">	AND orderdetail<span class="selector-class">.orders_id</span> = orders<span class="selector-class">.id</span></div><div class="line">	AND orders<span class="selector-class">.user_id</span> = `user`<span class="selector-class">.id</span></div><div class="line">&lt;/select&gt;</div><div class="line"></div><div class="line">&lt;!-- selectItemsAndUserRetMap --&gt;</div><div class="line">&lt;resultMap type=<span class="string">"items"</span> id=<span class="string">"selectItemsAndUserRetMap"</span>&gt;</div><div class="line">	&lt;id column=<span class="string">"id"</span> property=<span class="string">"id"</span> /&gt;</div><div class="line">	&lt;result column=<span class="string">"name"</span> property=<span class="string">"name"</span>/&gt;</div><div class="line">	&lt;result column=<span class="string">"price"</span> property=<span class="string">"price"</span>/&gt;</div><div class="line">	&lt;!-- 一个商品对应多个订单明细  --&gt;</div><div class="line">	&lt;collection property=<span class="string">"orderdetails"</span> ofType=<span class="string">"orderdetail"</span>&gt;</div><div class="line">		&lt;id column=<span class="string">"orderdetail_id"</span> property=<span class="string">"id"</span>/&gt;</div><div class="line">		&lt;!-- 一个订单明细对应一个订单 --&gt;</div><div class="line">		&lt;association property=<span class="string">"orders"</span> javaType=<span class="string">"orders"</span>&gt;</div><div class="line">			&lt;id column=<span class="string">"orders_id"</span> property=<span class="string">"id"</span>/&gt;</div><div class="line">			&lt;!-- 一个订单对应一个用户 --&gt;</div><div class="line">			&lt;association property=<span class="string">"user"</span> javaType=<span class="string">"user"</span>&gt;</div><div class="line">				&lt;id column=<span class="string">"user_id"</span> property=<span class="string">"id"</span>/&gt;</div><div class="line">				&lt;result column=<span class="string">"username"</span> property=<span class="string">"username"</span>/&gt;</div><div class="line">				&lt;result column=<span class="string">"address"</span> property=<span class="string">"address"</span>/&gt;</div><div class="line">			&lt;/association&gt;</div><div class="line">		&lt;/association&gt;</div><div class="line">	&lt;/collection&gt;</div><div class="line">&lt;/resultMap&gt;</div></pre></td></tr></table></figure>
<h3 id="延迟加载"><a href="#延迟加载" class="headerlink" title="延迟加载"></a>延迟加载</h3><p>resultMap中的association和collection具有延迟加载的功能。</p>
<blockquote>
<p>延迟加载: 先加载主信息,在需要的时候加载关联信息,延迟加载即叫按需加载,也叫懒加载。</p>
</blockquote>
<h4 id="1-设置延迟加载"><a href="#1-设置延迟加载" class="headerlink" title="1. 设置延迟加载"></a>1. 设置延迟加载</h4><blockquote>
<p><code>MyBatis</code> 默认是关闭延迟加载的,需要在配置文件中的<settings>标签中手动开启。</settings></p>
</blockquote>
<table>
<thead>
<tr>
<th>settings</th>
<th>description</th>
<th>验证值组</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>lazyLoadingEnabled</td>
<td>全局性设置懒加载。</td>
<td>true</td>
<td>false</td>
<td>true</td>
</tr>
<tr>
<td>aggressiveLazyLoading</td>
<td>积极性的懒加载,false则是按需加载</td>
<td>true</td>
<td>false</td>
<td>true</td>
</tr>
</tbody>
</table>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;settings&gt;</div><div class="line">	&lt;!-- 开启延迟加载 ,默认值true--&gt;</div><div class="line">	&lt;setting name=<span class="string">"lazyLoadingEnabled"</span> value=<span class="string">"true"</span>/&gt;</div><div class="line">	&lt;!-- 设置积极的懒加载,默认值true --&gt;</div><div class="line">	&lt;setting name=<span class="string">"aggressiveLazyLoading"</span> value=<span class="string">"false"</span>/&gt;</div><div class="line">&lt;/settings&gt;</div></pre></td></tr></table></figure>
<h4 id="2-在association中使用延迟加载"><a href="#2-在association中使用延迟加载" class="headerlink" title="2. 在association中使用延迟加载"></a>2. 在association中使用延迟加载</h4><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">&lt;!-- 查询订单 并延迟加载用户信息 --&gt;</div><div class="line">	&lt;select id="selectOrdersAndLazyLoadingUser" resultMap="selectOrdersAndLazyLoadingUserRetMap"&gt;</div><div class="line">		SELECT * FROM orders</div><div class="line">	&lt;/select&gt;</div><div class="line">	</div><div class="line">	&lt;!-- selectOrdersAndLazyLoadingUserRetMap --&gt;</div><div class="line">	&lt;resultMap type="orders" id="selectOrdersAndLazyLoadingUserRetMap"&gt;</div><div class="line">		&lt;id column="id" property="id"/&gt;</div><div class="line">		&lt;result column="user_id" property="userId"/&gt;</div><div class="line">		&lt;result column="number" property="number"/&gt;</div><div class="line">		&lt;result column="createtime" property="createtime"/&gt;</div><div class="line">		&lt;result column="note" property="note"/&gt;</div><div class="line">		&lt;!-- 一对一关联并延迟加载用户信息</div><div class="line">			select:指定延迟加载执行的statementId</div><div class="line">			(如果这个statement不在当前namespace中那么则需要使用namespace.statementid)</div><div class="line">			column:需要关联查询的列，如果需要传入多个则需要使用 &#123;user_id=id,...&#125;的格式</div><div class="line">		 --&gt;</div><div class="line">		&lt;association property="user" column="user_id" </div><div class="line">			select="com.sun.test.mapper.UserMapper.findById"&gt;&lt;/association&gt;</div><div class="line">	&lt;/resultMap&gt;</div></pre></td></tr></table></figure>
<h3 id="查询缓存"><a href="#查询缓存" class="headerlink" title="查询缓存"></a>查询缓存</h3><h4 id="1-一级缓存"><a href="#1-一级缓存" class="headerlink" title="1. 一级缓存"></a>1. 一级缓存</h4><blockquote>
<p>一级缓存是SqlSession级别的缓存。在操作数据库时需要构造 sqlSession对象，在对象中有一个数据结构（HashMap）用于存储缓存数据。不同的sqlSession之间的缓存数据区域（HashMap）是互相不影响的。</p>
</blockquote>
<p><img src="http://ww3.sinaimg.cn/mw690/63503acbjw1f4u0a7gs9tj20d709ot8z.jpg" alt=""></p>
<blockquote>
<p>当第一次查询对象1时,将先会去一级缓存中查找是否有对象1的数据信息,如果没有则从数据库中查询到数据信息并构造一个key存储到一级缓存(HashMap)中。<br>当第二次查询对象1的时候，则可以凭借key在一级缓存中找到数据信息,而不用再去访问数据库。<br>如果SqlSession进行了事务提交(commit),则会刷新(清空)缓存,目的是为了让缓存存储最新的数据,防止脏读。<br><code>MyBatis</code>默认开启一级缓存。</p>
</blockquote>
<h4 id="2-二级缓存"><a href="#2-二级缓存" class="headerlink" title="2. 二级缓存"></a>2. 二级缓存</h4><blockquote>
<p>二级缓存是<strong>namespace</strong>(mapper)级别的缓存，多个SqlSession去操作同一个<strong>namespace</strong>中的mapper的sql语句，多个SqlSession可以共用二级缓存，二级缓存是跨SqlSession的。<br>二级缓存存储数据不一定是在内存中,所以需要给缓存的对象实现序列化接口。<br>二级缓存需要手动设置开启。</p>
</blockquote>
<h5 id="开启二级缓存"><a href="#开启二级缓存" class="headerlink" title="开启二级缓存"></a>开启二级缓存</h5><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">   在settings中设置</div><div class="line">&lt;!-- 开启二级缓存 --&gt;</div><div class="line">&lt;setting name=<span class="string">"cacheEnabled"</span> value=<span class="string">"true"</span>/&gt;</div><div class="line"></div><div class="line">在mapper映射文件中设置</div><div class="line">&lt;!-- 使用第三方(ehcache)二级缓存</div><div class="line">     flashInterval:设置定时刷新的间隔时间,单位是毫秒。</div><div class="line">     注:使用第三方缓存框架需要先导入jar包和整合包</div><div class="line">--&gt;</div><div class="line">   &lt;cache type=<span class="string">"org.mybatis.caches.ehcache.EhcacheCache"</span> flashInterval=<span class="string">"60000"</span> /&gt;</div></pre></td></tr></table></figure>
<h3 id="MyBatis与Spring整合"><a href="#MyBatis与Spring整合" class="headerlink" title="MyBatis与Spring整合"></a>MyBatis与Spring整合</h3><blockquote>
<p>由<code>Spring</code>维护管理数据源、事务、SqlSessionFactory、mapper。<br><code>MyBatis</code>的配置文件只需要配置settings、别名等即可。</p>
</blockquote>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Spring中的配置</div><div class="line">&lt;bean id=<span class="string">"sqlSessionFactory"</span> class=<span class="string">"org.mybatis.spring.SqlSessionFactoryBean"</span>&gt;</div><div class="line">	&lt;!-- mybatis的配置文件路径 --&gt;</div><div class="line">	&lt;property name=<span class="string">"configLocation"</span> value=<span class="string">"sqlMapConfig.xml"</span>&gt;&lt;/property&gt;</div><div class="line">	&lt;!-- 注入数据源 --&gt;</div><div class="line">	&lt;property name=<span class="string">"dataSource"</span> ref=<span class="string">"dataSource"</span>&gt;&lt;/property&gt;</div><div class="line">&lt;/bean&gt;</div><div class="line"></div><div class="line">批量生成Mapper(生成的Mapper名字默认为首字母)</div><div class="line">&lt;bean class=<span class="string">"org.mybatis.spring.mapper.MapperScannerConfigurer"</span>&gt;</div><div class="line">	&lt;!-- 指定需要扫描的mapper配置的包名 --&gt;</div><div class="line">	&lt;property name=<span class="string">"basePackage"</span> value=<span class="string">"com.sun.test.mapper"</span>&gt;&lt;/property&gt;</div><div class="line">	&lt;!-- 注入SqlSessionFactory --&gt;</div><div class="line">	&lt;property name=<span class="string">"sqlSessionFactoryBeanName"</span> value=<span class="string">"sqlSessionFactory"</span>&gt;&lt;/property&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="https://sylvanassun.github.io/2016/06/12/2016-06-12-mybatis-study notes02/" data-id="cj4z0jkam0007uomjff2e3yvy" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MyBatis/">MyBatis</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端开发/">后端开发</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/page/3/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/5/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/2017/">2017</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ActiveMQ/">ActiveMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hadoop/">Hadoop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HashMap/">HashMap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/">JVM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Lucene/">Lucene</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyBatis/">MyBatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyCat/">MyCat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringMVC/">SpringMVC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/solr/">solr</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/全文检索引擎/">全文检索引擎</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/后端开发/">后端开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多线程/">多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/大数据/">大数据</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库/">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构/">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/符号表/">符号表</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编程思想/">编程思想</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/2017/" style="font-size: 17.78px;">2017</a> <a href="/tags/ActiveMQ/" style="font-size: 10px;">ActiveMQ</a> <a href="/tags/Hadoop/" style="font-size: 14.44px;">Hadoop</a> <a href="/tags/HashMap/" style="font-size: 10px;">HashMap</a> <a href="/tags/JVM/" style="font-size: 12.22px;">JVM</a> <a href="/tags/Java/" style="font-size: 18.89px;">Java</a> <a href="/tags/Lucene/" style="font-size: 10px;">Lucene</a> <a href="/tags/MyBatis/" style="font-size: 12.22px;">MyBatis</a> <a href="/tags/MyCat/" style="font-size: 10px;">MyCat</a> <a href="/tags/Nginx/" style="font-size: 10px;">Nginx</a> <a href="/tags/Spring/" style="font-size: 15.56px;">Spring</a> <a href="/tags/SpringMVC/" style="font-size: 11.11px;">SpringMVC</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/solr/" style="font-size: 10px;">solr</a> <a href="/tags/全文检索引擎/" style="font-size: 11.11px;">全文检索引擎</a> <a href="/tags/后端开发/" style="font-size: 20px;">后端开发</a> <a href="/tags/多线程/" style="font-size: 10px;">多线程</a> <a href="/tags/大数据/" style="font-size: 14.44px;">大数据</a> <a href="/tags/数据库/" style="font-size: 10px;">数据库</a> <a href="/tags/数据结构/" style="font-size: 16.67px;">数据结构</a> <a href="/tags/符号表/" style="font-size: 13.33px;">符号表</a> <a href="/tags/算法/" style="font-size: 13.33px;">算法</a> <a href="/tags/编程思想/" style="font-size: 10px;">编程思想</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/06/27/2017-06-27-DynamicProgramming/">什么是动态规划?</a>
          </li>
        
          <li>
            <a href="/2017/06/16/2017-06-16-RedBlackTree/">红黑树那点事儿</a>
          </li>
        
          <li>
            <a href="/2017/06/14/2017-06-14-sort_algorithms_qucikSort/">深入浅出排序算法(3)-快速排序</a>
          </li>
        
          <li>
            <a href="/2017/06/12/2017-06-12-sort_algorithmes_mergeSort/">深入浅出排序算法(2)-归并排序</a>
          </li>
        
          <li>
            <a href="/2017/06/09/2017-06-09-sort_algorithms_heapSort/">深入浅出排序算法(1)-堆排序</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 SylvanasSun<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>