<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>ActiveMQ消息队列 | SylvanasSun Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="介绍&amp;nbsp;&amp;nbsp;ActiveMQ 是Apache出品，最流行的，能力强劲的开源消息总线。ActiveMQ 是一个完全支持JMS1.1和J2EE 1.4规范的 JMS Provider实现,尽管JMS规范出台已经是很久的事情了,但是JMS在当今的J2EE应用中间仍然扮演着特殊的地位。 主要特点：  多种语言和协议编写客户端。语言: Java, C, C++, C#, Ruby, Per">
<meta name="keywords" content="后端开发,ActiveMQ">
<meta property="og:type" content="article">
<meta property="og:title" content="ActiveMQ消息队列">
<meta property="og:url" content="https://sylvanassun.github.io/2016/07/03/2016-07-03-activemq/index.html">
<meta property="og:site_name" content="SylvanasSun Blog">
<meta property="og:description" content="介绍&amp;nbsp;&amp;nbsp;ActiveMQ 是Apache出品，最流行的，能力强劲的开源消息总线。ActiveMQ 是一个完全支持JMS1.1和J2EE 1.4规范的 JMS Provider实现,尽管JMS规范出台已经是很久的事情了,但是JMS在当今的J2EE应用中间仍然扮演着特殊的地位。 主要特点：  多种语言和协议编写客户端。语言: Java, C, C++, C#, Ruby, Per">
<meta property="og:image" content="http://ww1.sinaimg.cn/mw690/63503acbjw1f67ojz4j8kj20bk03djrj.jpg">
<meta property="og:image" content="http://ww2.sinaimg.cn/mw690/63503acbjw1f67ojyj0g8j20mf0fdwft.jpg">
<meta property="og:updated_time" content="2017-01-17T07:22:25.883Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ActiveMQ消息队列">
<meta name="twitter:description" content="介绍&amp;nbsp;&amp;nbsp;ActiveMQ 是Apache出品，最流行的，能力强劲的开源消息总线。ActiveMQ 是一个完全支持JMS1.1和J2EE 1.4规范的 JMS Provider实现,尽管JMS规范出台已经是很久的事情了,但是JMS在当今的J2EE应用中间仍然扮演着特殊的地位。 主要特点：  多种语言和协议编写客户端。语言: Java, C, C++, C#, Ruby, Per">
<meta name="twitter:image" content="http://ww1.sinaimg.cn/mw690/63503acbjw1f67ojz4j8kj20bk03djrj.jpg">
  
    <link rel="alternate" href="/atom.xml" title="SylvanasSun Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">SylvanasSun Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">SylvanasSun的博客 | SylvanasSun Blog</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://sylvanassun.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-2016-07-03-activemq" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/07/03/2016-07-03-activemq/" class="article-date">
  <time datetime="2016-07-03T10:00:00.000Z" itemprop="datePublished">2016-07-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      ActiveMQ消息队列
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="http://ww1.sinaimg.cn/mw690/63503acbjw1f67ojz4j8kj20bk03djrj.jpg" alt=""></p>
<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>&nbsp;&nbsp;ActiveMQ 是Apache出品，最流行的，能力强劲的开源消息总线。ActiveMQ 是一个完全支持JMS1.1和J2EE 1.4规范的 JMS Provider实现,尽管JMS规范出台已经是很久的事情了,但是JMS在当今的J2EE应用中间仍然扮演着特殊的地位。</p>
<p>主要特点：</p>
<ol>
<li>多种语言和协议编写客户端。语言: Java, C, C++, C#, Ruby, Perl, Python, PHP。应用协议: OpenWire,Stomp REST,WS Notification,XMPP,AMQP</li>
<li>完全支持JMS1.1和J2EE 1.4规范 (持久化,XA消息,事务)</li>
<li>对Spring的支持,ActiveMQ可以很容易内嵌到使用Spring的系统里面去,而且也支持Spring2.0的特性</li>
<li>通过了常见J2EE服务器(如 Geronimo,JBoss 4, GlassFish,WebLogic)的测试,其中通过JCA 1.5 resource adaptors的配置,可以让ActiveMQ可以自动的部署到任何兼容J2EE 1.4 商业服务器上</li>
<li>支持多种传送协议:in-VM,TCP,SSL,NIO,UDP,JGroups,JXTA</li>
<li>支持通过JDBC和journal提供高速的消息持久化</li>
<li>从设计上保证了高性能的集群,客户端-服务器,点对点</li>
<li>支持Ajax</li>
<li>支持与Axis的整合</li>
<li>可以很容易得调用内嵌JMS provider,进行测试</li>
</ol>
<h3 id="什么是JMS规范"><a href="#什么是JMS规范" class="headerlink" title="什么是JMS规范"></a>什么是JMS规范</h3><p>&nbsp;&nbsp;JMS的全称是Java MessageService，即Java消息服务。用于在两个应用程序之间，或分布式系统中发送消息，进行异步通信。<br>&nbsp;&nbsp;它主要用于在生产者和消费者之间进行消息传递，生产者负责产生消息，而消费者负责接收消息。把它应用到实际的业务需求中的话我们可以在特定的时候利用生产者生成一消息，并进行发送，对应的消费者在接收到对应的消息后去完成对应的业务逻辑。<br>&nbsp;&nbsp;对于消息的传递有两种类型：<br>一种是点对点的，即一个生产者和一个消费者一一对应；<br>另一种是发布/订阅模式，即一个生产者产生消息并进行发送后，可以由多个消费者进行接收。<br>JMS定义了五种不同的消息正文格式，以及调用的消息类型，允许你发送并接收以一些不同形式的数据，提供现有消息格式的一些级别的兼容性。</p>
<ul>
<li>StreamMessage – Java原始值的数据流</li>
<li>MapMessage–一套名称-值对</li>
<li>TextMessage–一个字符串对象</li>
<li>ObjectMessage–一个序列化的 Java对象</li>
<li>BytesMessage–一个字节的数据流</li>
</ul>
<h3 id="JMS应用程序接口"><a href="#JMS应用程序接口" class="headerlink" title="JMS应用程序接口"></a>JMS应用程序接口</h3><p>&nbsp;&nbsp;<strong>ConnectionFactory</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;用户用来创建到JMS提供者的连接的被管对象。JMS客户通过可移植的接口访问连接，这样当下层的实现改变时，代码不需要进行修改。 管理员在JNDI名字空间中配置连接工厂，这样，JMS客户才能够查找到它们。根据消息类型的不同，用户将使用队列连接工厂，或者主题连接工厂。</p>
<p>&nbsp;&nbsp;<strong>Connection</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;连接代表了应用程序和消息服务器之间的通信链路。在获得了连接工厂后，就可以创建一个与JMS提供者的连接。根据不同的连接类型，连接允许用户创建会话，以发送和接收队列和主题到目标。</p>
<p>&nbsp;&nbsp;<strong>Destination</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;目标是一个包装了消息目标标识符的被管对象，消息目标是指消息发布和接收的地点，或者是队列，或者是主题。JMS管理员创建这些对象，然后用户通过JNDI发现它们。和连接工厂一样，管理员可以创建两种类型的目标，点对点模型的队列，以及发布者／订阅者模型的主题。</p>
<p>&nbsp;&nbsp;<strong>MessageProducer</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;由会话创建的对象，用于发送消息到目标。用户可以创建某个目标的发送者，也可以创建一个通用的发送者，在发送消息时指定目标。</p>
<p>&nbsp;&nbsp;<strong>MessageConsumer</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;由会话创建的对象，用于接收发送到目标的消息。消费者可以同步地（阻塞模式），或异步（非阻塞）接收队列和主题类型的消息。</p>
<p>&nbsp;&nbsp;<strong>Message</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;是在消费者和生产者之间传送的对象，也就是说从一个应用程序创送到另一个应用程序。一个消息有三个主要部分：</p>
<ul>
<li>消息头（必须）：包含用于识别和为消息寻找路由的操作设置。</li>
<li>一组消息属性（可选）：包含额外的属性，支持其他提供者和用户的兼容。可以创建定制的字段和过滤器（消息选择器）。</li>
<li>一个消息体（可选）：允许用户创建五种类型的消息（文本消息，映射消息，字节消息，流消息和对象消息）。</li>
</ul>
<p>消息接口非常灵活，并提供了许多方式来定制消息的内容。</p>
<p>&nbsp;&nbsp;<strong>Session</strong></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;表示一个单线程的上下文，用于发送和接收消息。由于会话是单线程的，所以消息是连续的，就是说消息是按照发送的顺序一个一个接收的。会话的好处是它支持事务。如果用户选择了事务支持，会话上下文将保存一组消息，直到事务被提交才发送这些消息。在提交事务之前，用户可以使用回滚操作取消这些消息。一个会话允许用户创建消息生产者来发送消息，创建消息消费者来接收消息。</p>
<h3 id="JMS消息发送模式"><a href="#JMS消息发送模式" class="headerlink" title="JMS消息发送模式"></a>JMS消息发送模式</h3><p><img src="http://ww2.sinaimg.cn/mw690/63503acbjw1f67ojyj0g8j20mf0fdwft.jpg" alt=""></p>
<p>&nbsp;&nbsp;在P2P模型下，一个生产者向一个特定的队列发布消息，一个消费者从该队列中读取消息。这里，生产者知道消费者的队列，并直接将消息发送到消费者的队列。这种模式被概括为：只有一个消费者将获得消息。生产者不需要在接收者消费该消息期间处于运行状态，接收者也同样不需要在消息发送时处于运行状态。每一个成功处理的消息都由接收者签收。</p>
<p>&nbsp;&nbsp;publish/subscribe模型支持向一个特定的消息主题发布消息。0或多个订阅者可能对接收来自特定消息主题的消息感兴趣。在这种模型下，发布者和订阅者彼此不知道对方。这种模式好比是匿名公告板。这种模式被概括为：多个消费者可以获得消息.在发布者和订阅者之间存在时间依赖性。发布者需要建立一个订阅（subscription），以便客户能够购订阅。订阅者必须保持持续的活动状态以接收消息，除非订阅者建立了持久的订阅。在那种情况下，在订阅者未连接时发布的消息将在订阅者重新连接时重新发布。</p>
<h3 id="安装ActiveMQ"><a href="#安装ActiveMQ" class="headerlink" title="安装ActiveMQ"></a>安装ActiveMQ</h3><ol>
<li><p>首先到官网 <a href="http://activemq.apache.org/" target="_blank" rel="external">http://activemq.apache.org/</a> 下载ActiveMQ.</p>
</li>
<li><p>因为ActiveMQ是JAVA开发的,所以依赖jdk环境。</p>
</li>
<li><p>解压ActiveMQ。</p>
</li>
<li><p>在ActiveMQ/bin目录中,./activemq start 开启ActiveMQ</p>
</li>
<li><p>在ActiveMQ/bin目录中,./activemq stop 关闭ActiveMQ</p>
</li>
<li><p>访问后台 <a href="http://ip:8161/admin" target="_blank" rel="external">http://ip:8161/admin</a>  ActiveMQ的默认后台端口为8161,Message端口为61616</p>
</li>
</ol>
<h3 id="使用ActiveMQ"><a href="#使用ActiveMQ" class="headerlink" title="使用ActiveMQ"></a>使用ActiveMQ</h3><p>&nbsp;&nbsp;使用ActiveMQ需要先引入ActiveMQ的jar包。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">       &lt;dependency&gt;</div><div class="line">	&lt;groupId&gt;org.apache.activemq&lt;/groupId&gt;</div><div class="line">	&lt;artifactId&gt;activemq-all&lt;/artifactId&gt;</div><div class="line">	&lt;version&gt;5.11.2&lt;/version&gt;</div><div class="line">&lt;/dependency&gt;</div></pre></td></tr></table></figure>
<p>以下示例使用Queue模式,如要使用Topic模式只需要将Destination改成Topic即可。</p>
<h4 id="1-Producer"><a href="#1-Producer" class="headerlink" title="1.Producer"></a>1.Producer</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">   <span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testProducer</span><span class="params">()</span> <span class="keyword">throws</span> JMSException</span>&#123;</div><div class="line">	<span class="comment">// 创建连接工厂</span></div><div class="line">	ConnectionFactory connectionFactory = </div><div class="line">				<span class="keyword">new</span> ActiveMQConnectionFactory(<span class="string">"tcp://192.168.145.137:61616"</span>);</div><div class="line">	<span class="comment">// 声明Connection</span></div><div class="line">	Connection connection = <span class="keyword">null</span>;</div><div class="line">	<span class="comment">// 声明Session</span></div><div class="line">	Session session = <span class="keyword">null</span>;</div><div class="line">	<span class="comment">// 声明Producer</span></div><div class="line">	MessageProducer producer = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">try</span>&#123;</div><div class="line">		<span class="comment">// 从连接工厂中获得连接</span></div><div class="line">		connection = connectionFactory.createConnection();</div><div class="line">		<span class="comment">// 开启连接</span></div><div class="line">		connection.start();</div><div class="line">		<span class="comment">/*</span></div><div class="line">		 * 从连接中获得会话</div><div class="line">		 * 参数1:transacted  boolean型</div><div class="line">		 * 当设置为true时,将忽略参数2,acknowledgment mode被jms服务器设置 SESSION_TRANSACTED。</div><div class="line">		 * 当一个事务被提交时,消息确认就会自动发生。</div><div class="line">		 * 当设置为false时,需要设置参数2</div><div class="line">		 * Session.AUTO_ACKNOWLEDGE为自动确认，当客户成功的从receive方法返回的时候，或者从</div><div class="line">		 * MessageListener.onMessage方法成功返回的时候，会话自动确认客户收到的消息。</div><div class="line">		 * Session.CLIENT_ACKNOWLEDGE 为客户端确认。客户端接收到消息后，必须调用javax.jms.Message的</div><div class="line">		 * acknowledge方法。jms服务器才会删除消息。（默认是批量确认）</div><div class="line">		 */</div><div class="line">		session = connection.createSession(<span class="keyword">false</span>,Session.AUTO_ACKNOWLEDGE);</div><div class="line">		<span class="comment">// 创建一个Destination目的地 Queue或者Topic</span></div><div class="line">		Queue queue = session.createQueue(<span class="string">"testMessage"</span>);</div><div class="line">		<span class="comment">// 创建一个Producer生产者</span></div><div class="line">		producer = session.createProducer(queue);</div><div class="line">		<span class="comment">// 创建message</span></div><div class="line">		ActiveMQTextMessage textMessage = <span class="keyword">new</span> ActiveMQTextMessage();</div><div class="line">		textMessage.setText(<span class="string">"test"</span>);</div><div class="line">		<span class="comment">// 发送message</span></div><div class="line">		producer.send(textMessage);</div><div class="line">	&#125;<span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">		e.printStackTrace();</div><div class="line">	&#125;<span class="keyword">finally</span>&#123;</div><div class="line">		<span class="comment">// 回收资源</span></div><div class="line">		producer.close();</div><div class="line">		session.close();</div><div class="line">		connection.close();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-Consumer"><a href="#2-Consumer" class="headerlink" title="2.Consumer"></a>2.Consumer</h4><p>&nbsp;&nbsp;消费者有两种消费方式:</p>
<ol>
<li><p>同步消费。通过调用消费者的receive方法从目的地中显式提取消息。receive方法可以一直阻塞到消息到达。</p>
</li>
<li><p>异步消费。客户可以为消费者注册一个消息监听器，以定义在消息到达时所采取的动作。<br>  实现MessageListener接口，在MessageListener（）方法中实现消息的处理逻辑。</p>
</li>
</ol>
<p>同步消费</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSyncConsumer</span><span class="params">()</span> <span class="keyword">throws</span> JMSException</span>&#123;</div><div class="line">	<span class="comment">// 创建连接工厂</span></div><div class="line">	ConnectionFactory connectionFactory = </div><div class="line">					<span class="keyword">new</span> ActiveMQConnectionFactory(<span class="string">"tcp://192.168.145.137:61616"</span>);</div><div class="line">	Connection connection = <span class="keyword">null</span>;</div><div class="line">	Session session = <span class="keyword">null</span>;</div><div class="line">	MessageConsumer consumer = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">try</span>&#123;</div><div class="line">		<span class="comment">// 获得连接</span></div><div class="line">		connection = connectionFactory.createConnection();</div><div class="line">		<span class="comment">// 开启连接</span></div><div class="line">		connection.start();</div><div class="line">		<span class="comment">// 获得Session</span></div><div class="line">		session = connection.createSession(<span class="keyword">false</span>,Session.AUTO_ACKNOWLEDGE);</div><div class="line">		<span class="comment">// 创建一个目的地</span></div><div class="line">		Queue queue = session.createQueue(<span class="string">"testSynchronization"</span>);</div><div class="line">		<span class="comment">// 创建消费者</span></div><div class="line">		consumer = session.createConsumer(queue);</div><div class="line">		<span class="comment">// 使用receive同步消费</span></div><div class="line">		<span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</div><div class="line">			<span class="comment">// 设置接收信息的时间,单位为毫秒</span></div><div class="line">			Message message = consumer.receive(<span class="number">10000</span>);</div><div class="line">			<span class="keyword">if</span>(message != <span class="keyword">null</span>)&#123;</div><div class="line">				System.out.println(message);</div><div class="line">			&#125;<span class="keyword">else</span>&#123;</div><div class="line">				<span class="comment">// 超时,结束循环</span></div><div class="line">				<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;<span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">		e.printStackTrace();</div><div class="line">	&#125;<span class="keyword">finally</span>&#123;</div><div class="line">		<span class="comment">// 回收资源</span></div><div class="line">		consumer.close();</div><div class="line">		session.close();</div><div class="line">		connection.close();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>异步消费</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">   <span class="meta">@Test</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testAsyncConsumer</span><span class="params">()</span> <span class="keyword">throws</span> JMSException</span>&#123;</div><div class="line">	<span class="comment">// 创建连接工厂</span></div><div class="line">	ConnectionFactory connectionFactory = </div><div class="line">				<span class="keyword">new</span> ActiveMQConnectionFactory(<span class="string">"tcp://192.168.145.137:61616"</span>);</div><div class="line">	Connection connection = <span class="keyword">null</span>;</div><div class="line">	Session session = <span class="keyword">null</span>;</div><div class="line">	MessageConsumer consumer = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">try</span>&#123;</div><div class="line">		<span class="comment">// 获得连接</span></div><div class="line">		connection = connectionFactory.createConnection();</div><div class="line">		<span class="comment">// 开启连接</span></div><div class="line">		connection.start();</div><div class="line">		<span class="comment">// 获得Session</span></div><div class="line">		session = connection.createSession(<span class="keyword">false</span>,Session.AUTO_ACKNOWLEDGE);</div><div class="line">		<span class="comment">// 设置目的地</span></div><div class="line">		Queue queue = session.createQueue(<span class="string">"testAsynchronization"</span>);</div><div class="line">		<span class="comment">// 创建Consumer</span></div><div class="line">		consumer = session.createConsumer(queue);</div><div class="line">		<span class="comment">// 异步消费</span></div><div class="line">		session.setMessageListener(<span class="keyword">new</span> MessageListener() &#123;</div><div class="line">			</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message)</span> </span>&#123;</div><div class="line">				<span class="keyword">if</span>(message <span class="keyword">instanceof</span> TextMessage)&#123;</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						String text = ((TextMessage) message).getText();</div><div class="line">						System.out.println(text);</div><div class="line">					&#125; <span class="keyword">catch</span> (JMSException e) &#123;</div><div class="line">						e.printStackTrace();</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		System.in.read();</div><div class="line">	&#125;<span class="keyword">catch</span>(Exception e)&#123;</div><div class="line">		e.printStackTrace();</div><div class="line">	&#125;<span class="keyword">finally</span>&#123;</div><div class="line">		<span class="comment">// 回收资源</span></div><div class="line">		consumer.close();</div><div class="line">		session.close();</div><div class="line">		connection.close();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="整合Spring"><a href="#整合Spring" class="headerlink" title="整合Spring"></a>整合Spring</h3><h4 id="1-配置ConnectionFactory"><a href="#1-配置ConnectionFactory" class="headerlink" title="1.配置ConnectionFactory"></a>1.配置ConnectionFactory</h4><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line">&lt;beans xmlns="http://www.springframework.org/schema/beans"</div><div class="line">	xmlns:context="http://www.springframework.org/schema/context" xmlns:p="http://www.springframework.org/schema/p"</div><div class="line">	xmlns:aop="http://www.springframework.org/schema/aop" xmlns:tx="http://www.springframework.org/schema/tx"</div><div class="line">	xmlns:jms="http://www.springframework.org/schema/jms" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"</div><div class="line">	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.0.xsd</div><div class="line">	http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.0.xsd</div><div class="line">	http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-4.0.xsd </div><div class="line">	http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-4.0.xsd</div><div class="line">	http://www.springframework.org/schema/jms http://www.springframework.org/schema/jms/spring-jms-4.0.xsd</div><div class="line">	http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-4.0.xsd"&gt;</div><div class="line"></div><div class="line"></div><div class="line">	&lt;!-- ActiveMQ提供的ConnectionFactory --&gt;</div><div class="line">	&lt;bean id="targetConnectionFactory" class="org.apache.activemq.ActiveMQConnectionFactory"&gt;</div><div class="line">		&lt;property name="brokerURL" value="tcp://192.168.145.137:61616" /&gt;</div><div class="line">	&lt;/bean&gt;</div><div class="line">	&lt;!-- Spring的ConnectionFactory需要注入ActiveMQ的ConnectionFactory --&gt;</div><div class="line">	&lt;bean id="connectionFactory"</div><div class="line">		class="org.springframework.jms.connection.SingleConnectionFactory"&gt;</div><div class="line">		&lt;!-- 目标ConnectionFactory对应真实的可以产生JMS Connection的ConnectionFactory --&gt;</div><div class="line">		&lt;property name="targetConnectionFactory" ref="targetConnectionFactory" /&gt;</div><div class="line">	&lt;/bean&gt;</div><div class="line">&lt;/beans&gt;</div></pre></td></tr></table></figure>
<h4 id="2-配置生产者"><a href="#2-配置生产者" class="headerlink" title="2.配置生产者"></a>2.配置生产者</h4><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">   &lt;!-- 配置生产者 --&gt;</div><div class="line">&lt;!-- Spring提供的JMS工具类，它可以进行消息发送、接收等 --&gt;</div><div class="line">&lt;bean id="jmsTemplate" class="org.springframework.jms.core.JmsTemplate"&gt;</div><div class="line">	&lt;!-- 注入Spring的连接工厂 --&gt;</div><div class="line">	&lt;property name="connectionFactory" ref="connectionFactory" /&gt;</div><div class="line">&lt;/bean&gt;</div><div class="line">&lt;!--P2P模式的Destination --&gt;</div><div class="line">&lt;bean id="queueDestination" class="org.apache.activemq.command.ActiveMQQueue"&gt;</div><div class="line">	&lt;constructor-arg&gt;</div><div class="line">		&lt;value&gt;queue&lt;/value&gt;</div><div class="line">	&lt;/constructor-arg&gt;</div><div class="line">&lt;/bean&gt;</div><div class="line">&lt;!-- publish/subscribe模式的Destination --&gt;</div><div class="line">&lt;bean id="topicDestination" class="org.apache.activemq.command.ActiveMQTopic"&gt;</div><div class="line">	&lt;constructor-arg value="topic" /&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
<h4 id="3-发送消息"><a href="#3-发送消息" class="headerlink" title="3.发送消息"></a>3.发送消息</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSend</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="comment">// 读取Spring配置文件</span></div><div class="line">		ApplicationContext applicationContext = </div><div class="line">					<span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"applicationContext.xml"</span>);</div><div class="line">		<span class="comment">// 获得JmsTemplate</span></div><div class="line">		JmsTemplate jmsTemplate = applicationContext.getBean(JmsTemplate.class);</div><div class="line">		<span class="comment">// 获得Destination</span></div><div class="line">		ActiveMQQueue queue = applicationContext.getBean(ActiveMQQueue.class);</div><div class="line">		<span class="comment">// 发送消息</span></div><div class="line">		jmsTemplate.send(queue, <span class="keyword">new</span> MessageCreator() &#123;</div><div class="line">			</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Message <span class="title">createMessage</span><span class="params">(Session session)</span> <span class="keyword">throws</span> JMSException </span>&#123;</div><div class="line">				<span class="keyword">return</span> session.createTextMessage(<span class="string">"send-spring"</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<h4 id="4-配置消费者"><a href="#4-配置消费者" class="headerlink" title="4.配置消费者"></a>4.配置消费者</h4><p>&nbsp;&nbsp;Spring通过MessageListenerContainer接收信息,并把接收到的信息分发给MessageListener进行处理。每个消费者对应每个目的地都需要有对应的MessageListenerContainer。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">&lt;!-- ActiveMQ提供的ConnectionFactory --&gt;</div><div class="line">&lt;bean id="targetConnectionFactory" class="org.apache.activemq.ActiveMQConnectionFactory"&gt;</div><div class="line">	&lt;property name="brokerURL" value="tcp://192.168.145.137:61616" /&gt;</div><div class="line">&lt;/bean&gt;</div><div class="line">&lt;!-- Spring的ConnectionFactory需要注入ActiveMQ的ConnectionFactory --&gt;</div><div class="line">&lt;bean id="connectionFactory"</div><div class="line">	class="org.springframework.jms.connection.SingleConnectionFactory"&gt;</div><div class="line">	&lt;!-- 目标ConnectionFactory对应真实的可以产生JMS Connection的ConnectionFactory --&gt;</div><div class="line">	&lt;property name="targetConnectionFactory" ref="targetConnectionFactory" /&gt;</div><div class="line">&lt;/bean&gt;</div><div class="line">   &lt;!-- 配置生产者 --&gt;</div><div class="line">&lt;!-- Spring提供的JMS工具类，它可以进行消息发送、接收等 --&gt;</div><div class="line">&lt;bean id="jmsTemplate" class="org.springframework.jms.core.JmsTemplate"&gt;</div><div class="line">	&lt;!-- 注入Spring的连接工厂 --&gt;</div><div class="line">	&lt;property name="connectionFactory" ref="connectionFactory" /&gt;</div><div class="line">&lt;/bean&gt;</div><div class="line">&lt;!--P2P模式的Destination --&gt;</div><div class="line">&lt;bean id="queueDestination" class="org.apache.activemq.command.ActiveMQQueue"&gt;</div><div class="line">	&lt;constructor-arg&gt;</div><div class="line">		&lt;value&gt;queue&lt;/value&gt;</div><div class="line">	&lt;/constructor-arg&gt;</div><div class="line">&lt;/bean&gt;</div><div class="line">&lt;!-- publish/subscribe模式的Destination --&gt;</div><div class="line">&lt;bean id="topicDestination" class="org.apache.activemq.command.ActiveMQTopic"&gt;</div><div class="line">	&lt;constructor-arg value="topic" /&gt;</div><div class="line">&lt;/bean&gt;</div><div class="line">&lt;!-- 配置监听器 --&gt;</div><div class="line">&lt;bean id="myMessageListener" class="com.activemq.MyMessageListener" /&gt;</div><div class="line">&lt;!-- 消息监听容器 --&gt;</div><div class="line">&lt;bean id="jmsContainer"</div><div class="line">	class="org.springframework.jms.listener.DefaultMessageListenerContainer"&gt;</div><div class="line">	&lt;property name="connectionFactory" ref="connectionFactory" /&gt;</div><div class="line">	&lt;property name="destination" ref="queueDestination" /&gt;</div><div class="line">	&lt;property name="messageListener" ref="myMessageListener" /&gt;</div><div class="line">&lt;/bean&gt;</div></pre></td></tr></table></figure>
<p>监听器需要实现MessageListener接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMessageListener</span> <span class="keyword">implements</span> <span class="title">MessageListener</span> </span>&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Message message)</span> </span>&#123;</div><div class="line">		System.out.println(message);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Exception"><a href="#Exception" class="headerlink" title="Exception"></a>Exception</h3><p>&nbsp;&nbsp;启动ActiveMQ时,如果发生java.net.UnknownHostException异常。<br>解决方法:<br>修改 /etc/hosts 文件 添加一行 192.168.1.1(主机IP) 主机名.localdomain 主机名<br>例: 192.168.145.137 ActiveMQ.localdomain ActiveMQ</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://sylvanassun.github.io/2016/07/03/2016-07-03-activemq/" data-id="cj4z0jkb5000kuomjtp95cfsb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ActiveMQ/">ActiveMQ</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/后端开发/">后端开发</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/07/09/2016-07-09-MyCat/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          MyCat快速入门
        
      </div>
    </a>
  
  
    <a href="/2016/06/30/2016-06-30-solrcloud/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">SolrCloud初体验</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/2017/">2017</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ActiveMQ/">ActiveMQ</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hadoop/">Hadoop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HashMap/">HashMap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM/">JVM</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Lucene/">Lucene</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyBatis/">MyBatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyCat/">MyCat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Nginx/">Nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringMVC/">SpringMVC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/solr/">solr</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/全文检索引擎/">全文检索引擎</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/后端开发/">后端开发</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多线程/">多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/大数据/">大数据</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据库/">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据结构/">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/符号表/">符号表</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/算法/">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/编程思想/">编程思想</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/2017/" style="font-size: 17.78px;">2017</a> <a href="/tags/ActiveMQ/" style="font-size: 10px;">ActiveMQ</a> <a href="/tags/Hadoop/" style="font-size: 14.44px;">Hadoop</a> <a href="/tags/HashMap/" style="font-size: 10px;">HashMap</a> <a href="/tags/JVM/" style="font-size: 12.22px;">JVM</a> <a href="/tags/Java/" style="font-size: 18.89px;">Java</a> <a href="/tags/Lucene/" style="font-size: 10px;">Lucene</a> <a href="/tags/MyBatis/" style="font-size: 12.22px;">MyBatis</a> <a href="/tags/MyCat/" style="font-size: 10px;">MyCat</a> <a href="/tags/Nginx/" style="font-size: 10px;">Nginx</a> <a href="/tags/Spring/" style="font-size: 15.56px;">Spring</a> <a href="/tags/SpringMVC/" style="font-size: 11.11px;">SpringMVC</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/solr/" style="font-size: 10px;">solr</a> <a href="/tags/全文检索引擎/" style="font-size: 11.11px;">全文检索引擎</a> <a href="/tags/后端开发/" style="font-size: 20px;">后端开发</a> <a href="/tags/多线程/" style="font-size: 10px;">多线程</a> <a href="/tags/大数据/" style="font-size: 14.44px;">大数据</a> <a href="/tags/数据库/" style="font-size: 10px;">数据库</a> <a href="/tags/数据结构/" style="font-size: 16.67px;">数据结构</a> <a href="/tags/符号表/" style="font-size: 13.33px;">符号表</a> <a href="/tags/算法/" style="font-size: 13.33px;">算法</a> <a href="/tags/编程思想/" style="font-size: 10px;">编程思想</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/06/27/2017-06-27-DynamicProgramming/">什么是动态规划?</a>
          </li>
        
          <li>
            <a href="/2017/06/16/2017-06-16-RedBlackTree/">红黑树那点事儿</a>
          </li>
        
          <li>
            <a href="/2017/06/14/2017-06-14-sort_algorithms_qucikSort/">深入浅出排序算法(3)-快速排序</a>
          </li>
        
          <li>
            <a href="/2017/06/12/2017-06-12-sort_algorithmes_mergeSort/">深入浅出排序算法(2)-归并排序</a>
          </li>
        
          <li>
            <a href="/2017/06/09/2017-06-09-sort_algorithms_heapSort/">深入浅出排序算法(1)-堆排序</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 SylvanasSun<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>